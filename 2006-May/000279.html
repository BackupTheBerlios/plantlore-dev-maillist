<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plantlore-dev] r242 - in trunk/src/net/sf/plantlore: client client/authors client/export client/history client/imports client/login client/metadata client/publication client/publications client/user common common/exception middleware server
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plantlore-dev/2006-May/index.html" >
   <LINK REL="made" HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r242%20-%20in%20trunk/src/net/sf/plantlore%3A%20client%20client/authors%20client/export%20client/history%20client/imports%20client/login%20client/metadata%20client/publication%20client/publications%20client/user%20common%20common/exception%20middleware%20server&In-Reply-To=%3C200605082159.k48LxNrc007668%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000280.html">
   <LINK REL="Next"  HREF="000282.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plantlore-dev] r242 - in trunk/src/net/sf/plantlore: client client/authors client/export client/history client/imports client/login client/metadata client/publication client/publications client/user common common/exception middleware server</H1>
    <B>kovo at berlios.de</B> 
    <A HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r242%20-%20in%20trunk/src/net/sf/plantlore%3A%20client%20client/authors%20client/export%20client/history%20client/imports%20client/login%20client/metadata%20client/publication%20client/publications%20client/user%20common%20common/exception%20middleware%20server&In-Reply-To=%3C200605082159.k48LxNrc007668%40sheep.berlios.de%3E"
       TITLE="[Plantlore-dev] r242 - in trunk/src/net/sf/plantlore: client client/authors client/export client/history client/imports client/login client/metadata client/publication client/publications client/user common common/exception middleware server">kovo at berlios.de
       </A><BR>
    <I>Mon May  8 23:59:23 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000280.html">[Plantlore-dev] r241 - trunk/src/net/sf/plantlore/client
</A></li>
        <LI>Next message: <A HREF="000282.html">[Plantlore-dev] r243 - in trunk: analysis/database src/net/sf/plantlore/common/record src/net/sf/plantlore/config/hibernate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#279">[ date ]</a>
              <a href="thread.html#279">[ thread ]</a>
              <a href="subject.html#279">[ subject ]</a>
              <a href="author.html#279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: kovo
Date: 2006-05-08 23:59:19 +0200 (Mon, 08 May 2006)
New Revision: 242

Removed:
   trunk/src/net/sf/plantlore/server/DBLayerException.java
Modified:
   trunk/src/net/sf/plantlore/client/AddEdit.java
   trunk/src/net/sf/plantlore/client/AppCore.java
   trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
   trunk/src/net/sf/plantlore/client/OverviewTableModel.java
   trunk/src/net/sf/plantlore/client/authors/AuthorManager.java
   trunk/src/net/sf/plantlore/client/export/DefaultDirector.java
   trunk/src/net/sf/plantlore/client/export/ExportMng.java
   trunk/src/net/sf/plantlore/client/history/History.java
   trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java
   trunk/src/net/sf/plantlore/client/login/AuthCtrl.java
   trunk/src/net/sf/plantlore/client/login/Login.java
   trunk/src/net/sf/plantlore/client/metadata/MetadataManager.java
   trunk/src/net/sf/plantlore/client/publication/PublicationManager.java
   trunk/src/net/sf/plantlore/client/publications/PublicationManager.java
   trunk/src/net/sf/plantlore/client/user/UserManager.java
   trunk/src/net/sf/plantlore/common/DBLayerUtils.java
   trunk/src/net/sf/plantlore/common/exception/DBLayerException.java
   trunk/src/net/sf/plantlore/middleware/DBLayer.java
   trunk/src/net/sf/plantlore/middleware/DBLayerFactory.java
   trunk/src/net/sf/plantlore/middleware/RMIDBLayerFactory.java
   trunk/src/net/sf/plantlore/middleware/RemoteDBLayerFactory.java
   trunk/src/net/sf/plantlore/server/HibernateDBLayer.java
   trunk/src/net/sf/plantlore/server/RMIRemoteDBLayerFactory.java
Log:
Move DBLayerException to common.exception package. Update import in all of the source files.

Modified: trunk/src/net/sf/plantlore/client/AddEdit.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AddEdit.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/AddEdit.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -36,7 +36,7 @@
 import net.sf.plantlore.common.record.Village;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.apache.log4j.Logger;
 
 /**

Modified: trunk/src/net/sf/plantlore/client/AppCore.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCore.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/AppCore.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -27,7 +27,7 @@
 // Imports for temporary db access
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.server.HibernateDBLayer;
 import org.apache.log4j.Logger;
 

Modified: trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -46,7 +46,7 @@
 import net.sf.plantlore.common.record.Author;
 import net.sf.plantlore.common.record.AuthorOccurrence;
 import net.sf.plantlore.common.record.Occurrence;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.common.record.Plant;
 import net.sf.plantlore.client.authors.AuthorManager;
 import net.sf.plantlore.client.authors.AuthorManagerCtrl;

Modified: trunk/src/net/sf/plantlore/client/OverviewTableModel.java
===================================================================
--- trunk/src/net/sf/plantlore/client/OverviewTableModel.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/OverviewTableModel.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -20,7 +20,7 @@
 import net.sf.plantlore.common.record.Plant;
 import net.sf.plantlore.l10n.L10n;
 import net.sf.plantlore.middleware.DBLayer;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.middleware.SelectQuery;
 import org.apache.log4j.Logger;
 

Modified: trunk/src/net/sf/plantlore/client/authors/AuthorManager.java
===================================================================
--- trunk/src/net/sf/plantlore/client/authors/AuthorManager.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/authors/AuthorManager.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -13,11 +13,12 @@
 import net.sf.plantlore.common.PlantloreConstants;
 import net.sf.plantlore.common.record.Author;
 import net.sf.plantlore.common.record.AuthorOccurrence;
+import net.sf.plantlore.common.record.HistoryRecord;
 import net.sf.plantlore.common.record.Occurrence;
 import net.sf.plantlore.l10n.L10n;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.common.SwingWorker;
 import org.apache.log4j.Logger;
 
@@ -116,7 +117,7 @@
                 // The operation is not finished yet
                 done = false;
                 // Create Author object for author we want to add
-                Author author = new Author();
+/*                Author author = new Author();
                 author.setWholeName(name);
                 author.setOrganization(organization);
                 author.setRole(role);
@@ -143,6 +144,31 @@
                 if (isResultAvailable()) {
                     searchAuthor();
                 }
+*/
+                int rowId = 0;                
+                try {
+                    database.conditionDelete(HistoryRecord.class, HistoryRecord.ID, &quot;&gt;&quot;, 10);
+                    
+/*                    SelectQuery query = database.createQuery(Occurrence.class);
+                    System.out.println(&quot;Created SelectQuery&quot;);
+                    query.addRestriction(PlantloreConstants.RESTR_EQ, Occurrence.ID, null, 8, null);
+                    System.out.println(&quot;Going to execute select query&quot;);
+                    int id = database.executeQuery(query);
+                    System.out.println(&quot;Select query executed&quot;);
+                    Object[] res = database.more(id, 0, 0);
+                    Object[] resres = (Object[])res[0];
+                    Occurrence occ = (Occurrence)resres[0];
+                    occ.getPublication().setCollectionName(&quot;Nove collection name&quot;);
+                    database.executeUpdate(occ);
+ */
+                } catch (DBLayerException e2) {
+                    e2.printStackTrace();
+                } catch (RemoteException e3) {
+                    e3.printStackTrace();
+                }
+
+               
+                
                 done = true;
                 return rowId;
             }
@@ -272,6 +298,16 @@
                     } else {
                         query.addOrder(PlantloreConstants.DIRECT_DESC, field);
                     }
+                    Object[] args = new Object[8];
+                    args[0] = PlantloreConstants.RESTR_EQ_PROPERTY;
+                    args[1] = Author.WHOLENAME;
+                    args[2] = Author.EMAIL;
+                    args[3] = null;                    
+                    args[4] = PlantloreConstants.RESTR_EQ_PROPERTY;
+                    args[5] = Author.WHOLENAME;
+                    args[6] = Author.ORGANIZATION;
+                    args[7] = null;
+                    query.addOrRestriction(args);
                     int resultId = 0;
                     try {
                         // Execute query
@@ -293,6 +329,9 @@
                 } catch (RemoteException e) {
                     System.err.println(&quot;Kdykoliv se pracuje s DBLayer nebo SelectQuery, musite hendlovat RemoteException&quot;);
                     return null;
+                } catch (DBLayerException e) {
+                    System.err.println(&quot;Kdykoliv se pracuje s DBLayer nebo SelectQuery, musite hendlovat RemoteException&quot;);
+                    return null;
                 }
             }
         };

Modified: trunk/src/net/sf/plantlore/client/export/DefaultDirector.java
===================================================================
--- trunk/src/net/sf/plantlore/client/export/DefaultDirector.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/export/DefaultDirector.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -10,7 +10,7 @@
 import net.sf.plantlore.common.record.*;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 import org.apache.log4j.Logger;
 

Modified: trunk/src/net/sf/plantlore/client/export/ExportMng.java
===================================================================
--- trunk/src/net/sf/plantlore/client/export/ExportMng.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/export/ExportMng.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -15,7 +15,7 @@
 import net.sf.plantlore.l10n.L10n;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 import org.apache.log4j.Logger;
 

Modified: trunk/src/net/sf/plantlore/client/history/History.java
===================================================================
--- trunk/src/net/sf/plantlore/client/history/History.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/history/History.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -34,7 +34,7 @@
 import net.sf.plantlore.common.record.Village;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.apache.log4j.Logger;
 
 /**
@@ -162,8 +162,10 @@
        	    query = database.createQuery(Occurrence.class);
        	    query.addRestriction(PlantloreConstants.RESTR_EQ, Occurrence.ID, null, idOcc, null);
        } catch(RemoteException e) {
-       	    System.err.println(&quot;RemoteException - History(), crateQuery&quot;);       	  
-       }      
+       	    System.err.println(&quot;RemoteException - History(), createQuery&quot;);       	  
+       } catch(DBLayerException e) {
+       	    System.err.println(&quot;DBLayerException - History(), createQuery&quot;);       	  
+       }
              
        
        int resultId = 0;
@@ -197,8 +199,12 @@
        setNamePlant(namePlant);
        setNameAuthor(nameAuthor);
        setLocation(location);
-       
-       database.closeQuery(query);
+       try {
+            database.closeQuery(query);
+       } catch(RemoteException e) {
+       	    System.err.println(&quot;RemoteException&quot;);
+       }
+
 /*
  * konec casti kodu, ktera bude dobudoucna nahrazena.
  * 
@@ -236,21 +242,23 @@
        	    query.addRestriction(PlantloreConstants.RESTR_EQ, HistoryChange.OPERATION, null, HistoryChange.HISTORYCHANGE_INSERT, null);
        } catch(RemoteException e) {
        	    System.err.println(&quot;RemoteException- searchInsertInfo(), createQuery&quot;);       	  
+       } catch(DBLayerException e) {
+       	    System.err.println(&quot;DBLayerException - searchInsertInfo(), createQuery&quot;);
        }            
-              
+       
        int resultIdInsert = 0;
        try {
            // Execute query                    
            resultIdInsert = database.executeQuery(query); 
            // Save &quot;insert&quot; history data
            setInsertResult(resultIdInsert);
+           database.closeQuery(query);           
        } catch (DBLayerException e) {
            // Log and set an error                   
            logger.error(&quot;Searching history data with condition 'operation = insert' failed. Unable to execute search query.&quot;);          
        } catch (RemoteException e) {		 
     	   System.err.println(&quot;RemoteException- searchInsertInfo(), executeQuery&quot;);
-	    }         
-       database.closeQuery(query);
+       }
     }
     
     
@@ -266,18 +274,19 @@
 
     	//  Select data from tHistory table
         try {
-			query = database.createQuery(HistoryRecord.class);
-			// Create aliases for table tHistoryChange.      
+		query = database.createQuery(HistoryRecord.class);
+		// Create aliases for table tHistoryChange.      
 	        query.createAlias(&quot;historyChange&quot;, &quot;hc&quot;);        
 	        // Add restriction to COPERATION column of tJistoryChange table
 	        query.addRestriction(PlantloreConstants.RESTR_EQ, &quot;hc.operation&quot;, null, HistoryChange.HISTORYCHANGE_EDIT, null);        
 	        query.addRestriction(PlantloreConstants.RESTR_EQ, &quot;hc.occurrence&quot;, null, occurrence, null);    	
 	        query.addOrder(PlantloreConstants.DIRECT_DESC, &quot;hc.when&quot;);
-		} catch (RemoteException e) {
-			System.err.println(&quot;RemoteException- searchEditHistory(), createQuery&quot;);
-		}
-                
-    	
+	} catch (RemoteException e) {
+		System.err.println(&quot;RemoteException - searchEditHistory(), createQuery&quot;);
+	} catch (DBLayerException e) {
+		System.err.println(&quot;DBLayerException - searchEditHistory(), createQuery&quot;);
+	}                
+
         int resultIdEdit = 0;
         try {
             // Execute query                    
@@ -338,10 +347,12 @@
 			query.createAlias(&quot;historyChange&quot;, &quot;hc&quot;);
 			// sort by date/time
 			query.addOrder(PlantloreConstants.DIRECT_DESC, &quot;hc.when&quot;);
-		} catch (RemoteException e) {
-                System.err.println(&quot;RemoteException- searchWholeHistoryData(), createQuery&quot;);
+	} catch (RemoteException e) {
+                System.err.println(&quot;RemoteException - searchWholeHistoryData(), createQuery&quot;);
+	} catch (DBLayerException e) {
+                System.err.println(&quot;DBLayerException - searchWholeHistoryData(), createQuery&quot;);
         }
-                
+
     	
         int resultId = 0;
         try {
@@ -1033,85 +1044,46 @@
      * @param id
      * @return
      */
-    public Object[] searchObject(String typeObject, int id) { 
-      
+    public Object[] searchObject(String typeObject, int id) {       
     	SelectQuery query = null;
-    	if (typeObject.equals(&quot;Occurrence&quot;)){
-            try {
-            	query = database.createQuery(Occurrence.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Occurrence.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - Occurrence, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;AuthorOccurrence&quot;)){
-            try {
-            	query = database.createQuery(AuthorOccurrence.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, AuthorOccurrence.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - AuthorOccurrence, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;Habitat&quot;)){
-            try {
-            	query = database.createQuery(Habitat.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Habitat.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - Habitat, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;Plant&quot;)){
-            try {
-            	query = database.createQuery(Plant.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Plant.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - Plant, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;Author&quot;)){
-            try {
-            	query = database.createQuery(Author.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Author.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - Author, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;Publication&quot;)){
-            try {
-            	query = database.createQuery(Publication.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Publication.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject() - Publication, createQuery&quot;);       	  
-            }            
-            
-    	} else if (typeObject.equals(&quot;Village&quot;)){
-            try {
-            	query = database.createQuery(Village.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Village.ID, null, id, null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject()- Village, createQuery&quot;);       	  
-            }            
-            
-    	}  else if  (typeObject.equals(&quot;Territory&quot;)){
-            try {
-            	query = database.createQuery(Territory.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Territory.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject()- Territory, createQuery&quot;);       	  
-            }            
-             
-    	} else if (typeObject.equals(&quot;Phytochorion&quot;)){
-            try {
-            	query = database.createQuery(Phytochorion.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, Phytochorion.ID, null, id , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, searchObject()- Phytochorion, createQuery&quot;);       	  
-            }            
-            
-    	} else {
-    		logger.error(&quot;SearchObject() - Incorrect type of object.&quot;);
-    	}
-                        
+
+        try {
+            if (typeObject.equals(&quot;Occurrence&quot;)){
+                query = database.createQuery(Occurrence.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Occurrence.ID, null, id , null);
+            } else if (typeObject.equals(&quot;AuthorOccurrence&quot;)){
+                query = database.createQuery(AuthorOccurrence.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, AuthorOccurrence.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Habitat&quot;)){
+                query = database.createQuery(Habitat.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Habitat.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Plant&quot;)){
+                query = database.createQuery(Plant.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Plant.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Author&quot;)){
+                query = database.createQuery(Author.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Author.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Publication&quot;)){
+                query = database.createQuery(Publication.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Publication.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Village&quot;)){
+                query = database.createQuery(Village.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Village.ID, null, id, null);
+            }  else if  (typeObject.equals(&quot;Territory&quot;)){
+                query = database.createQuery(Territory.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Territory.ID, null, id , null);
+            } else if (typeObject.equals(&quot;Phytochorion&quot;)){
+                query = database.createQuery(Phytochorion.class);
+                query.addRestriction(PlantloreConstants.RESTR_EQ, Phytochorion.ID, null, id , null);
+            } else {
+                logger.error(&quot;SearchObject() - Incorrect type of object.&quot;);
+            }
+        } catch(RemoteException e) {
+            System.err.println(&quot;RemoteException, searchObject() - &quot;+typeObject+&quot;, createQuery&quot;);
+        } catch(DBLayerException e) {
+            System.err.println(&quot;DBLayerException, searchObject() - &quot;+typeObject+&quot;, createQuery&quot;);
+        }
+        
         int resultId = 0;
         try {                   
             resultId = database.executeQuery(query);        
@@ -1129,14 +1101,16 @@
             } catch(RemoteException e) {            	
                 logger.debug(&quot;RemoteException- searchObject, more&quot;);            	
             }   
-        	object = (Object[])objects[0];           
+            object = (Object[])objects[0];           
+            //close session
+            database.closeQuery(query);            
        } catch (DBLayerException e) {
            // Log and set error in case of an exception
            logger.error(&quot;Processing search &quot; +typeObject+ &quot; results failed: &quot;+e.toString());            
-       }   
-       //close session
-       database.closeQuery(query);
-       
+       } catch (RemoteException e) {
+           // Log and set error in case of an exception
+           logger.error(&quot;Processing search &quot; +typeObject+ &quot; results failed: &quot;+e.toString());            
+       }       
        return object; 	       	          	   
            	        
     }
@@ -1147,23 +1121,17 @@
     public String getAllAuthors(Occurrence occurrence) {
         String allAuthor = &quot;&quot;;
         SelectQuery query = null;
+        int resultId = 0;
         
         try {
-            	query = database.createQuery(AuthorOccurrence.class);
-            	query.addRestriction(PlantloreConstants.RESTR_EQ, AuthorOccurrence.OCCURRENCE, null, occurrence , null);
-            } catch(RemoteException e) {
-            	    System.err.println(&quot;RemoteException, getAllAuthors() - AuthorOccurrence, createQuery&quot;);       	  
-            }   
-        int resultId = 0;
-        try {
-                             
-            resultId = database.executeQuery(query);        
-        } catch (RemoteException ex) {
-            ex.printStackTrace();
-        } catch (DBLayerException ex) {
-            ex.printStackTrace();
-        }        
-       
+            query = database.createQuery(AuthorOccurrence.class);
+            query.addRestriction(PlantloreConstants.RESTR_EQ, AuthorOccurrence.OCCURRENCE, null, occurrence , null);
+            resultId = database.executeQuery(query);
+        } catch(RemoteException e) {
+            System.err.println(&quot;RemoteException, getAllAuthors() - AuthorOccurrence, createQuery&quot;);
+        } catch(DBLayerException e) {
+            System.err.println(&quot;RemoteException, getAllAuthors() - AuthorOccurrence, createQuery&quot;);
+        }
        Object[] objects = null;       
        try {
             objects = database.more(resultId, 0, 0);  
@@ -1183,8 +1151,12 @@
             allAuthor = allAuthor + role + &quot;: &quot; + author + &quot;\n&quot;;
         }           
        //close session
-       database.closeQuery(query);
-       
+        try {
+            database.closeQuery(query);
+        } catch(RemoteException e) {
+            System.err.println(&quot;RemoteException, getAllAuthors() - AuthorOccurrence, createQuery&quot;);
+        }
+        
        return allAuthor;     	    
     }
     
@@ -1272,8 +1244,10 @@
                 // Add restriction to cChangeId column 
                 query.addRestriction(PlantloreConstants.RESTR_EQ, &quot;hc.id&quot;, null, id , null);
         } catch(RemoteException e) {
-        	System.err.println(&quot;RemoteException- searchHistoryChangeId(), createQuery&quot;);       	  
-        }        
+        	System.err.println(&quot;RemoteException - searchHistoryChangeId(), createQuery&quot;);       	  
+        } catch(DBLayerException e) {
+        	System.err.println(&quot;DBLayerException - searchHistoryChangeId(), createQuery&quot;);       	  
+        }
         
         
         int resultIdChange = 0;
@@ -1287,14 +1261,13 @@
 
         int countResult = 100;
         try {
-                    countResult = database.getNumRows(resultIdChange);
-                    logger.debug(&quot;getRelationshipHistoryChange - Number of result: &quot;+countResult);
-            } catch (RemoteException e) {
-                    System.err.println(&quot;RemoteException- getRelationshipHistoryChange(), getNumRows&quot;);
-            }		
-        //close session
-        database.closeQuery(query);
-        
+            countResult = database.getNumRows(resultIdChange);
+            logger.debug(&quot;getRelationshipHistoryChange - Number of result: &quot;+countResult);
+            //close session
+            database.closeQuery(query);
+        } catch (RemoteException e) {
+            System.err.println(&quot;RemoteException- getRelationshipHistoryChange(), getNumRows&quot;);
+        }
 	return countResult;
     }
     
@@ -1307,10 +1280,11 @@
                 query = database.createQuery(Occurrence.class);                
                 query.addRestriction(PlantloreConstants.RESTR_EQ, Occurrence.HABITAT , null, occurrence.getHabitat() , null);
         } catch(RemoteException e) {
-        	System.err.println(&quot;RemoteException- getRelationshipHabitat(), createQuery&quot;);       	  
+        	System.err.println(&quot;RemoteException - getRelationshipHabitat(), createQuery&quot;);       	  
+        } catch(DBLayerException e) {
+        	System.err.println(&quot;DBLayerException - getRelationshipHabitat(), createQuery&quot;);       	  
         }        
         
-        
         int resultIdHabitat = 0;
         try {                   
         	resultIdHabitat = database.executeQuery(query);        
@@ -1322,14 +1296,13 @@
 
         int countResult = 100;
         try {
-                    countResult = database.getNumRows(resultIdHabitat);
-                    logger.debug(&quot;getRelationshipHabitat - Number of result: &quot;+countResult);
-            } catch (RemoteException e) {
-                    System.err.println(&quot;RemoteException- searchHistoryChangeId(), getNumRows&quot;);
-            }		
-        //close session
-        database.closeQuery(query);
-        
+            countResult = database.getNumRows(resultIdHabitat);
+            logger.debug(&quot;getRelationshipHabitat - Number of result: &quot;+countResult);
+            //close session
+            database.closeQuery(query);
+        } catch (RemoteException e) {
+            System.err.println(&quot;RemoteException- searchHistoryChangeId(), getNumRows&quot;);
+        }
 	return countResult;
     }
     

Modified: trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -11,7 +11,7 @@
 
 import static net.sf.plantlore.common.PlantloreConstants.RESTR_EQ;
 import static net.sf.plantlore.common.PlantloreConstants.RESTR_IS_NULL;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.common.exception.ImportException;
 import net.sf.plantlore.common.exception.ParserException;
 import net.sf.plantlore.common.record.*;

Modified: trunk/src/net/sf/plantlore/client/login/AuthCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/login/AuthCtrl.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/login/AuthCtrl.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -10,7 +10,7 @@
 import org.apache.log4j.Logger;
 
 import net.sf.plantlore.l10n.L10n;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 public class AuthCtrl {
 	

Modified: trunk/src/net/sf/plantlore/client/login/Login.java
===================================================================
--- trunk/src/net/sf/plantlore/client/login/Login.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/login/Login.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -11,7 +11,7 @@
 import net.sf.plantlore.common.record.Right;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.DBLayerFactory;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 /**
  * Login is responsible for the following:
@@ -74,10 +74,10 @@
 
 		 // TEMPORARY CODE STARTS HERE
 
-				dbinfo.add(new DBInfo(&quot;Local Database But Via RMI&quot;, &quot;data.kolej.mff.cuni.cz&quot;, -1,
+/*				dbinfo.add(new DBInfo(&quot;Local Database But Via RMI&quot;, &quot;data.kolej.mff.cuni.cz&quot;, -1,
 						&quot;jdbc:firebirdsql:localhost/3050:c:/downloaded/plantloreHIBdata.fdb&quot;, 
 						new String[] { &quot;sysdba&quot;, null, null, null, null }));                
-
+*/
 				dbinfo.add(new DBInfo(&quot;My Home Database&quot;, &quot;&quot;, -1,
 							&quot;jdbc:firebirdsql:localhost/3050:c:/Kovo/PlantloreClean/plantloreHIBdataUTF.fdb&quot;, 
 							new String[] { &quot;sysdba&quot;, null, null, null, null }));
@@ -237,6 +237,7 @@
 		} 
 		catch (DBLayerException exception) {
 			logger.error(&quot;The initialization of the DBLayer failed! Here's why: &quot; + exception);
+                        exception.printStackTrace();
 			// If the initialization of the DBLayer failed, the uninitialized DBLayer must be destroyed!
 			// If it is not, the server's policy may not allow another connection from this client!
 			factory.destroy(dblayer);

Modified: trunk/src/net/sf/plantlore/client/metadata/MetadataManager.java
===================================================================
--- trunk/src/net/sf/plantlore/client/metadata/MetadataManager.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/metadata/MetadataManager.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -14,7 +14,7 @@
 import net.sf.plantlore.common.record.Metadata;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.apache.log4j.Logger;
 
 /**
@@ -76,7 +76,9 @@
         try {
                 query = database.createQuery(Metadata.class);                                
         } catch (RemoteException e) {
-        System.err.println(&quot;RemoteException- searchMetadataData(), createQuery&quot;);
+            System.err.println(&quot;RemoteException - searchMetadataData(), createQuery&quot;);
+        } catch (DBLayerException e) {
+            System.err.println(&quot;DBLayerException - searchMetadataData(), createQuery&quot;);
         }
                 
         int resultId = 0;

Modified: trunk/src/net/sf/plantlore/client/publication/PublicationManager.java
===================================================================
--- trunk/src/net/sf/plantlore/client/publication/PublicationManager.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/publication/PublicationManager.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -15,7 +15,7 @@
 import net.sf.plantlore.common.record.Publication;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.apache.log4j.Logger;
 
 /**
@@ -128,7 +128,9 @@
                         query.addOrder(PlantloreConstants.DIRECT_DESC, field);
                 }
         } catch (RemoteException e) {
-        System.err.println(&quot;RemoteException- searchPublicationData(), createQuery&quot;);
+            System.err.println(&quot;RemoteException - searchPublicationData(), createQuery&quot;);
+        } catch (DBLayerException e) {
+            System.err.println(&quot;DBlayerException - searchPublicationData(), createQuery&quot;);
         }
                 
         int resultId = 0;

Modified: trunk/src/net/sf/plantlore/client/publications/PublicationManager.java
===================================================================
--- trunk/src/net/sf/plantlore/client/publications/PublicationManager.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/publications/PublicationManager.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -18,7 +18,7 @@
 import net.sf.plantlore.l10n.L10n;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.common.SwingWorker;
 import org.apache.log4j.Logger;
 
@@ -302,6 +302,9 @@
                 } catch (RemoteException e) {
                     System.err.println(&quot;Kdykoliv se pracuje s DBLayer nebo SelectQuery, musite hendlovat RemoteException&quot;);
                     return null;
+                } catch (DBLayerException e) {
+                    System.err.println(&quot;Kdykoliv se pracuje s DBLayer nebo SelectQuery, musite hendlovat RemoteException&quot;);
+                    return null;
                 }
             }
         };

Modified: trunk/src/net/sf/plantlore/client/user/UserManager.java
===================================================================
--- trunk/src/net/sf/plantlore/client/user/UserManager.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/client/user/UserManager.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -17,7 +17,7 @@
 import net.sf.plantlore.common.record.User;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.apache.log4j.Logger;
 
 /**
@@ -138,7 +138,9 @@
                         query.addOrder(PlantloreConstants.DIRECT_DESC, field);
                 }
         } catch (RemoteException e) {
-        System.err.println(&quot;RemoteException- searchUserData(), createQuery&quot;);
+            System.err.println(&quot;RemoteException - searchUserData(), createQuery&quot;);
+        } catch (DBLayerException e) {
+            System.err.println(&quot;DBLayerException - searchUserData(), createQuery&quot;);
         }
                 
         int resultId = 0;

Modified: trunk/src/net/sf/plantlore/common/DBLayerUtils.java
===================================================================
--- trunk/src/net/sf/plantlore/common/DBLayerUtils.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/common/DBLayerUtils.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -15,7 +15,7 @@
 import net.sf.plantlore.common.record.Record;
 import net.sf.plantlore.middleware.DBLayer;
 import net.sf.plantlore.middleware.SelectQuery;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.server.HibernateDBLayer;
 
 /** Class offering convenience methods for DBLayer.

Modified: trunk/src/net/sf/plantlore/common/exception/DBLayerException.java
===================================================================
--- trunk/src/net/sf/plantlore/common/exception/DBLayerException.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/common/exception/DBLayerException.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -5,9 +5,70 @@
  * (DBLayer) went wrong.
  * 
  * @author Erik Kratochv&#237;l (<A HREF="https://lists.berlios.de/mailman/listinfo/plantlore-dev">discontinuum at gmail.com</A>)
+ * @author Tomas Kovarik (<A HREF="https://lists.berlios.de/mailman/listinfo/plantlore-dev">tkovarik at gmail.com</A>)
  * @since 2006-04-29
  *
  */
 public class DBLayerException extends PlantloreException {
-
+        /** Error code */
+        private int errorCode;
+        /** Additional error info */
+        private String errorInfo;
+    
+        // ================= ERROR CODES ===============
+        /** Database configuration cannot be loaded properly */
+        public static final int ERROR_LOAD_CONFIG = 1;
+        /** Connection to the database failed or no connection available */
+        public static final int ERROR_CONNECT = 2;
+        /** Login and/or password do not match any user record */
+        public static final int ERROR_LOGIN = 3;
+        /** Saving data into the DB failed */
+        public static final int ERROR_SAVE = 4;
+        /** Deleteing data from the database failed */
+        public static final int ERROR_DELETE = 5;
+        /** Updating data in the DB failed */
+        public static final int ERROR_UPDATE = 6;
+        /** Selecting data from the DB failed */
+        public static final int ERROR_SELECT = 7;        
+        /** Retrieving data from the DB failed */
+        public static final int ERROR_LOAD_DATA = 8;
+        /** Cannot close connection to the DB */
+        public static final int ERROR_CLOSE = 9;
+        /** User doesn't have rights to execute the operation */
+        public static final int ERROR_RIGHTS = 10;        
+        /** Database not consistent (e.g. tHistoryColumn doesn't contain data) */
+        public static final int ERROR_DB = 11;
+        /** Some other error */
+        public static final int ERROR_OTHER = 20;
+        // ==============================================
+        /** Create new DBLayerException without an error message */
+        public DBLayerException() { super(); }
+	/** Create new DBLayerException with an error message */
+	public DBLayerException(String message) { super(message); }
+        
+        /**
+         *  Set error this exception represents.
+         *  @param errorCode code of the error. For the list of codes, see constants.
+         *  @param errorInfo additional information about the error
+         */
+        public void setError(int errorCode, String errorInfo) {
+            this.errorCode = errorCode;
+            this.errorInfo = errorInfo;
+        }
+        
+        /**
+         *  Return error code for this exception.
+         *  @return error code for this exception
+         */
+        public int getErrorCode() {
+            return this.errorCode;
+        }
+        
+        /**
+         *  Return additional information for this exception.
+         *  @return additional information for this exception
+         */
+        public String getErrorInfo() {
+            return this.errorInfo;
+        }
 }

Modified: trunk/src/net/sf/plantlore/middleware/DBLayer.java
===================================================================
--- trunk/src/net/sf/plantlore/middleware/DBLayer.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/middleware/DBLayer.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -12,7 +12,7 @@
 import java.rmi.RemoteException;
 import net.sf.plantlore.common.record.Right;
 import net.sf.plantlore.common.record.User;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 /**
  * Interface for database access.
@@ -129,7 +129,7 @@
      *  @return an instance of &lt;code&gt;SelectQuery&lt;/code&gt; used for building a query by client
      *
      */
-    public SelectQuery createQuery(Class classname) throws RemoteException;
+    public SelectQuery createQuery(Class classname) throws DBLayerException, RemoteException;
 
     /**
      *  Execute constructed SELECT query. Only executes query, for retrieving results use next() and more()
@@ -144,7 +144,7 @@
      *
      *  @param query query we want to close
      */    
-    public void closeQuery(SelectQuery query);
+    public void closeQuery(SelectQuery query) throws RemoteException;
 
     /**
      *  Execute SQL delete with condition. Only administrator should be allowed to run this.
@@ -156,7 +156,7 @@
      *  @param value value in the condition. Must be either String, Integer or Date
      *  @return number of rows deleted
      */    
-    public int conditionDelete(Class tableClass, String column, String operation, Object value) throws DBLayerException;
+    public int conditionDelete(Class tableClass, String column, String operation, Object value) throws DBLayerException, RemoteException;
 
     /**
      *  Method to get the currently logged user. Returns null if there is no user logged in.
@@ -169,7 +169,19 @@
      *  @return rights of the currently logged in user or null if there is no user logged in.
      */    
     public Right getUserRights() throws RemoteException;
-        
+
+    public boolean beginTransaction() throws DBLayerException, RemoteException;
+            
+    public boolean commitTransaction() throws DBLayerException, RemoteException;
+            
+    public boolean rollbackTransaction() throws DBLayerException, RemoteException;    
+
+    public int executeInsertInTransaction(Object data) throws DBLayerException, RemoteException;
+            
+    public void executeUpdateInTransaction(Object data) throws DBLayerException, RemoteException;
+    
+    public void executeDeleteInTransaction(Object data) throws DBLayerException, RemoteException;
+                        
     public void shutdown() throws RemoteException;
         
 }

Modified: trunk/src/net/sf/plantlore/middleware/DBLayerFactory.java
===================================================================
--- trunk/src/net/sf/plantlore/middleware/DBLayerFactory.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/middleware/DBLayerFactory.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -3,7 +3,7 @@
 import java.rmi.NotBoundException;
 import java.rmi.RemoteException;
 
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 /** 
  * Interface for obtaining the (possibly remote) DBLayer object.

Modified: trunk/src/net/sf/plantlore/middleware/RMIDBLayerFactory.java
===================================================================
--- trunk/src/net/sf/plantlore/middleware/RMIDBLayerFactory.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/middleware/RMIDBLayerFactory.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -9,7 +9,7 @@
 import org.apache.log4j.Logger;
 
 import net.sf.plantlore.server.ConnectionInfo;
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 import net.sf.plantlore.server.HibernateDBLayer;
 import net.sf.plantlore.middleware.RemoteDBLayerFactory;
 

Modified: trunk/src/net/sf/plantlore/middleware/RemoteDBLayerFactory.java
===================================================================
--- trunk/src/net/sf/plantlore/middleware/RemoteDBLayerFactory.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/middleware/RemoteDBLayerFactory.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -3,7 +3,7 @@
 import java.rmi.Remote;
 import java.rmi.RemoteException;
 
-import net.sf.plantlore.server.DBLayerException;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 /** 
  * Interface for obtaining remote references of the DBLayer objects running on some remote server.

Deleted: trunk/src/net/sf/plantlore/server/DBLayerException.java
===================================================================
--- trunk/src/net/sf/plantlore/server/DBLayerException.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/server/DBLayerException.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -1,29 +0,0 @@
-/*
- * DBLayerException.java
- *
- * Created on 16. leden 2006, 3:25
- *
- */
-
-package net.sf.plantlore.server;
-
-/**
- *  Exception for the DBLayer package (on the client side)
- *  
- *  FIXME: presunout nejspis do middleware package...
- *
- *  @author Tomas Kovarik
- *  @version 0.1, Jan 16, 2006
- */
-public class DBLayerException extends Exception {
-    
-    /** Creates a new instance of DBLayerException */
-    public DBLayerException() {
-        super();
-    }
-    
-    /** Creates a new instance of DBLayerException with the specified message */
-    public DBLayerException(String message) {
-        super(message);
-    }
-}

Modified: trunk/src/net/sf/plantlore/server/HibernateDBLayer.java
===================================================================
--- trunk/src/net/sf/plantlore/server/HibernateDBLayer.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/server/HibernateDBLayer.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -15,17 +15,22 @@
 import java.util.Hashtable;
 import net.sf.plantlore.common.PlantloreConstants;
 import net.sf.plantlore.common.record.Author;
+import net.sf.plantlore.common.record.AuthorOccurrence;
+import net.sf.plantlore.common.record.Habitat;
 import net.sf.plantlore.common.record.HistoryChange;
 import net.sf.plantlore.common.record.HistoryColumn;
 import net.sf.plantlore.common.record.HistoryRecord;
+import net.sf.plantlore.common.record.Metadata;
 import net.sf.plantlore.common.record.Occurrence;
 import net.sf.plantlore.common.record.Phytochorion;
+import net.sf.plantlore.common.record.Plant;
 import net.sf.plantlore.common.record.Publication;
 import net.sf.plantlore.common.record.Right;
 import net.sf.plantlore.common.record.Territory;
 import net.sf.plantlore.common.record.User;
 import net.sf.plantlore.common.record.Village;
 import org.apache.log4j.Logger;
+import net.sf.plantlore.common.exception.DBLayerException;
 import org.hibernate.HibernateException;
 import org.hibernate.Query;
 import org.hibernate.ScrollableResults;
@@ -36,6 +41,7 @@
 import net.sf.plantlore.middleware.SelectQuery;
 
 import org.hibernate.Transaction;
+import org.hibernate.criterion.Restrictions;
 
 
 /**
@@ -68,7 +74,13 @@
     /** Rights of the authenticated user */
     private Right rights;    
 
+    private Session txSession;
+    private Transaction longTx;            
+            
     private static final int INITIAL_POOL_SIZE = 8;
+    private static final int INSERT = 1;
+    private static final int DELETE = 2;
+    private static final int UPDATE = 3;
     
     /**
      * Creates a new instance of HibernateDBLayer.
@@ -107,7 +119,7 @@
      *          (Right object, index 1)
      *  @throws DBLayerException when the hibernate or database connection cannot be initialized
      */
-    public Object[] initialize(String dbID, String user, String password) throws DBLayerException {
+    public Object[] initialize(String dbID, String user, String password) throws DBLayerException, RemoteException {
         Configuration cfg;
         int result = 0;
         
@@ -118,7 +130,9 @@
             cfg = new Configuration().configure(configFile);
         } catch (HibernateException e) {
             logger.fatal(&quot;Cannot load Hibernate configuration. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Cannot load Hibernate configuration. Details: &quot;+e.getMessage());            
+            DBLayerException ex = new DBLayerException(&quot;Cannot load Hibernate configuration. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_LOAD_CONFIG, null);
+            throw ex;
         }
         // TODO: this should be loaded from a configuration file on the server
         // We are temporarily using this for DB authetication and user athentication as well
@@ -130,16 +144,21 @@
             sessionFactory = cfg.buildSessionFactory();
         } catch (HibernateException e) {
             logger.fatal(&quot;Cannot build Hibernate session factory. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Cannot build Hibernate session factory. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Cannot build Hibernate session factory. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }   
         
         // Authenticate user
         try {
             SelectQuery sq = this.createQuery(User.class);            
             sq.addRestriction(PlantloreConstants.RESTR_EQ, User.LOGIN, null, user, null);
+            // TODO: Password should probably be encrypted
+            // sq.addRestriction(PlantloreConstants.RESTR_EQ, User.PASSWORD, null, password, null);
+            sq.addRestriction(PlantloreConstants.RESTR_IS_NULL, User.DROPWHEN, null, null, null);
             result = this.executeQuery(sq);
         } catch (RemoteException e) {
-            logger.fatal(&quot;Cannot load user information. Details: &quot;+e.getMessage());
+            logger.fatal(&quot;Cannot load user information. Details: &quot;+e.getMessage());            
         }
         Object[] userinfo = next(result);
         if (userinfo == null) {
@@ -147,7 +166,9 @@
             sessionFactory.close();
             sessionFactory = null;
             logger.warn(&quot;Authentication of user &quot;+user+&quot; failed!&quot;);
-            return null;
+            DBLayerException ex = new DBLayerException(&quot;Authentication of user &quot;+user+&quot; failed!&quot;);
+            ex.setError(ex.ERROR_LOGIN, null);
+            throw ex;
         } else {
             User clientUser = (User)userinfo[0];            
             this.rights = clientUser.getRight();           
@@ -166,15 +187,18 @@
      *  @return identifier (primary key) of the inserted row
      *  @throws DBLayerException when saving data into the database fails
      */
-    public int executeInsert(Object data) throws DBLayerException {
+    public int executeInsert(Object data) throws DBLayerException, RemoteException {
         int recordId, id, result = 0;        
         String table;
         HistoryColumn column;
         
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
-        }        
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
         Session session = sessionFactory.openSession();
         Transaction tx = null;                
         try {
@@ -225,7 +249,9 @@
                 Object[] objCol = next(result);
                 if (objCol == null) {                
                     logger.error(&quot;tHistoryColumn doesn't contain required data&quot;);
-                    throw new DBLayerException(&quot;tHistoryColumn doesn't contain required data&quot;);                    
+                    DBLayerException ex = new DBLayerException(&quot;tHistoryColumn doesn't contain required data&quot;);
+                    ex.setError(ex.ERROR_DB, PlantloreConstants.ENTITY_HISTORYCOLUMN);
+                    throw ex;
                 } else {
                     column = (HistoryColumn)objCol[0];
                 }                
@@ -245,7 +271,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_SAVE, null);
+            throw ex;            
         } finally {
             session.close();
         }
@@ -259,12 +287,16 @@
      *  @return identifier (primary key) of the inserted row
      *  @throws DBLayerException when saving data into the database fails
      */
-    public int executeInsertHistory(Object data) throws DBLayerException {
+    public int executeInsertHistory(Object data) throws DBLayerException, RemoteException {
         int recordId;        
+
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
-        }        
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
         Session session = sessionFactory.openSession();
         Transaction tx = null;        
         try {
@@ -279,7 +311,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_SAVE, null);
+            throw ex;            
         } finally {
             session.close();
         }
@@ -292,14 +326,18 @@
      *  @param data data we want to delete (must be one of the holder objects)
      *  @throws DBLayerException when deleting data fails
      */
-    public void executeDelete(Object data) throws DBLayerException {
+    public void executeDelete(Object data) throws DBLayerException, RemoteException {
         String table;
         int id, result = 0;
         HistoryColumn column;        
+
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
-        }        
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
         Session session = sessionFactory.openSession();        
         Transaction tx = null;
         // Save records to history if required
@@ -341,7 +379,9 @@
                 Object[] objCol = next(result);
                 if (objCol == null) {                
                     logger.error(&quot;tHistoryColumn doesn't contain required data&quot;);
-                    throw new DBLayerException(&quot;tHistoryColumn doesn't contain required data&quot;);                    
+                    DBLayerException ex = new DBLayerException(&quot;tHistoryColumn doesn't contain required data&quot;);
+                    ex.setError(ex.ERROR_DB, PlantloreConstants.ENTITY_HISTORYCOLUMN);
+                    throw ex;
                 } else {
                     column = (HistoryColumn)objCol[0];
                 }                
@@ -365,7 +405,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_DELETE, null);
+            throw ex;            
         } finally {
             session.close();
         }
@@ -377,10 +419,13 @@
      *  @param data data we want to delete (must be one of the holder objects)
      *  @throws DBLayerException when deleting data fails
      */
-    public void executeDeleteHistory(Object data) throws DBLayerException {
+    public void executeDeleteHistory(Object data) throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }
         Session session = sessionFactory.openSession();        
         Transaction tx = null;
@@ -395,7 +440,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_DELETE, null);
+            throw ex;
         } finally {
             session.close();
         }
@@ -407,12 +454,15 @@
      *  @param data to update (must be one of the holder objects)
      *  @throws DBLayerException when updating data fails
      */
-    public void executeUpdate(Object data) throws DBLayerException {
+    public void executeUpdate(Object data) throws DBLayerException, RemoteException {
         int id;
         
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }
         Session session = sessionFactory.openSession();
         Transaction tx = null;        
@@ -461,7 +511,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_UPDATE, null);
+            throw ex;            
         } finally {
             session.close();
         }
@@ -473,10 +525,13 @@
      *  @param data to update (must be one of the holder objects)
      *  @throws DBLayerException when updating data fails
      */
-    public void executeUpdateHistory(Object data) throws DBLayerException {
+    public void executeUpdateHistory(Object data) throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }
         Session session = sessionFactory.openSession();
         Transaction tx = null;
@@ -491,7 +546,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_UPDATE, null);
+            throw ex;
         } finally {
             session.close();
         }
@@ -507,15 +564,19 @@
      *          array as well (in case associated entities are fetched)
      *  @throws DBLayerException
      */
-    public Object[] more(int resultId, int from, int to) throws DBLayerException {    
+    public Object[] more(int resultId, int from, int to) throws DBLayerException, RemoteException {
         // Check validity of arguments
         if (from&gt;to) {
-            logger.error(&quot;Cannot read rows from &quot;+from+&quot; to &quot;+to+&quot; because from &gt; to&quot;);
-            throw new DBLayerException(&quot;Cannot read rows from &quot;+from+&quot; to &quot;+to+&quot; because from &gt; to&quot;);
+            logger.error(&quot;Cannot read rows from &quot;+from+&quot; to &quot;+to+&quot; because from &gt; to&quot;);            
+            DBLayerException ex = new DBLayerException(&quot;Cannot read rows from &quot;+from+&quot; to &quot;+to+&quot; because from &gt; to&quot;);
+            ex.setError(ex.ERROR_OTHER, null);
+            throw ex;
         } 
         if (from &lt; 0) {
             logger.error(&quot;Cannot read rows starting at the given index: &quot;+from);
-            throw new DBLayerException(&quot;Cannot read rows starting at the given index: &quot;+from);            
+            DBLayerException ex = new DBLayerException(&quot;Cannot read rows starting at the given index: &quot;+from);
+            ex.setError(ex.ERROR_OTHER, null);
+            throw ex;
         }
         // Get results for the given resultId
         ScrollableResults res = results.get(resultId);
@@ -529,7 +590,9 @@
             }
         } catch (HibernateException e) {
             logger.error(&quot;Cannot move to the given row of results: &quot;+from);
-            throw new DBLayerException(&quot;Cannot move to the given row of results: &quot;+from);
+            DBLayerException ex = new DBLayerException(&quot;Cannot move to the given row of results: &quot;+from);
+            ex.setError(ex.ERROR_OTHER, null);
+            throw ex;            
         }
         // Allocate space for data
         Object[] data = new Object[to-from+1];
@@ -548,7 +611,9 @@
             }
         } catch (HibernateException e) {
             logger.error(&quot;Cannot read data from the results&quot;);
-            throw new DBLayerException(&quot;Cannot read data from the results&quot;);            
+            DBLayerException ex = new DBLayerException(&quot;Cannot read data from the results&quot;);
+            ex.setError(ex.ERROR_LOAD_DATA, null);
+            throw ex;            
         }
         return data;
     }
@@ -561,7 +626,7 @@
      *          associated entities were fetched.
      *  @throws DBLayerException when loading the results fails
      */
-    public Object[] next(int resultId) throws DBLayerException {
+    public Object[] next(int resultId) throws DBLayerException, RemoteException {
         // Get results for the given resultId
         ScrollableResults res = results.get(resultId);
         // In case no more rows are available, return null
@@ -571,7 +636,9 @@
             }
         } catch (HibernateException e) {
             logger.fatal(&quot;Database error occured&quot;);
-            throw new DBLayerException(&quot;Database error occured&quot;);
+            DBLayerException ex = new DBLayerException(&quot;Database error occured&quot;);
+            ex.setError(ex.ERROR_OTHER, null);
+            throw ex;            
         }        
         return res.get();        
     }
@@ -582,9 +649,9 @@
      *  @param  resultId id of the result we want the number of rows for
      *  @return number of rows in the given result
      */
-    public int getNumRows(int resultId) {
+    public int getNumRows(int resultId) throws RemoteException {
         int numRows;
-                
+            
         // Get results for the given resultId
         ScrollableResults res = results.get(resultId);        
         int currentRow = res.getRowNumber();        
@@ -603,16 +670,21 @@
      *
      *  @throws DBLayerException when closing session fails
      */
-    public void close() throws DBLayerException {    
+    public void close() throws DBLayerException, RemoteException {    
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not available&quot;);
-            throw new DBLayerException(&quot;SessionFactory not available&quot;);
-        }        
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
         try {
             sessionFactory.close();
         } catch (HibernateException e) {
             logger.fatal(&quot;Cannot close session factory&quot;);
-            throw new DBLayerException(&quot;Cannot close session factory&quot;);            
+            DBLayerException ex = new DBLayerException(&quot;Cannot close session factory&quot;);
+            ex.setError(ex.ERROR_CLOSE, null);
+            throw ex;            
         }
     }
     
@@ -623,11 +695,13 @@
      *  @return an instance of &lt;code&gt;SelectQuery&lt;/code&gt; used for building a query by client
      *
      */
-    // TODO: Pridat throws DBLayerException
-    public SelectQuery createQuery(Class classname) throws RemoteException {
+    public SelectQuery createQuery(Class classname) throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            // throw new DBLayerException(&quot;SessionFactory not available&quot;);
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }
         Session session = sessionFactory.openSession();
         SelectQuery query = new SelectQueryImplementation(session.createCriteria(classname)), 
@@ -647,7 +721,7 @@
      *  @param query query we want to execute
      *  @throws DBLayerException when selecting records from the database fails
      */
-    public int executeQuery(SelectQuery query) throws DBLayerException {
+    public int executeQuery(SelectQuery query) throws DBLayerException, RemoteException {
 
     	SelectQuery selectQuery = queries.remove(query);
     	if(selectQuery == null) throw new DBLayerException(&quot;You can only pass queries created by this DBLayer!&quot;);
@@ -667,6 +741,7 @@
         try {
             tx = session.beginTransaction();
             // Execute detached criteria query
+            System.out.println(sq.getCriteria().toString());            
             res = sq.getCriteria().scroll(); // retrieve Criteria from SelectQuery
             // Commit transaction
             tx.commit();                                      
@@ -675,7 +750,9 @@
                 tx.rollback();
             }
             logger.fatal(&quot;Selecting records from the database failed. Details: &quot;+e.getMessage());
-            throw new DBLayerException(&quot;Selecting records from the database failed. Details: &quot;+e.getMessage());
+            DBLayerException ex = new DBLayerException(&quot;Selecting records from the database failed. Details: &quot;+e.getMessage());
+            ex.setError(ex.ERROR_SELECT, null);
+            throw ex;            
         }
         // Update current maximum result id and save the results
         maxResultId++; 
@@ -693,13 +770,16 @@
      *  @param value value in the condition. Must be either String, Integer or Date
      *  @return number of rows deleted
      */
-    public int conditionDelete(Class tableClass, String column, String operation, Object value) throws DBLayerException {
+    public int conditionDelete(Class tableClass, String column, String operation, Object value) throws DBLayerException, RemoteException {
         String tableName;
         int deletedEntities = 0;
         
+        // Check whether we are connected to the database
         if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable&quot;);
-            // throw new DBLayerException(&quot;SessionFactory not available&quot;);
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
         }
         Transaction tx = null;
         try {
@@ -725,7 +805,9 @@
             session.close();                    
         } catch (HibernateException e) {
             logger.fatal(&quot;Cannot execute conditional delete on table &quot;+tableClass.getName());
-            throw new DBLayerException(&quot;Cannot execute conditional delete on table &quot;+tableClass.getName());
+            DBLayerException ex = new DBLayerException(&quot;Cannot execute conditional delete on table &quot;+tableClass.getName());
+            ex.setError(ex.ERROR_DELETE, tableClass.getName());
+            throw ex;
         }
         return deletedEntities;
     }
@@ -735,7 +817,7 @@
      *
      *  @param query query we want to close
      */
-    public void closeQuery(SelectQuery query) {
+    public void closeQuery(SelectQuery query) throws RemoteException {
         Session session = sessions.get(query);
         session.close();
         sessions.remove(query);
@@ -745,7 +827,7 @@
      *  Method to get the currently logged user. Returns null if there is no user logged in.
      *  @return currently logged in user or null, if there is no user logged in.
      */
-    public User getUser() {
+    public User getUser() throws RemoteException {
         return this.plantloreUser;
     }
     
@@ -753,10 +835,235 @@
      *  Method to get the rights of the currently logged in user. Returns null if there is no user logged in
      *  @return rights of the currently logged in user or null if there is no user logged in.
      */
-    public Right getUserRights() {
+    public Right getUserRights() throws RemoteException {
         return this.rights;
     }
+
+    public boolean beginTransaction() throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether there is some other running transaction
+        if (this.longTx != null) {
+            return false;               // Return with an error indicating other transaction is running
+        }
+        // Open new session
+        this.txSession = sessionFactory.openSession();
+        // Begin new transaction
+        this.longTx = this.txSession.beginTransaction();        
+        return true;                    // Transaction succesfully started
+    }
     
+    public boolean commitTransaction() throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether we have an opened session and running transaction
+        if ((this.longTx == null) || (this.txSession == null)) {
+            return false;               // Return with an error indicating we don't have proper conditions
+        }
+        // Commit the transaction
+        this.longTx.commit();
+        return true;
+    }
+    
+    public boolean rollbackTransaction() throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether we have an opened session and running transaction
+        if ((this.longTx == null) || (this.txSession == null)) {
+            return false;               // Return with an error indicating we don't have proper conditions
+        }
+        // Rollback the transaction
+        this.longTx.rollback();
+        return true;        
+    }
+    
+    public int executeInsertInTransaction(Object data) throws DBLayerException, RemoteException {
+        int recordId;
+        
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether we have rights for this operation
+        checkRights(data, INSERT);
+        // Save item into the database
+        recordId = (Integer)this.txSession.save(data);            
+        // Save data to history tables - only for selected tables
+        saveHistory(txSession, data, INSERT, recordId);
+        // Return new record identifier
+        return recordId;        
+    }
+    
+    public void executeUpdateInTransaction(Object data) throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether we have rights for this operation
+        checkRights(data, UPDATE);
+        // Save history record for this change
+        saveHistory(txSession, data, UPDATE, null);
+        // Save item into the database
+        txSession.update(data);
+    }
+    
+    public void executeDeleteInTransaction(Object data) throws DBLayerException, RemoteException {
+        // Check whether we are connected to the database
+        if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
+            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
+            ex.setError(ex.ERROR_CONNECT, null);
+            throw ex;
+        }
+        // Check whether we have rights for this operation
+        checkRights(data, DELETE);
+        // Save history record for this change
+        saveHistory(txSession, data, DELETE, null);
+        // Save item into the database
+        txSession.delete(data);
+    }    
+    
+    private void checkRights(Object data, int type) throws DBLayerException {
+        DBLayerException ex;
+        Session sess;
+        
+        // Check rights for table TAUTHORS
+        if (data instanceof Author) {
+            if ((type == DELETE) || (type == UPDATE)) {
+                // Only data of the user and those listed in CEDITGROUP
+                sess = this.sessionFactory.openSession();
+                ScrollableResults sc = sess.createCriteria(Author.class)
+                    .add(Restrictions.eq(Author.ID, ((Author)data).getId()))
+                    .scroll();
+                // If we haven't found the author in the database, raise exception
+                if (sc.next()) {
+                    logger.error(&quot;To-be-updated/deleted author not found in the database. Author ID:&quot;+((Author)data).getId());
+                    ex = new DBLayerException(&quot;To-be-updated/deleted author not found in the database. Author ID:&quot;+((Author)data).getId());
+                    ex.setError(ex.ERROR_OTHER, null);
+                    throw ex;                                        
+                }
+                Object[] res = sc.get();
+                Author aut = (Author)res[0];
+                // Check for direct ownership first
+                if (!aut.getCreatedWho().equals(this.plantloreUser)) {
+                }
+                // Then check for indirect (group) ownership
+                String[] group = this.rights.getEditGroup().split(&quot;,&quot;);                    
+                for (int i=0;i&lt;group.length;i++) {
+                    // if ()
+                }
+            }
+            if (type == INSERT) {
+                // Insert only if CADD = 1
+                if (this.rights.getAdd() == 0) {
+                    logger.warn(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_AUTHOR);
+                    ex = new DBLayerException(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_AUTHOR);
+                    ex.setError(ex.ERROR_RIGHTS, PlantloreConstants.ENTITY_AUTHOR);
+                    throw ex;                    
+                }                
+            }            
+        }
+        // Check rights for table TUSER
+        if (data instanceof User) {
+            // Only admin can insert/update/delete from this table
+            if (this.rights.getAdministrator() != 1) {
+                logger.warn(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_USER);
+                ex = new DBLayerException(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_USER);
+                ex.setError(ex.ERROR_RIGHTS, PlantloreConstants.ENTITY_USER);
+                throw ex;
+            }
+            // User can edit his own data except for login name
+            
+        }
+        // Check rights for table TRIGHT, TPHYTOCHORIA, TVILLAGES, TTERRITORIES, TPLANTS, TMETADATA
+        if ((data instanceof Right) || (data instanceof Phytochorion) ||
+            (data instanceof Village) || (data instanceof Territory) ||
+            (data instanceof Plant) || (data instanceof Metadata)) {
+            String entity = &quot;&quot;;
+            if (data instanceof Right) { entity = PlantloreConstants.ENTITY_RIGHT; }
+            if (data instanceof Phytochorion) { entity = PlantloreConstants.ENTITY_PHYTOCHORION; }
+            if (data instanceof Village) { entity = PlantloreConstants.ENTITY_VILLAGE; }
+            if (data instanceof Territory) { entity = PlantloreConstants.ENTITY_TERRITORY; }
+            if (data instanceof Plant) { entity = PlantloreConstants.ENTITY_PLANT; }            
+            if (data instanceof Metadata) { entity = PlantloreConstants.ENTITY_METADATA; }
+            // Only admin can insert/update/delete from this table
+            if (this.rights.getAdministrator() != 1) {
+                logger.warn(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+entity);
+                ex = new DBLayerException(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+entity);
+                ex.setError(ex.ERROR_RIGHTS, entity);
+                throw ex;
+            }            
+        }
+        // Check rights for table THISTORYCOLUMN
+        if (data instanceof HistoryColumn) {
+            logger.warn(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_HISTORYCOLUMN);
+            ex = new DBLayerException(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+PlantloreConstants.ENTITY_HISTORYCOLUMN);
+            ex.setError(ex.ERROR_RIGHTS, PlantloreConstants.ENTITY_HISTORYCOLUMN);
+            throw ex;            
+        }
+        // Check rights for table THISTORY and THISTORYCHANGE
+        if ((data instanceof HistoryChange) || (data instanceof HistoryRecord)) {
+            if ((type == INSERT) || (type == UPDATE)) {
+                String entity = &quot;&quot;;
+                if (data instanceof HistoryChange) { entity = PlantloreConstants.ENTITY_HISTORYCHANGE; }
+                if (data instanceof HistoryRecord) { entity = PlantloreConstants.ENTITY_HISTORYRECORD; }                
+                logger.warn(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+entity);
+                ex = new DBLayerException(&quot;User doesn't have sufficient rights for this operation. Entity: &quot;+entity);
+                ex.setError(ex.ERROR_RIGHTS, entity);
+                throw ex;                            
+            } else if (type == DELETE) {
+                // Tu to bude zlozitejsie...
+            }           
+        }        
+        // Check rights for table TPUBLICATIONS
+        if (data instanceof Publication) {
+            if ((type == DELETE) || (type == UPDATE)) {
+                // Only data of the user and those listed in CEDITGROUP
+            }
+            if (type == INSERT) {
+                // Only if CADD = 1
+            }                        
+        }
+        // Check rights for table TOCCURRENCES
+        if (data instanceof Occurrence) {
+           
+        }
+        // Check rights for table THABITATS
+        if (data instanceof Habitat) {
+            
+        }
+        // Check rights for table TAUTHORSOCCURRENCES
+        if (data instanceof AuthorOccurrence) {
+            
+        }        
+    }
+    
+    private void saveHistory(Session sess, Object data, int type, Integer recordId) throws DBLayerException {
+        
+    }
+    
+    
     /**
      * This method is intended for final cleanup. &lt;b&gt;Do not call this method yourself!
      * The proper way for you to get rid of a DBLayer is to call DBLayer.destroy() method!&lt;/b&gt;

Modified: trunk/src/net/sf/plantlore/server/RMIRemoteDBLayerFactory.java
===================================================================
--- trunk/src/net/sf/plantlore/server/RMIRemoteDBLayerFactory.java	2006-05-08 20:16:44 UTC (rev 241)
+++ trunk/src/net/sf/plantlore/server/RMIRemoteDBLayerFactory.java	2006-05-08 21:59:19 UTC (rev 242)
@@ -6,6 +6,7 @@
 import java.rmi.server.UnicastRemoteObject;
 import java.util.Collection;
 import java.util.Hashtable;
+import net.sf.plantlore.common.exception.DBLayerException;
 
 import org.apache.log4j.Logger;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000280.html">[Plantlore-dev] r241 - trunk/src/net/sf/plantlore/client
</A></li>
	<LI>Next message: <A HREF="000282.html">[Plantlore-dev] r243 - in trunk: analysis/database src/net/sf/plantlore/common/record src/net/sf/plantlore/config/hibernate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#279">[ date ]</a>
              <a href="thread.html#279">[ thread ]</a>
              <a href="subject.html#279">[ subject ]</a>
              <a href="author.html#279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plantlore-dev">More information about the Plantlore-dev
mailing list</a><br>
</body></html>
