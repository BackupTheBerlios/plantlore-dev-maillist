<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plantlore-dev] r252 - in trunk/src/net/sf/plantlore/client: export imports
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plantlore-dev/2006-May/index.html" >
   <LINK REL="made" HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r252%20-%20in%20trunk/src/net/sf/plantlore/client%3A%20export%20imports&In-Reply-To=%3C200605092133.k49LX1XZ003664%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000298.html">
   <LINK REL="Next"  HREF="000296.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plantlore-dev] r252 - in trunk/src/net/sf/plantlore/client: export imports</H1>
    <B>krater at berlios.de</B> 
    <A HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r252%20-%20in%20trunk/src/net/sf/plantlore/client%3A%20export%20imports&In-Reply-To=%3C200605092133.k49LX1XZ003664%40sheep.berlios.de%3E"
       TITLE="[Plantlore-dev] r252 - in trunk/src/net/sf/plantlore/client: export imports">krater at berlios.de
       </A><BR>
    <I>Tue May  9 23:33:01 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000298.html">[Plantlore-dev] r251 - trunk/analysis/database
</A></li>
        <LI>Next message: <A HREF="000296.html">[Plantlore-dev] r253 - in trunk/src/net/sf/plantlore: client/history client/metadata client/publication client/user l10n
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#297">[ date ]</a>
              <a href="thread.html#297">[ thread ]</a>
              <a href="subject.html#297">[ subject ]</a>
              <a href="author.html#297">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: krater
Date: 2006-05-09 23:33:00 +0200 (Tue, 09 May 2006)
New Revision: 252

Added:
   trunk/src/net/sf/plantlore/client/imports/DecisionCtrl.java
   trunk/src/net/sf/plantlore/client/imports/DecisionView.form
   trunk/src/net/sf/plantlore/client/imports/DecisionView.java
   trunk/src/net/sf/plantlore/client/imports/ImportMngCtrl.java
   trunk/src/net/sf/plantlore/client/imports/ImportMngView.java
   trunk/src/net/sf/plantlore/client/imports/ImportProgressCtrl.java
   trunk/src/net/sf/plantlore/client/imports/ImportProgressView.java
Modified:
   trunk/src/net/sf/plantlore/client/export/ExportMng.java
   trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java
   trunk/src/net/sf/plantlore/client/imports/ImportMng.java
Log:
Unfinished GUI for import. Comments added to several classes.

Modified: trunk/src/net/sf/plantlore/client/export/ExportMng.java
===================================================================
--- trunk/src/net/sf/plantlore/client/export/ExportMng.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/export/ExportMng.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -384,12 +384,12 @@
 	}
 	
 	
+	/** Something that will not be true for a long time, at least the mankind hopes so. */
 	private boolean sunExploded = false;
 	
 
 	/**
-	 * Abort the current export. You &lt;b&gt;must call&lt;/b&gt; &lt;code&gt;finish()&lt;/code&gt; 
-	 * after calling &lt;code&gt;abort()&lt;/code&gt;. 
+	 * Abort the current export. 
 	 */
 	synchronized public void abort() {
 		if(!exportInProgress) return;

Added: trunk/src/net/sf/plantlore/client/imports/DecisionCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/DecisionCtrl.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/DecisionCtrl.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,15 @@
+package net.sf.plantlore.client.imports;
+
+public class DecisionCtrl {
+	
+	ImportMng model;
+	DecisionView view;
+	
+	
+	public DecisionCtrl(ImportMng model, DecisionView view) {
+		this.model = model; this.view = view;
+				
+	}
+
+	
+}

Added: trunk/src/net/sf/plantlore/client/imports/DecisionView.form
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/DecisionView.form	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/DecisionView.form	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,116 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
+
+&lt;Form version=&quot;1.3&quot; type=&quot;org.netbeans.modules.form.forminfo.JFrameFormInfo&quot;&gt;
+  &lt;Properties&gt;
+    &lt;Property name=&quot;title&quot; type=&quot;java.lang.String&quot; value=&quot;Decision&quot;/&gt;
+    &lt;Property name=&quot;cursor&quot; type=&quot;java.awt.Cursor&quot; editor=&quot;org.netbeans.modules.form.editors2.CursorEditor&quot;&gt;
+      &lt;Color id=&quot;Default Cursor&quot;/&gt;
+    &lt;/Property&gt;
+  &lt;/Properties&gt;
+  &lt;SyntheticProperties&gt;
+    &lt;SyntheticProperty name=&quot;formSizePolicy&quot; type=&quot;int&quot; value=&quot;1&quot;/&gt;
+  &lt;/SyntheticProperties&gt;
+  &lt;AuxValues&gt;
+    &lt;AuxValue name=&quot;FormSettings_generateMnemonicsCode&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_listenerGenerationStyle&quot; type=&quot;java.lang.Integer&quot; value=&quot;0&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_variablesLocal&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_variablesModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;2&quot;/&gt;
+  &lt;/AuxValues&gt;
+
+  &lt;Layout&gt;
+    &lt;DimensionLayout dim=&quot;0&quot;&gt;
+      &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+          &lt;Group type=&quot;102&quot; attributes=&quot;0&quot;&gt;
+              &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                  &lt;Component id=&quot;jScrollPane1&quot; alignment=&quot;0&quot; pref=&quot;380&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;question&quot; alignment=&quot;0&quot; pref=&quot;380&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
+                      &lt;Component id=&quot;remember&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;EmptySpace pref=&quot;23&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;update&quot; linkSize=&quot;1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;leave&quot; linkSize=&quot;1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;/Group&gt;
+              &lt;/Group&gt;
+              &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+          &lt;/Group&gt;
+      &lt;/Group&gt;
+    &lt;/DimensionLayout&gt;
+    &lt;DimensionLayout dim=&quot;1&quot;&gt;
+      &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+          &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+              &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;question&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;jScrollPane1&quot; pref=&quot;217&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Group type=&quot;103&quot; groupAlignment=&quot;3&quot; attributes=&quot;0&quot;&gt;
+                  &lt;Component id=&quot;leave&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;update&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;remember&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;/Group&gt;
+              &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+          &lt;/Group&gt;
+      &lt;/Group&gt;
+    &lt;/DimensionLayout&gt;
+  &lt;/Layout&gt;
+  &lt;SubComponents&gt;
+    &lt;Component class=&quot;javax.swing.JLabel&quot; name=&quot;question&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;It does not do to dwell on dreams and forget to live.&quot;/&gt;
+      &lt;/Properties&gt;
+      &lt;AuxValues&gt;
+        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+      &lt;/AuxValues&gt;
+    &lt;/Component&gt;
+    &lt;Container class=&quot;javax.swing.JScrollPane&quot; name=&quot;jScrollPane1&quot;&gt;
+
+      &lt;Layout class=&quot;org.netbeans.modules.form.compat2.layouts.support.JScrollPaneSupportLayout&quot;/&gt;
+      &lt;SubComponents&gt;
+        &lt;Component class=&quot;javax.swing.JTable&quot; name=&quot;recordView&quot;&gt;
+          &lt;Properties&gt;
+            &lt;Property name=&quot;model&quot; type=&quot;javax.swing.table.TableModel&quot; editor=&quot;org.netbeans.modules.form.editors2.TableModelEditor&quot;&gt;
+              &lt;Table columnCount=&quot;0&quot; rowCount=&quot;0&quot;/&gt;
+            &lt;/Property&gt;
+          &lt;/Properties&gt;
+          &lt;AuxValues&gt;
+            &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+          &lt;/AuxValues&gt;
+        &lt;/Component&gt;
+      &lt;/SubComponents&gt;
+    &lt;/Container&gt;
+    &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;leave&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Leave&quot;/&gt;
+      &lt;/Properties&gt;
+      &lt;AuxValues&gt;
+        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+      &lt;/AuxValues&gt;
+    &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;update&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Update&quot;/&gt;
+      &lt;/Properties&gt;
+      &lt;AuxValues&gt;
+        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+      &lt;/AuxValues&gt;
+    &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JCheckBox&quot; name=&quot;remember&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Remember my decision, do not ask again.&quot;/&gt;
+        &lt;Property name=&quot;border&quot; type=&quot;javax.swing.border.Border&quot; editor=&quot;org.netbeans.modules.form.editors2.BorderEditor&quot;&gt;
+          &lt;Border info=&quot;org.netbeans.modules.form.compat2.border.EmptyBorderInfo&quot;&gt;
+            &lt;EmptyBorder bottom=&quot;0&quot; left=&quot;0&quot; right=&quot;0&quot; top=&quot;0&quot;/&gt;
+          &lt;/Border&gt;
+        &lt;/Property&gt;
+        &lt;Property name=&quot;margin&quot; type=&quot;java.awt.Insets&quot; editor=&quot;org.netbeans.beaninfo.editors.InsetsEditor&quot;&gt;
+          &lt;Insets value=&quot;[0, 0, 0, 0]&quot;/&gt;
+        &lt;/Property&gt;
+      &lt;/Properties&gt;
+      &lt;AuxValues&gt;
+        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+      &lt;/AuxValues&gt;
+    &lt;/Component&gt;
+  &lt;/SubComponents&gt;
+&lt;/Form&gt;

Added: trunk/src/net/sf/plantlore/client/imports/DecisionView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/DecisionView.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/DecisionView.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,143 @@
+/*
+ * DecisionView.java
+ *
+ * Created on 9. kv&#283;ten 2006, 22:21
+ */
+
+package net.sf.plantlore.client.imports;
+
+import java.util.Observable;
+import java.util.Observer;
+
+import net.sf.plantlore.common.record.Occurrence;
+import net.sf.plantlore.common.record.Record;
+
+/**
+ *
+ * @author  yaa
+ */
+public class DecisionView extends javax.swing.JFrame implements Observer {
+	
+	ImportMng model;
+
+	
+    /** Creates new form DecisionView */
+    public DecisionView() {
+        initComponents();
+        
+        setLocationRelativeTo(null); // center of the screen
+        this.model.addObserver(this);
+    }
+    
+    /** This method is called from within the constructor to
+     * initialize the form.
+     * WARNING: Do NOT modify this code. The content of this method is
+     * always regenerated by the Form Editor.
+     */
+    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot; Generated Code &quot;&gt;//GEN-BEGIN:initComponents
+    private void initComponents() {
+        question = new javax.swing.JLabel();
+        jScrollPane1 = new javax.swing.JScrollPane();
+        recordView = new javax.swing.JTable();
+        leave = new javax.swing.JButton();
+        update = new javax.swing.JButton();
+        remember = new javax.swing.JCheckBox();
+
+        setTitle(&quot;Decision&quot;);
+        setCursor(new java.awt.Cursor(java.awt.Cursor.DEFAULT_CURSOR));
+        question.setText(&quot;It does not do to dwell on dreams and forget to live.&quot;);
+
+        recordView.setModel(new javax.swing.table.DefaultTableModel(
+            new Object [][] {
+
+            },
+            new String [] {
+
+            }
+        ));
+        jScrollPane1.setViewportView(recordView);
+
+        leave.setText(&quot;Leave&quot;);
+
+        update.setText(&quot;Update&quot;);
+
+        remember.setText(&quot;Remember my decision, do not ask again.&quot;);
+        remember.setBorder(javax.swing.BorderFactory.createEmptyBorder(0, 0, 0, 0));
+        remember.setMargin(new java.awt.Insets(0, 0, 0, 0));
+
+        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());
+        getContentPane().setLayout(layout);
+        layout.setHorizontalGroup(
+            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+            .add(layout.createSequentialGroup()
+                .addContainerGap()
+                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+                    .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 380, Short.MAX_VALUE)
+                    .add(question, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 380, Short.MAX_VALUE)
+                    .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
+                        .add(remember)
+                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, 23, Short.MAX_VALUE)
+                        .add(update)
+                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                        .add(leave)))
+                .addContainerGap())
+        );
+
+        layout.linkSize(new java.awt.Component[] {leave, update}, org.jdesktop.layout.GroupLayout.HORIZONTAL);
+
+        layout.setVerticalGroup(
+            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+            .add(layout.createSequentialGroup()
+                .addContainerGap()
+                .add(question)
+                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 217, Short.MAX_VALUE)
+                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
+                    .add(leave)
+                    .add(update)
+                    .add(remember))
+                .addContainerGap())
+        );
+        pack();
+    }// &lt;/editor-fold&gt;//GEN-END:initComponents
+    
+
+    
+    // Variables declaration - do not modify//GEN-BEGIN:variables
+    private javax.swing.JScrollPane jScrollPane1;
+    protected javax.swing.JButton leave;
+    protected javax.swing.JLabel question;
+    protected javax.swing.JTable recordView;
+    protected javax.swing.JCheckBox remember;
+    protected javax.swing.JButton update;
+    // End of variables declaration//GEN-END:variables
+
+    
+    
+//    private boolean timeIssuesResolved = false, sharedIssuesResolved = false;
+
+    
+	public void update(Observable source, Object parameter) {
+		if(parameter instanceof Record)
+			// The record in the database is newer than the one in the file.
+			if(parameter instanceof Occurrence) {
+				question.setText(&quot;The record in the database is newer than the one from the file.&quot;);
+				recordView.setModel( model.getProcessedRecords() );
+				leave.setText(&quot;Skip&quot;);
+				update.setText(&quot;Update&quot;);
+				remember.setSelected(false);
+				setVisible(true);
+			}
+			// There is a shared record in the database that is to be updated.
+			else {
+				question.setText(&quot;The record that is to be updated is shared.&quot;);
+				recordView.setModel( model.getProblematicRecord() );
+				leave.setText(&quot;Insert new&quot;);
+				update.setText(&quot;Update&quot;);
+				remember.setSelected(false);
+				setVisible(true);
+			}
+	}
+    
+}

Modified: trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/DefaultDirector.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -306,8 +306,8 @@
 					// The record in the database is newer than the record in the file.
 					if(updateInDBOccurred.after(updateInFile)) {
 						logger.debug(&quot;The record in the file is OLDER than the record stored in the database.&quot;);
-//						if( !doNotAskAboutDateAgain ) 
-//							dateDecision = expectDecision( occInDB );
+						if( !doNotAskAboutDateAgain ) 
+							dateDecision = expectDecision( occInDB );
 						
 						if( dateDecision != Action.UPDATE &amp;&amp; dateDecision != Action.INSERT ) 
 							continue;
@@ -709,8 +709,8 @@
 					// This is up to the User.
 					logger.info(&quot;The record &quot;+current+&quot; is shared!&quot;);
 					insertUpdateDecision = lastDecision;
-//					if(!useLastDecision) // ASK THE USER!
-//						insertUpdateDecision = expectDecision( replacement );
+					if(!useLastDecision) // ASK THE USER!
+						insertUpdateDecision = expectDecision( replacement );
 				}
 				else
 					insertUpdateDecision = Action.UPDATE;
@@ -788,8 +788,8 @@
 						} else {
 							// If the shared record is something else, the User's intervention may be needed.
 							insertUpdateDecision = lastDecision;
-//							if(!useLastDecision) 
-//								insertUpdateDecision = expectDecision( replacement );
+							if(!useLastDecision) 
+								insertUpdateDecision = expectDecision( replacement );
 							if(insertUpdateDecision == Action.UPDATE) 
 								// User decided to update (potentially dangerous).
 								db.executeUpdateHistory(current);

Modified: trunk/src/net/sf/plantlore/client/imports/ImportMng.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/ImportMng.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/ImportMng.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -4,9 +4,13 @@
 import java.io.FileReader;
 import java.io.IOException;
 import java.io.Reader;
+import java.util.ArrayList;
 import java.util.Observable;
 import java.util.Observer;
 
+import javax.swing.table.AbstractTableModel;
+import javax.swing.table.TableModel;
+
 import org.apache.log4j.Logger;
 
 import net.sf.plantlore.client.imports.Parser.Action;
@@ -31,6 +35,15 @@
 	private Thread current;
 	
 	
+	/**
+	 * Create a new Import Manager. 
+	 * This manager is primarily intented for import of the occurrence data.
+	 * 
+	 * @param db	The database layer.
+	 * @param user	The User that is currently logged in.
+	 * @param filename	The name of the file where the data reside.
+	 * @throws ImportException	If some of the parameters are not valid.
+	 */
 	public ImportMng(DBLayer db, User user, String filename) 
 	throws ImportException {
 		setDBLayer(db);
@@ -38,14 +51,26 @@
 		setSelectedFile(filename);
 	}
 	
-	
+	/**
+	 * Create a new Import Manager. 
+	 * This manager is primarily intented for import of the occurrence data.
+	 * 
+	 * @param db	The database layer.
+	 * @param user	The User that is currently logged in.
+	 * @throws ImportException	If some of the parameters are not valid.
+	 */
 	public ImportMng(DBLayer db, User user) 
 	throws ImportException {
 		this(db, user, null);
 	}
 	
 	
-	
+	/**
+	 * Set a new database layer.
+	 * 
+	 * @param dblayer	The database layer to be used.
+	 * @throws ImportException	If the parameter is not valid.
+	 */
 	synchronized public void setDBLayer(DBLayer dblayer) 
 	throws ImportException {
 		if(dblayer == null) { 
@@ -55,6 +80,11 @@
 		db = dblayer;
 	}
 	
+	/**
+	 * Set another user.
+	 * @param user	The new User.
+	 * @throws ImportException	If the parameter is not valid.
+	 */
 	synchronized public void setUser(User user) 
 	throws ImportException {
 		if(user == null) { 
@@ -66,8 +96,10 @@
 	
 	
 	/**
-	 * Set the selected file. Into this file the builder will 
-	 * spit its output. 
+	 * Set the selected file. 
+	 * This file contains the data. 
+	 * 
+	 * @param filename
 	 */
 	synchronized public void setSelectedFile(String filename) { 
 		if(filename == null)
@@ -76,19 +108,48 @@
 	}
 	
 	
-	
+	/**
+	 * Make a decision any time the user's intervention is required.
+	 * There are several occasions which need the user's supervision,
+	 * some of them are: 
+	 * &lt;ul&gt;
+	 * &lt;li&gt;when the record contained in the database is newer than the one contained in the file,&lt;/li&gt;
+	 * &lt;li&gt;when a part of the record is shared and the intended operation is update -
+	 * 			this may affect more records&lt;/li&gt;
+	 * &lt;/ul&gt;
+	 * 
+	 * @param decision	The decision the user has made.
+	 */
 	public void makeDecision(Action decision) {
 		if(director != null) 
 			director.makeDecision(decision);
 	}
 	
-	
+	/**
+	 * If the user no longer wants to be bothered with decision-making
+	 * he can instruct the import manager to remember his last decision
+	 * and apply it whenever necessary.
+	 * &lt;br/&gt;
+	 * In this case, the Import Director will always respect the decision
+	 * made when older record should replace a newer.
+	 * 
+	 * @param arg	True if the User should no longer be asked.
+	 */
 	public void setAskAboutTime(boolean arg) {
 		if(director != null) 
 			director.useLastDecisionInTimeIssues(arg);
 	}
 	
-	
+	/**
+	 * If the user no longer wants to be bothered with decision-making
+	 * he can instruct the import manager to remember his last decision
+	 * and apply it whenever necessary.
+	 * &lt;br/&gt;
+	 * In this case, the Import Director will always respect the decision
+	 * that has been made when a shared record is to be updated.
+	 * 
+	 * @param arg	True if the User should no longer be asked.
+	 */
 	public void setAskAboutInsert(boolean arg) {
 		if(director != null) 
 			director.useLastDecisionInUpdateInsertIssues(arg);
@@ -98,7 +159,7 @@
 	 * Start the import procedure. The import will run in its own thread.
 	 * 
 	 * @throws ImportException	If the information provided is not complete.
-	 * @throws IOException	If anything with the file goes wrong (insufficient disk space, insufficient permissions).
+	 * @throws IOException	If anything with the file goes wrong (disk failure, insufficient permissions).
 	 */
 	synchronized public void start() 
 	throws ImportException, IOException {
@@ -128,7 +189,7 @@
 		director = new DefaultDirector(db, parser, user);
 		director.addObserver(this);
 		
-		current = new Thread( director, &quot;Export&quot; );
+		current = new Thread( director, &quot;Import&quot; );
 		if(current == null) {
 			logger.fatal(&quot;Unable to create a new thread.&quot;);
 			throw new ImportException(&quot;Unable to create a new thread.&quot;);
@@ -145,8 +206,8 @@
 					try {
 						current.join();
 						break;
-					}catch(InterruptedException e) {} // FIXME: join the thread again
-				// Dispose of the writer.
+					}catch(InterruptedException e) {} 
+				// Dispose of the reader.
 				try {
 					reader.close();
 				}catch(IOException e) {}
@@ -159,12 +220,11 @@
 		monitor.start();
 	}
 	
-	
+	/** Something that will not be true for a long time, at least the mankind hopes so. */
 	private boolean universeImploded = false;
 
 	/**
-	 * Abort the current export. You &lt;b&gt;must call&lt;/b&gt; &lt;code&gt;finish()&lt;/code&gt; 
-	 * after calling &lt;code&gt;abort()&lt;/code&gt;. 
+	 * Abort the current import. 
 	 */
 	synchronized public void abort() {
 		if(!importInProgress) return;
@@ -189,7 +249,7 @@
 	
 	
 	/**
-	 * @return The number of results that have already been exported.
+	 * @return The number of results that have already been imported into the database.
 	 */
 	public int getNumberOfImported() {
 		if(director == null) return 0;
@@ -197,20 +257,27 @@
 	}
 	
 	
-	public Record getProcessedRecordFromFile() {
-		return (director == null) ? null : director.getProcessedRecordFromFile();
+	/**
+	 * 
+	 * @return	The record that is currently loaded from the database
+	 * and the record loaded from the file.
+	 */
+	public TableModel getProcessedRecords() {
+		return (director == null) ? null : 
+			new RecordTable(
+					director.getProcessedRecordInDatabase(), 
+					director.getProcessedRecordFromFile());
 	}
 	
-	
-	public Record getProcessedRecordInDatabase() {
-		return (director == null) ? null : director.getProcessedRecordInDatabase();
+	/**
+	 * 
+	 * @return	The record that caused problems (exceptions).
+	 */
+	public TableModel getProblematicRecord() {
+		return (director == null) ? null : new RecordTable( director.getProblematic() );
 	}
 	
-	public Record getProblematicRecord() {
-		return (director == null) ? null : director.getProblematic();
-	}
 	
-	
 	/**
 	 * Notify the observers - some of our components has changed its state.
 	 * The parameter can carry either information about progress
@@ -219,6 +286,83 @@
 	public void update(Observable source, Object parameter) {
 		setChanged(); notifyObservers( parameter );
 	}
+	
+	
+	private class RecordTable extends AbstractTableModel {
+		
+		ArrayList&lt;String&gt;[] value;
+		String[] columnNames;
+			
+		
+		/**
+		 * Display the record and all its properties
+		 * so that the user can see the problem.
+		 * 
+		 * @param record
+		 */
+		public RecordTable(Record record) {
+			value = new ArrayList[2];
+			value[0] = new ArrayList&lt;String&gt;(20);
+			value[1] = new ArrayList&lt;String&gt;(20);
+			columnNames = new String[] { &quot;Property&quot;, &quot;Value&quot; };
+			traverse(record);
+		}
+		
+		/**
+		 * Display the records and all their properties
+		 * so that the user can compare them.
+		 * 
+		 * @param a	The first record (the record in the database).
+		 * @param b	The second record (the record in the file).
+		 */
+		public RecordTable(Record a, Record b) {
+			value = new ArrayList[3];
+			value[0] = new ArrayList&lt;String&gt;(20);
+			value[1] = new ArrayList&lt;String&gt;(20);
+			value[2] = new ArrayList&lt;String&gt;(20);
+			columnNames = new String[] { &quot;Property&quot;, &quot;Value (in DB)&quot;, &quot;Value (in file)&quot; };
+			traverse(a, b);
+		}
+		
+		
+		private void traverse(Record...r) {
+			int n;
+			if(r[0] != null) n = 0; else if(r.length &gt;= 2 &amp;&amp; r[1] != null) n = 1;
+			else return;
+			Class table = r[n].getClass(); 
+				
+			for( String property : r[n].getProperties()) {
+				value[0].add(table.getSimpleName()+&quot;.&quot;+property);
+				for(int i = 0; i &lt; r.length; i++) { 
+					Object v = (r[i] == null) ? null : r[i].getValue(property);
+					value[i].add( (v == null) ? &quot;&quot; : v.toString() );
+				}
+			}
+			for( String key : r[n].getForeignKeys() )
+				if(r.length == 1)
+					traverse((Record)r[0].getValue(key));
+				else
+					traverse((Record)r[0].getValue(key), (Record)r[1].getValue(key));
+		}
+		
 
+		public int getRowCount() {
+			return columnNames.length;
+		}
 
+		public int getColumnCount() {
+			return value.length;
+		}
+		
+		public String getColumnName(int column) {
+			return columnNames[column];
+		}
+
+		public Object getValueAt(int row, int column) {
+			return value[column].get(row);
+		}
+		
+	}
+
+
 }

Added: trunk/src/net/sf/plantlore/client/imports/ImportMngCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/ImportMngCtrl.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/ImportMngCtrl.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,46 @@
+package net.sf.plantlore.client.imports;
+
+import javax.swing.JFileChooser;
+import javax.swing.JOptionPane;
+
+
+public class ImportMngCtrl {
+	
+	private ImportMng model;
+	private ImportMngView view;
+	
+	private ImportProgressView  progressView;
+	
+	public ImportMngCtrl(ImportMng model, ImportMngView view, ImportProgressView progressView) {
+		this.model = model; this.view = view; this.progressView = progressView;
+	}
+	
+	public void setVisible(boolean visible) {
+		if(visible) {
+			int result = view.choice.showDialog(null, &quot;Import&quot;);
+			if( result == JFileChooser.APPROVE_OPTION ) {
+				
+				if(view.choice.getSelectedFile() == null) {
+					JOptionPane.showMessageDialog(null,
+							&quot;You must insert a name!&quot;,
+						    &quot;Nothing selected...&quot;,
+						    JOptionPane.WARNING_MESSAGE);
+					return;
+				}
+				
+				model.setSelectedFile( view.choice.getSelectedFile().getAbsolutePath() );
+				try {
+					model.start();
+					progressView.setVisible(true);
+				} catch(Exception e) {
+					JOptionPane.showMessageDialog(null,
+							&quot;Unable to start the import procedure!\n&quot; + e,
+							&quot;Import failed...&quot;,
+							JOptionPane.WARNING_MESSAGE);
+				}
+			}
+		}
+	}
+
+
+}

Added: trunk/src/net/sf/plantlore/client/imports/ImportMngView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/ImportMngView.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/ImportMngView.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,24 @@
+package net.sf.plantlore.client.imports;
+
+import javax.swing.JFileChooser;
+
+
+public class ImportMngView {
+	
+	private ImportMng model;
+	protected JFileChooser choice;
+	
+	
+	public ImportMngView(ImportMng model) {
+		this.model = model;
+		initComponents();
+	}
+	
+	
+	private void initComponents() {
+		choice = new JFileChooser();
+	}
+	
+	
+	
+}

Added: trunk/src/net/sf/plantlore/client/imports/ImportProgressCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/ImportProgressCtrl.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/ImportProgressCtrl.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,44 @@
+package net.sf.plantlore.client.imports;
+
+import java.awt.event.ActionEvent;
+
+import javax.swing.AbstractAction;
+import javax.swing.JOptionPane;
+
+
+public class ImportProgressCtrl {
+	
+	
+	private ImportMng model;
+	private ImportProgressView view;
+	
+		
+	
+	public ImportProgressCtrl(ImportMng model, ImportProgressView view) {
+		this.model = model; this.view = view;
+		view.abort.addActionListener( new Abort() );
+	}
+	
+	class Abort extends AbstractAction {
+		public void actionPerformed(ActionEvent arg0) {
+			if(model.isImportInProgress()) {
+				int response =
+					JOptionPane.showOptionDialog(view,
+							&quot;The import procedure will be aborted.&quot;,
+							&quot;Abort import&quot;,
+							JOptionPane.OK_CANCEL_OPTION,
+							JOptionPane.WARNING_MESSAGE,
+							null,
+							null,
+							null);
+				if(response == JOptionPane.OK_OPTION) {
+					model.abort();
+				}
+			}
+			else
+				view.setVisible(false);
+		}
+	}
+	
+
+}

Added: trunk/src/net/sf/plantlore/client/imports/ImportProgressView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/imports/ImportProgressView.java	2006-05-09 21:22:17 UTC (rev 251)
+++ trunk/src/net/sf/plantlore/client/imports/ImportProgressView.java	2006-05-09 21:33:00 UTC (rev 252)
@@ -0,0 +1,93 @@
+package net.sf.plantlore.client.imports;
+
+import java.util.Observable;
+import java.util.Observer;
+
+
+
+public class ImportProgressView  extends javax.swing.JFrame implements Observer {
+
+	private ImportMng model;
+	private int count = 0;
+    
+    /** Creates new form ExportProgressView */
+    public ImportProgressView(ImportMng model) {
+    	this.model = model;
+        initComponents();
+        setLocationRelativeTo(null); // center of the screen
+        
+        this.model.addObserver(this);
+    }
+    
+    /** This method is called from within the constructor to
+     * initialize the form.
+     * WARNING: Do NOT modify this code. The content of this method is
+     * always regenerated by the Form Editor.
+     */
+    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot; Generated Code &quot;&gt;//GEN-BEGIN:initComponents
+    private void initComponents() {
+        status = new javax.swing.JLabel();
+        progress = new javax.swing.JProgressBar();
+        abort = new javax.swing.JButton();
+
+        setDefaultCloseOperation(javax.swing.WindowConstants.HIDE_ON_CLOSE);
+        status.setText(&quot;Erised stra ehru oyt ube cafru oyt on wohsi&quot;);
+        status.setVerticalAlignment(javax.swing.SwingConstants.TOP);
+
+        abort.setText(&quot;Abort&quot;);
+        
+        progress.setMinimum(0);
+
+        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());
+        getContentPane().setLayout(layout);
+        layout.setHorizontalGroup(
+            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+            .add(layout.createSequentialGroup()
+                .addContainerGap()
+                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+                    .add(progress, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 380, Short.MAX_VALUE)
+                    .add(status, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 380, Short.MAX_VALUE)
+                    .add(org.jdesktop.layout.GroupLayout.TRAILING, abort))
+                .addContainerGap())
+        );
+        layout.setVerticalGroup(
+            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+            .add(layout.createSequentialGroup()
+                .addContainerGap()
+                .add(status, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 84, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                .add(progress, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
+                .add(abort)
+                .addContainerGap())
+        );
+        pack();
+    }// &lt;/editor-fold&gt;//GEN-END:initComponents
+    
+    
+    
+    // Variables declaration - do not modify//GEN-BEGIN:variables
+    protected javax.swing.JButton abort;
+    protected javax.swing.JProgressBar progress;
+    protected javax.swing.JLabel status;
+    // End of variables declaration//GEN-END:variables
+    
+    
+    @Override
+    public void setVisible(boolean visible) {
+    	status.setText(&quot;Initializing...&quot;);
+   		progress.setIndeterminate(true);
+   		progress.setStringPainted(false);
+    	abort.setText(&quot;Abort&quot;);
+    	super.setVisible(visible);
+    	update(null, null);
+    }
+	
+	
+	
+	
+	public void update(Observable arg0, Object arg1) {
+		count = model.getNumberOfImported();
+	}
+
+}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000298.html">[Plantlore-dev] r251 - trunk/analysis/database
</A></li>
	<LI>Next message: <A HREF="000296.html">[Plantlore-dev] r253 - in trunk/src/net/sf/plantlore: client/history client/metadata client/publication client/user l10n
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#297">[ date ]</a>
              <a href="thread.html#297">[ thread ]</a>
              <a href="subject.html#297">[ subject ]</a>
              <a href="author.html#297">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plantlore-dev">More information about the Plantlore-dev
mailing list</a><br>
</body></html>
