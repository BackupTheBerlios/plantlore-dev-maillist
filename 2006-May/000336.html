<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plantlore-dev] r284 - trunk/src/net/sf/plantlore/client
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plantlore-dev/2006-May/index.html" >
   <LINK REL="made" HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r284%20-%20trunk/src/net/sf/plantlore/client&In-Reply-To=%3C200605161801.k4GI1oEe026832%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000335.html">
   <LINK REL="Next"  HREF="000337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plantlore-dev] r284 - trunk/src/net/sf/plantlore/client</H1>
    <B>fraktalek at berlios.de</B> 
    <A HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r284%20-%20trunk/src/net/sf/plantlore/client&In-Reply-To=%3C200605161801.k4GI1oEe026832%40sheep.berlios.de%3E"
       TITLE="[Plantlore-dev] r284 - trunk/src/net/sf/plantlore/client">fraktalek at berlios.de
       </A><BR>
    <I>Tue May 16 20:01:50 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000335.html">[Plantlore-dev] r283 - trunk/src/net/sf/plantlore/l10n
</A></li>
        <LI>Next message: <A HREF="000337.html">[Plantlore-dev] r285 - in trunk/src/net/sf/plantlore/client: checklist resources
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#336">[ date ]</a>
              <a href="thread.html#336">[ thread ]</a>
              <a href="subject.html#336">[ subject ]</a>
              <a href="author.html#336">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fraktalek
Date: 2006-05-16 20:01:09 +0200 (Tue, 16 May 2006)
New Revision: 284

Added:
   trunk/src/net/sf/plantlore/client/TableSorter.java
Modified:
   trunk/src/net/sf/plantlore/client/AddEditView.form
   trunk/src/net/sf/plantlore/client/AddEditView.java
   trunk/src/net/sf/plantlore/client/AppCore.java
   trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
   trunk/src/net/sf/plantlore/client/AppCoreView.java
   trunk/src/net/sf/plantlore/client/Column.java
   trunk/src/net/sf/plantlore/client/MainConfig.java
   trunk/src/net/sf/plantlore/client/OverviewTableModel.java
   trunk/src/net/sf/plantlore/client/Search.java
   trunk/src/net/sf/plantlore/client/SearchView.form
   trunk/src/net/sf/plantlore/client/SearchView.java
   trunk/src/net/sf/plantlore/client/Settings.java
   trunk/src/net/sf/plantlore/client/SettingsCtrl.java
   trunk/src/net/sf/plantlore/client/SettingsView.form
   trunk/src/net/sf/plantlore/client/SettingsView.java
Log:
Lots of changes. Overview and menu now use L10n a little more. Export is now bound, Search creates exportQuery and SearchBridge stores it to AppCore model.
Columns are now transferred as ArrayList instead of simple array. AddEditView fixed a little, SearchView as well. Overview now uses TableSorter to sort visible rows (i.e. not all data in the result). 
Columns tab in Settings implemented. Column choosing now works. Columns are also stored to and loaded from the main config.
Also fixed handling of possible null values returned by Hibernate by implementing Column.getDefaultNullValue() and fixing OverviewTableModel.loadData().
First column of data variable in OverviewTableModel is now always Occurrence.Id and is not shown.
Choosing of Occurrence.ID is disallowed.



Modified: trunk/src/net/sf/plantlore/client/AddEditView.form
===================================================================
--- trunk/src/net/sf/plantlore/client/AddEditView.form	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/AddEditView.form	2006-05-16 18:01:09 UTC (rev 284)
@@ -182,7 +182,7 @@
                 &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
               &lt;/Properties&gt;
               &lt;AuxValues&gt;
-                &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;descriptionArea.setLineWrap(true);&quot;/&gt;
+                &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;descriptionArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(descriptionArea);&quot;/&gt;
                 &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
               &lt;/AuxValues&gt;
             &lt;/Component&gt;
@@ -810,7 +810,7 @@
                     &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
                   &lt;/Properties&gt;
                   &lt;AuxValues&gt;
-                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;locationNoteArea.setLineWrap(true);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;locationNoteArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(locationNoteArea);&quot;/&gt;
                     &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
                   &lt;/AuxValues&gt;
                 &lt;/Component&gt;
@@ -1077,7 +1077,7 @@
                     &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
                   &lt;/Properties&gt;
                   &lt;AuxValues&gt;
-                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;occurrenceNoteArea.setLineWrap(true);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;occurrenceNoteArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(occurrenceNoteArea);&quot;/&gt;
                     &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
                   &lt;/AuxValues&gt;
                 &lt;/Component&gt;

Modified: trunk/src/net/sf/plantlore/client/AddEditView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AddEditView.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/AddEditView.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -161,6 +161,7 @@
         descriptionArea.setColumns(20);
         descriptionArea.setRows(5);
         descriptionArea.setLineWrap(true);
+        new TabTransfersFocus(descriptionArea);
         jScrollPane2.setViewportView(descriptionArea);
 
         taxonTextArea.setColumns(20);
@@ -460,6 +461,7 @@
         locationNoteArea.setColumns(20);
         locationNoteArea.setRows(5);
         locationNoteArea.setLineWrap(true);
+        new TabTransfersFocus(locationNoteArea);
         jScrollPane4.setViewportView(locationNoteArea);
 
         org.jdesktop.layout.GroupLayout jPanel7Layout = new org.jdesktop.layout.GroupLayout(jPanel7);
@@ -573,6 +575,7 @@
         occurrenceNoteArea.setColumns(20);
         occurrenceNoteArea.setRows(5);
         occurrenceNoteArea.setLineWrap(true);
+        new TabTransfersFocus(occurrenceNoteArea);
         jScrollPane5.setViewportView(occurrenceNoteArea);
 
         org.jdesktop.layout.GroupLayout jPanel9Layout = new org.jdesktop.layout.GroupLayout(jPanel9);

Modified: trunk/src/net/sf/plantlore/client/AppCore.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCore.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/AppCore.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -13,6 +13,7 @@
 import java.util.Hashtable;
 import java.util.Observable;
 import java.util.prefs.Preferences;
+import javax.swing.table.TableModel;
 import net.sf.plantlore.client.login.DBInfo;
 import net.sf.plantlore.common.Pair;
 import net.sf.plantlore.common.PlantloreConstants;
@@ -49,8 +50,11 @@
     private DBLayer database;  
     private Right accessRights;
     private OverviewTableModel tableModel;
+    private TableSorter tableSorter;
     private Logger logger;
 
+    private SelectQuery exportQuery = null;
+    
     private int selectedRow = 0;
     
     /** data for dialogs */
@@ -190,12 +194,13 @@
             return 0;
     }
 
-    public void setRecordsPerPage(int recordsPerPage) {
+    public void setRecordsPerPage(int recordsPerPage) {        
         if (tableModel != null)
         {
+            logger.info(&quot;Setting records per page to &quot;+recordsPerPage);
             tableModel.setPageSize(recordsPerPage);
             setChanged();
-            notifyObservers();        
+            notifyObservers(&quot;RECORDS_PER_PAGE&quot;);        
         }
     }
 
@@ -278,8 +283,9 @@
     }
     
     public Integer getSelectedOccurrence() {
-        Object[] row = tableModel.getRow(selectedRow);
-        return (Integer)row[row.length-1];
+        //Object[] row = tableModel.getRow(selectedRow);
+        //return (Integer)row[row.length-1];
+        return tableModel.getOccurrenceId(selectedRow);
     }
     
     public void savePreferences() throws IOException {
@@ -294,6 +300,14 @@
         notifyObservers(&quot;NEW_QUERY&quot;);
     }
 
+    public void setExportQuery(SelectQuery query) {
+        this.exportQuery = query;
+    }
+    
+    public SelectQuery getExportQuery() {
+        return exportQuery;
+    }
+    
     public Pair&lt;String, Integer&gt;[] getPlants() {
         if (plants == null)
         {

Modified: trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -17,6 +17,7 @@
 import java.io.IOException;
 import java.lang.Integer;
 import java.rmi.RemoteException;
+import java.util.ArrayList;
 import java.util.Observable;
 import java.util.Observer;
 import java.util.prefs.Preferences;
@@ -75,6 +76,8 @@
 public class AppCoreCtrl
 {
     Logger logger;
+    Preferences prefs;
+    private final static int MAX_RECORDS_PER_PAGE = 1000;
     //--------------SUPPLIED MODELS AND VIEWS-----------------
     AppCore model;
     AppCoreView view;
@@ -94,7 +97,6 @@
     Settings settingsModel;
     SettingsView settingsView;
     SettingsCtrl settingsCtrl;
-    Preferences prefs;    
     
     // History of one occurrence
     History historyModel;
@@ -138,9 +140,10 @@
     public AppCoreCtrl(AppCore model, AppCoreView view)
     {
         logger = Logger.getLogger(this.getClass().getPackage().getName());
+        prefs = Preferences.userNodeForPackage(this.getClass());
+
         this.model = model;
         this.view = view;
-        prefs = Preferences.userNodeForPackage(AppCoreView.class);
         view.setSettingsAction(new SettingsAction());
         view.setPrintAction(new PrintAction());
         view.addExitListener(new ExitListener());
@@ -191,17 +194,42 @@
         {
             logger.info(&quot;Settings selected&quot;);
             //If the dialog is already constructed then use it. Otherwise construct it first.
-            //if (settingsModel == null) {
+            if (settingsModel == null) {
                 settingsModel = new Settings();
+                settingsModel.setSelectedColumns(model.getTableModel().getColumns());
+                settingsModel.addObserver(new SettingsBridge());
                 settingsView = new SettingsView(view,true,settingsModel);
                 settingsCtrl = new SettingsCtrl(settingsModel, settingsView);
-                settingsView.setVisible(true);
-            /*} else {
-                settingsView.setVisible(true);
-            }*/
+            } 
+            //settingsView.loadValues();
+            settingsView.setVisible(true);
         }
     }
     
+    /** Assumes that user doesn't work with the Search dialog at time of the update.
+     *
+     */
+    class SettingsBridge implements Observer {
+        Search sm = new Search(model.getDatabase());
+        
+        public void update(Observable o, Object arg) {
+            System.out.println(&quot;Settings bridge update&quot;);
+            if (arg instanceof String) {                
+                String s = (String)arg;
+                System.out.println(&quot;got command : &quot;+s);
+                if (s.equals(&quot;COLUMNS&quot;)) {
+                    ArrayList&lt;Column&gt; columns = settingsModel.getSelectedColumns();
+                    model.getTableModel().setColumns(columns);
+                    model.getMainConfig().setColumns(columns);
+                    
+                    sm.setColumns(columns);
+                    sm.constructQuery();
+                    model.setResultId(sm.getNewResultId());
+                }
+            }
+        }        
+    }
+    
     class PrintAction extends AbstractAction {
         public PrintAction() {
             putValue(NAME, L10n.getString(&quot;Print&quot;));
@@ -312,6 +340,20 @@
             if(exportView == null) {
             	try {
             		exportModel = new ExportMng(model.getDatabase());
+                        //FIXME:
+                    try {
+                        exportModel.setSelectQuery(model.getExportQuery());
+                    } catch (RemoteException ex) {
+                        JOptionPane.showMessageDialog(view,&quot;Some remote error: &quot;+ex);
+                        return;
+                    } catch (DBLayerException ex) {
+                        JOptionPane.showMessageDialog(view,&quot;Some database error: &quot;+ex);
+                        return;
+                    } catch (ExportException ex) {
+                        JOptionPane.showMessageDialog(view,&quot;Some export error: &quot;+ex);
+                        return;
+                    }
+                        exportModel.setSelection(model.getTableModel().getSelection());
             		exportProgressView = new ExportProgressView(exportModel);
             		exportProgressCtrl = new ExportProgressCtrl(exportModel, exportProgressView);
             		exportView = new ExportMngViewA(exportModel);
@@ -458,7 +500,7 @@
         public void actionPerformed(ActionEvent actionEvent) {
             if (searchModel == null) {
                 searchModel = new Search(model.getDatabase());
-                searchModel.setColumns(model.getTableModel().getColumns().clone());
+                searchModel.setColumns(model.getTableModel().getColumns());
                 searchModel.setAuthors(model.getAuthors());
                 searchModel.setAuthorRoles(model.getAuthorRoles());
                 searchModel.setPlants(model.getPlants());
@@ -487,6 +529,7 @@
             if (arg != null &amp;&amp; arg instanceof Integer) {
                 logger.debug(&quot;Fetching new result id from Search model. Storing it to AppCore model.&quot;);
                 model.setResultId(searchModel.getNewResultId());
+                model.setExportQuery(searchModel.getExportQuery());
             }
         }
         
@@ -625,6 +668,16 @@
             if (e != null &amp;&amp; e.getPropertyName().equals(&quot;value&quot;)) 
             {
                 int i = ((Number)tf.getValue()).intValue(); 
+                if (i &gt; MAX_RECORDS_PER_PAGE) {
+                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Overview.Warning.MaxRecordsPerPage&quot;)+&quot; &quot;+MAX_RECORDS_PER_PAGE);
+                    Object obj = e.getOldValue();
+                    if (obj != null)
+                        tf.setValue(obj);
+                    else // either multiple properties changed or there was no previous value - the value should better be at least 1 anyway...
+                        tf.setValue(prefs.getInt(&quot;recordsPerPage&quot;, 30));
+                    return;
+                }
+                
                 if (i &lt; 1)
                 {
                     Object obj = e.getOldValue();

Modified: trunk/src/net/sf/plantlore/client/AppCoreView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCoreView.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/AppCoreView.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -17,6 +17,7 @@
 import java.awt.event.WindowAdapter;
 import java.beans.PropertyChangeListener;
 import java.text.NumberFormat;
+import java.util.ArrayList;
 import java.util.Observable;
 import java.util.Observer;
 import java.util.prefs.Preferences;
@@ -40,10 +41,12 @@
 import javax.swing.border.BevelBorder;
 import javax.swing.event.ListSelectionListener;
 import javax.swing.table.TableColumn;
+import javax.swing.table.TableModel;
 import net.sf.plantlore.common.ComponentAdjust;
 import net.sf.plantlore.common.StatusBarManager;
 
 import net.sf.plantlore.l10n.L10n;
+import org.apache.log4j.Logger;
 
 /** Application core view
  *
@@ -56,6 +59,7 @@
  */
 public class AppCoreView extends JFrame implements Observer 
 {
+    private Logger logger;
     private Preferences prefs;
     private AppCore model;
     //private JFrame frame;
@@ -63,24 +67,24 @@
     private JPanel mainPane;
     private JMenuBar menuBar = new JMenuBar();
     private JMenu
-            fileMenu = new JMenu(L10n.getString(&quot;File&quot;)),
-            dataMenu = new JMenu(L10n.getString(&quot;Data&quot;)),
-            helpMenu = new JMenu(L10n.getString(&quot;Help&quot;)); 
-    private JMenuItem settings = new JMenuItem(L10n.getString(&quot;Settings&quot;));
-    private JMenuItem print = new JMenuItem(L10n.getString(&quot;Print&quot;));
-    private JMenuItem exit = new JMenuItem(L10n.getString(&quot;Exit&quot;));
-    private JMenuItem helpContents = new JMenuItem(L10n.getString(&quot;helpContents&quot;));
-    private JMenuItem helpAbout = new JMenuItem(L10n.getString(&quot;helpAbout&quot;));
-    private JMenuItem dataAuthors = new JMenuItem(L10n.getString(&quot;authorMgr&quot;));
-    private JMenuItem dataPublications = new JMenuItem(L10n.getString(&quot;publicationMgr&quot;)); 
-    private JMenuItem dataUser = new JMenuItem(L10n.getString(&quot;UserManager&quot;));
-    private JMenuItem dataMetadata = new JMenuItem(L10n.getString(&quot;metadataManager&quot;));
-    private JMenuItem dataHistory = new JMenuItem(L10n.getString(&quot;History&quot;));
-    private JMenuItem dataWholeHistory = new JMenuItem(L10n.getString(&quot;wholeHistory&quot;));
-    private JMenuItem dataImport = new JMenuItem(L10n.getString(&quot;dataImport&quot;));
-    private JMenuItem dataExport = new JMenuItem(L10n.getString(&quot;dataExport&quot;));
-    private JMenuItem dataSearch = new JMenuItem(L10n.getString(&quot;dataSearch&quot;));
-    private JMenuItem login = new JMenuItem(L10n.getString(&quot;Login&quot;));
+            fileMenu = new JMenu(L10n.getString(&quot;Overview.MenuFile&quot;)),
+            dataMenu = new JMenu(L10n.getString(&quot;Overview.MenuData&quot;)),
+            helpMenu = new JMenu(L10n.getString(&quot;Overview.MenuHelp&quot;)); 
+    private JMenuItem settings = new JMenuItem(L10n.getString(&quot;Overview.MenuSettings&quot;));
+    private JMenuItem print = new JMenuItem(L10n.getString(&quot;Overview.MenuPrint&quot;));
+    private JMenuItem exit = new JMenuItem(L10n.getString(&quot;Overview.MenuExit&quot;));
+    private JMenuItem helpContents = new JMenuItem(L10n.getString(&quot;Overview.MenuHelpContents&quot;));
+    private JMenuItem helpAbout = new JMenuItem(L10n.getString(&quot;Overview.MenuHelpAbout&quot;));
+    private JMenuItem dataAuthors = new JMenuItem(L10n.getString(&quot;Overview.MenuAuthorManager&quot;));
+    private JMenuItem dataPublications = new JMenuItem(L10n.getString(&quot;Overview.MenuPublicationManager&quot;)); 
+    private JMenuItem dataUser = new JMenuItem(L10n.getString(&quot;Overview.MenuUserManager&quot;));
+    private JMenuItem dataMetadata = new JMenuItem(L10n.getString(&quot;Overview.MenuMetadataManager&quot;));
+    private JMenuItem dataHistory = new JMenuItem(L10n.getString(&quot;Overview.MenuHistory&quot;));
+    private JMenuItem dataWholeHistory = new JMenuItem(L10n.getString(&quot;Overview.MenuwholeHistory&quot;));
+    private JMenuItem dataImport = new JMenuItem(L10n.getString(&quot;Overview.MenuDataImport&quot;));
+    private JMenuItem dataExport = new JMenuItem(L10n.getString(&quot;Overview.MenuDataExport&quot;));
+    private JMenuItem dataSearch = new JMenuItem(L10n.getString(&quot;Overview.MenuDataSearch&quot;));
+    private JMenuItem login = new JMenuItem(L10n.getString(&quot;Overview.MenuLogin&quot;));
     
     private JButton 
             importButton = new JButton(),
@@ -109,6 +113,7 @@
     /** Creates a new instance of AppCoreView */
     public AppCoreView(AppCore model)
     {
+        logger = Logger.getLogger(this.getClass().getPackage().getName());                
         this.model = model;
         model.addObserver(this); 
         prefs = Preferences.userNodeForPackage(this.getClass());
@@ -118,7 +123,7 @@
     {
         if (object != null &amp;&amp; object instanceof String) {
             String arg = (String) object;
-            if (arg.equals(&quot;PAGE_CHANGED&quot;)) {
+            if (arg.equals(&quot;PAGE_CHANGED&quot;)||arg.equals(&quot;RECORDS_PER_PAGE&quot;)) {
                 recordsCount.setText(&quot;&quot;+model.getResultsCount());
                 pageStatus.setText(&quot;&quot;+model.getCurrentPage()+&quot;/&quot;+model.getPagesCount());
                 //FIXME: change selection only if really required
@@ -166,14 +171,14 @@
      */
     private void initMenu()
     {
-        fileMenu.setMnemonic(L10n.getMnemonic(&quot;File&quot;));
+        fileMenu.setMnemonic(L10n.getMnemonic(&quot;Overview.MenuFile&quot;));
         fileMenu.add(login);
         fileMenu.add(settings);
         fileMenu.add(print);
         fileMenu.addSeparator();
         fileMenu.add(exit);
         
-        dataMenu.setMnemonic(L10n.getMnemonic(&quot;Data&quot;));
+        dataMenu.setMnemonic(L10n.getMnemonic(&quot;Overview.MenuData&quot;));
         dataMenu.add(dataAuthors);
         dataMenu.add(dataPublications);  
         dataMenu.add(dataMetadata);
@@ -184,7 +189,7 @@
         dataMenu.add(dataWholeHistory); 
         dataMenu.add(dataUser);
 
-        helpMenu.setMnemonic(L10n.getMnemonic(&quot;Help&quot;));
+        helpMenu.setMnemonic(L10n.getMnemonic(&quot;Overview.MenuHelp&quot;));
         helpMenu.add(helpContents);
         helpMenu.addSeparator();
         helpMenu.add(helpAbout);
@@ -207,7 +212,7 @@
         mainToolBar.add(searchButton);
         container.add(mainToolBar, BorderLayout.NORTH);
         
-        sbm.add(searchButton, &quot;Search for records&quot;);
+        sbm.add(searchButton, L10n.getString(&quot;Overview.SearchTT&quot;));
     }
     
     /** Constructs the main status bar and initializes the &lt;code&gt;sbm StatusBarManager&lt;/code&gt; appropriately.
@@ -280,9 +285,9 @@
         ca.add(invertSelected);
         ca.setMaxWidth();
         
-        sbm.add(prevPage, &quot;Previous page&quot;);
-        sbm.add(nextPage, &quot;Next page&quot;);
-        sbm.add(recordsPerPage, &quot;Number of records per page&quot;);
+        sbm.add(prevPage, L10n.getString(&quot;Overview.PreviousPage&quot;));
+        sbm.add(nextPage, L10n.getString(&quot;Overview.NextPage&quot;));
+        sbm.add(recordsPerPage, L10n.getString(&quot;Overview.RecordsPerPage&quot;));
     }
     
     /** This method should be called right after the user logs into some database.
@@ -292,8 +297,10 @@
     {
         TableColumn tc;
         OverviewTableModel otm = model.getTableModel();
+        TableSorter tableSorter = new TableSorter(otm);
         //FIXME: what if otm == null ????????????
-        overview.setModel(otm);
+        overview.setModel(tableSorter);
+        tableSorter.setTableHeader(overview.getTableHeader());
         
         // Comment to established db connection automatically without the login procedure        
         overviewScrollPane.setPreferredSize(new Dimension(800, (otm.getRowCount()+1)*25));
@@ -304,6 +311,16 @@
         }
         recordsPerPage.setValue(new Integer(model.getRecordsPerPage()));        
         pack();
+        
+        ArrayList&lt;Column&gt; columns = model.getMainConfig().getColumns();
+        if (columns.size() &gt; 1) {
+            logger.debug(&quot;Restoring columns loaded from the main config.&quot;);
+            Search search = new Search(model.getDatabase());
+            search.setColumns(columns);
+            search.constructQuery();
+            model.getTableModel().setColumns(columns);
+            model.setResultId(search.getNewResultId());
+        }
     }
     
     /** Returns the main window &lt;code&gt;StatusBarManager&lt;/code&gt;.

Modified: trunk/src/net/sf/plantlore/client/Column.java
===================================================================
--- trunk/src/net/sf/plantlore/client/Column.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/Column.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -11,6 +11,7 @@
 
 import java.util.Date;
 import net.sf.plantlore.l10n.L10n;
+import org.apache.log4j.Logger;
 
 /**
  *
@@ -22,6 +23,13 @@
     public String l10nKey;
     public Class columnClass;
     
+    private Logger logger;
+    private String nullString = &quot;&quot;;
+    private Integer nullInteger = -1;
+    private Double nullDouble = new Double(-1);
+    private Date nullDate = new Date(0);
+    private Boolean nullBoolean = false;
+    
     public enum Type {SELECTION,
     NUMBER,
     PLANT_TAXON,
@@ -50,136 +58,137 @@
     
     /** Creates a new instance of Column */
     public Column(Type type) {
+        logger = Logger.getLogger(this.getClass().getPackage().getName());        
         this.type = type;
         switch (type) {
             case AUTHOR:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColAuthor&quot;;
+                l10nKey = &quot;Overview.ColumnAuthor&quot;;
                 columnClass = String.class;
                 break;
             case HABITAT_ALTITUDE:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColAltitude&quot;;
+                l10nKey = &quot;Overview.ColumnAltitude&quot;;
                 columnClass = Double.class;
                 break;
             case HABITAT_COUNTRY:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColCountry&quot;;
+                l10nKey = &quot;Overview.ColumnCountry&quot;;
                 columnClass = String.class;
                 break;
             case HABITAT_DESCRIPTION:
                 preferredSize = 150;
-                l10nKey = &quot;overviewColPlace&quot;;
+                l10nKey = &quot;Overview.ColumnPlace&quot;;
                 columnClass = String.class;
                 break;
             case HABITAT_LATITUDE:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColLatitude&quot;;
+                l10nKey = &quot;Overview.ColumnLatitude&quot;;
                 columnClass = Double.class;
                 break;
             case HABITAT_LONGITUDE:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColLongitude&quot;;
+                l10nKey = &quot;Overview.ColumnLongitude&quot;;
                 columnClass = Double.class;
                 break;
             case HABITAT_NEAREST_VILLAGE_NAME:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColVillage&quot;;
+                l10nKey = &quot;Overview.ColumnVillage&quot;;
                 columnClass = String.class;
                 break;
             case HABITAT_NOTE:
                 preferredSize = 150;
-                l10nKey = &quot;overviewColLocNote&quot;;
+                l10nKey = &quot;Overview.ColumnLocNote&quot;;
                 columnClass = String.class;
                 break;
             case HABITAT_QUADRANT:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColQuadrant&quot;;
+                l10nKey = &quot;Overview.ColumnQuadrant&quot;;
                 columnClass = String.class;
                 break;
             case METADATA_DATASETTITLE:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColMetadata&quot;;
+                l10nKey = &quot;Overview.ColumnMetadata&quot;;
                 columnClass = String.class;
                 break;
             case NUMBER:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColNumber&quot;;
+                l10nKey = &quot;Overview.ColumnNumber&quot;;
                 columnClass = Integer.class;
                 break;
             case OCCURRENCE_DATASOURCE:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColSource&quot;;
+                l10nKey = &quot;Overview.ColumnSource&quot;;
                 columnClass = String.class;
                 break;
             case OCCURRENCE_DAYCOLLECTED:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColDay&quot;;
+                l10nKey = &quot;Overview.ColumnDay&quot;;
                 columnClass = Integer.class;
                 break;
             case OCCURRENCE_HERBARIUM:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColHerbarium&quot;;
+                l10nKey = &quot;Overview.ColumnHerbarium&quot;;
                 columnClass = String.class;
                 break;
             case OCCURRENCE_ID:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColOccurrenceId&quot;;
+                l10nKey = &quot;Overview.ColumnOccurrenceId&quot;;
                 columnClass = Integer.class;
                 break;
             case OCCURRENCE_MONTHCOLLECTED:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColMonth&quot;;
+                l10nKey = &quot;Overview.ColumnMonth&quot;;
                 columnClass = Integer.class;
                 break;
             case OCCURRENCE_NOTE:
                 preferredSize = 150;
-                l10nKey = &quot;overviewColOccNote&quot;;
+                l10nKey = &quot;Overview.ColumnOccNote&quot;;
                 columnClass = String.class;
                 break;
             case OCCURRENCE_TIMECOLLECTED:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColTime&quot;;
+                l10nKey = &quot;Overview.ColumnTime&quot;;
                 columnClass = Date.class;
                 break;
             case OCCURRENCE_YEARCOLLECTED:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColYear&quot;;
+                l10nKey = &quot;Overview.ColumnYear&quot;;
                 columnClass = Integer.class;
                 break;
             case PHYTOCHORION_CODE:
                 preferredSize = 50;
-                l10nKey = &quot;overviewColPhytCode&quot;;
+                l10nKey = &quot;Overview.ColumnPhytCode&quot;;
                 columnClass = String.class;
                 break;
             case PHYTOCHORION_NAME:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColPhyt&quot;;
+                l10nKey = &quot;Overview.ColumnPhyt&quot;;
                 columnClass = String.class;
                 break;
             case PLANT_TAXON:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColName&quot;;
+                l10nKey = &quot;Overview.ColumnName&quot;;
                 columnClass = String.class;
                 break;
             case PUBLICATION_COLLECTIONNAME:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColPublication&quot;;
+                l10nKey = &quot;Overview.ColumnPublication&quot;;
                 columnClass = String.class;
                 break;
             case SELECTION:
                 preferredSize = 30;
-                l10nKey = &quot;overviewColSelection&quot;;
+                l10nKey = &quot;Overview.ColumnSelection&quot;;
                 columnClass = Boolean.class;
                 break;
             case TERRITORY_NAME:
                 preferredSize = 100;
-                l10nKey = &quot;overviewColTerritory&quot;;
+                l10nKey = &quot;Overview.ColumnTerritory&quot;;
                 columnClass = String.class;
                 break;
             default:
                 preferredSize = 100;
-                l10nKey = &quot;overviewCol&quot;;
+                l10nKey = &quot;Overview.Column&quot;;
                 columnClass = String.class;
         }
         
@@ -211,8 +220,40 @@
     }
     
     public String toString() {
-        return type.toString();
+        return L10n.getString(l10nKey);
     }
+    
+    public boolean equals(Object obj) {
+        if (!(obj instanceof Column)) 
+            return false;
+        
+        Column col = (Column) obj;
+        
+        return type.equals(col.type);
+    }
+    
+    public Object getDefaultNullValue() {
+        assert columnClass != null;
+        
+        if (columnClass.equals(String.class))
+            return nullString;
+        
+        if (columnClass.equals(Integer.class))
+            return nullInteger;
+        
+        if (columnClass.equals(Double.class))
+            return nullDouble;
+        
+        if (columnClass.equals(Date.class))
+            return nullDate;
+        
+        if (columnClass.equals(Boolean.class))
+            return nullBoolean;
+        
+        logger.warn(&quot;Don't have default null value for class &quot;+columnClass.getClass().getName());
+        return new Object();
+    }
+    
 }
 
 /*

Modified: trunk/src/net/sf/plantlore/client/MainConfig.java
===================================================================
--- trunk/src/net/sf/plantlore/client/MainConfig.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/MainConfig.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -35,7 +35,7 @@
     Logger logger;
     Document document;
     String file;
-    Column[] columns = null;
+    ArrayList&lt;Column&gt; columns = null;
     ArrayList&lt;DBInfo&gt; dbinfos = null;
     
     /** Creates a new instance of MainConfigParser */
@@ -67,7 +67,7 @@
         return load();
     }
     
-    public Column[] getColumns() {
+    public ArrayList&lt;Column&gt; getColumns() {
         ArrayList&lt;Column&gt; columns = new ArrayList&lt;Column&gt;();
         
         List columnList = document.selectNodes(&quot;//config/overview/columns/column&quot;);
@@ -89,9 +89,7 @@
                 columns.add(c);
             }
         }
-        Column[] tmp = new Column[columns.size()];
-        columns.toArray(tmp);
-        return tmp;
+        return columns;
     }
     
     public ArrayList&lt;DBInfo&gt; getDBinfos() {
@@ -122,7 +120,7 @@
         return result;
     }
     
-    public void setColumns(Column[] columns) {
+    public void setColumns(ArrayList&lt;Column&gt; columns) {
         this.columns = columns;
     }
     
@@ -145,8 +143,8 @@
         }
         Element e = overview.addElement(&quot;columns&quot;);
         
-        for (int i = 0; i &lt; columns.length; i++) {
-            e.addElement(&quot;column&quot;).addAttribute(&quot;preferredSize&quot;,&quot;&quot;+columns[i].getPreferredSize()).setText(columns[i].type.toString());
+        for (Column column : columns) {
+            e.addElement(&quot;column&quot;).addAttribute(&quot;preferredSize&quot;,&quot;&quot;+column.getPreferredSize()).setText(column.type.toString());
         }        
     }
     

Modified: trunk/src/net/sf/plantlore/client/OverviewTableModel.java
===================================================================
--- trunk/src/net/sf/plantlore/client/OverviewTableModel.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/OverviewTableModel.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -13,6 +13,7 @@
 import javax.swing.table.AbstractTableModel;
 import net.sf.plantlore.common.Pair;
 import net.sf.plantlore.common.PlantloreConstants;
+import net.sf.plantlore.common.Selection;
 import net.sf.plantlore.common.record.Author;
 import net.sf.plantlore.common.record.AuthorOccurrence;
 import net.sf.plantlore.common.record.Habitat;
@@ -41,10 +42,13 @@
     private int resultsCount = 0;
     private int pageSize = 30;
     private int currentPage = 1;
-    private ArrayList&lt;Record999&gt; recordsArray = new ArrayList&lt;Record999&gt;();
-    private HashMap&lt;Integer, Record999&gt; resultsMap = new HashMap&lt;Integer, Record999&gt;();
-    private Column[] columns;
+    private int selectionColumnIndex = -1;
     
+//    private ArrayList&lt;Record999&gt; recordsArray = new ArrayList&lt;Record999&gt;();
+    private ArrayList&lt;Column&gt; columns;
+    
+    private Selection selection = new Selection();
+    
     class Record999 {
         public Record999(int id, boolean selected, int number) {
             this.id = id;
@@ -92,8 +96,9 @@
         sq.createAlias(&quot;habitat.&quot;+Habitat.PHYTOCHORION,&quot;phyt&quot;);
         sq.createAlias(&quot;habitat.&quot;+Habitat.NEARESTVILLAGE,&quot;vill&quot;);
         sq.createAlias(&quot;habitat.&quot;+Habitat.TERRITORY,&quot;territory&quot;);
-        sq.addOrder(PlantloreConstants.DIRECT_ASC, &quot;occ.&quot;+Occurrence.YEARCOLLECTED); //setridit podle roku
+        sq.addOrder(PlantloreConstants.DIRECT_ASC, &quot;occ.&quot;+Occurrence.ID); //setridit podle roku
         sq.addRestriction(PlantloreConstants.RESTR_NE, &quot;occ.&quot;+Occurrence.DELETED, null, 1, null);
+        sq.addProjection(PlantloreConstants.PROJ_DISTINCT,&quot;occ.&quot;+Occurrence.ID);
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;plant.&quot;+Plant.TAXON);
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;author.&quot;+Author.WHOLENAME);
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;vill.&quot;+Village.NAME);
@@ -101,7 +106,6 @@
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;phyt.&quot;+Phytochorion.NAME);
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;habitat.&quot;+Habitat.DESCRIPTION);
         sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;territory.&quot;+Territory.NAME);
-        sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;occ.&quot;+Occurrence.ID);
         
         //FIXME:
         try {
@@ -109,21 +113,22 @@
         } catch (DBLayerException ex) {
             ex.printStackTrace();
         }
-        loadData();
     }
     
     private void init() {
-        columns = new Column[10];
-        columns[0] = new Column(Column.Type.SELECTION);
-        columns[1] = new Column(Column.Type.NUMBER);
-        columns[2] = new Column(Column.Type.PLANT_TAXON);        
-        columns[3] = new Column(Column.Type.AUTHOR);
-        columns[4] = new Column(Column.Type.HABITAT_NEAREST_VILLAGE_NAME);
-        columns[5] = new Column(Column.Type.OCCURRENCE_YEARCOLLECTED);
-        columns[6] = new Column(Column.Type.PHYTOCHORION_NAME);
-        columns[7] = new Column(Column.Type.HABITAT_DESCRIPTION);
-        columns[8] = new Column(Column.Type.TERRITORY_NAME);
-        columns[9] = new Column(Column.Type.OCCURRENCE_ID);
+        columns = new ArrayList&lt;Column&gt;(10);
+        columns.add(new Column(Column.Type.OCCURRENCE_ID));
+        columns.add(new Column(Column.Type.SELECTION));
+        columns.add(new Column(Column.Type.NUMBER));
+        columns.add(new Column(Column.Type.PLANT_TAXON));        
+        columns.add(new Column(Column.Type.AUTHOR));
+        columns.add(new Column(Column.Type.HABITAT_NEAREST_VILLAGE_NAME));
+        columns.add(new Column(Column.Type.OCCURRENCE_YEARCOLLECTED));
+        columns.add(new Column(Column.Type.PHYTOCHORION_NAME));
+        columns.add(new Column(Column.Type.HABITAT_DESCRIPTION));
+        columns.add(new Column(Column.Type.TERRITORY_NAME));
+        selectionColumnIndex = columns.indexOf(new Column(Column.Type.SELECTION)) - 1; // we don't display the first column which is always Occurrence.ID
+                                                                                       // so the index as JTable sees it is -1
     }
     
     private Pair&lt;String,Integer&gt;[] getAuthorsOf(Occurrence o) {
@@ -169,24 +174,22 @@
 
             for (int i = 0; i &lt; data.length ; i++) {
                 projArray = (Object[]) records[i];
-                Record999 r = new Record999(from + i + 1, false, from + i + 1);//we want to show the user numbers starting from 1 therefor the +1
-                if (from + i + 1 &gt; recordsArray.size()) //most probably much faster than to ask recordsArray.contains(r)
-                    recordsArray.add(r);
-                else 
-                    r = recordsArray.get(from+i);
 
-                row = new Object[columns.length + 1]; //we'll store the record id in the last column
+                row = new Object[columns.size() + 1]; //we'll store the record id in the last column
                 int proj = 0;
-                for (int j = 0; j &lt; columns.length; j++) {
-                    if (columns[j].type.equals(Column.Type.SELECTION)) {
-                        row[j] = r.selected;
+                Object occId = projArray[0] == null ? new Column(Column.Type.OCCURRENCE_ID).getDefaultNullValue() : projArray[0];
+                for (int j = 0; j &lt; columns.size(); j++) {
+                    Object value = projArray[proj] == null ? columns.get(j).getDefaultNullValue() : projArray[proj];
+                    
+                    if (columns.get(j).type.equals(Column.Type.SELECTION)) {
+                        row[j] = selection.contains((Integer) occId);
                     } else 
-                    if (columns[j].type.equals((Column.Type.NUMBER))) {
-                        row[j] = r.number;
+                    if (columns.get(j).type.equals((Column.Type.NUMBER))) {
+                        row[j] = from + i + 1;
                     } else {
-                        if (columns[j].type.equals(Column.Type.OCCURRENCE_ID))
-                            row[row.length-1] = projArray[proj];
-                        row[j] = projArray[proj];
+                        if (columns.get(j).type.equals(Column.Type.OCCURRENCE_ID))
+                            row[row.length-1] = value;                        
+                        row[j] = value;
                         proj++;
                     }
                 }// for j                
@@ -209,35 +212,40 @@
     }
     
     public int getColumnCount() {
-        return columns.length;
+        return columns.size()-1; //the first column is Occurrence.Id, just for our internal purposes
     }
     
-    public Object getValueAt(int i, int i0) {
-        return data[i][i0];
+    public Object getValueAt(int row, int col) {
+        return data[row][col+1]; //col+1 because we need to skip the occurrence.id
     }
     
     public Class getColumnClass(int c) {
-        return columns[c].getColumnClass();
+        return columns.get(c+1).getColumnClass(); //c+1 --&gt; skip the occurrence.id
     }
 
     public String getColumnName(int c){
-        return columns[c].getL10nName();
+        return columns.get(c+1).getL10nName(); //c+1 --&gt; skip the occurrence.id
     }
     
     /* nepouziva se
      * primo v overview nelze editovat
      */
     public void setValueAt(Object value, int row, int column) {
-        data[row][column] = value;
-        if (column == 0)
+        data[row][column + 1] = value; //column+1 --&gt; skip the occurrence.id
+        if (column == selectionColumnIndex)
             //displayed number of record starts from 1 --&gt; we have to subtract 1 coz ArrayList is indexed from 0
-            recordsArray.get((Integer)data[row][1]-1).selected = (Boolean)value;
+            if ((Boolean)value)
+                selection.add((Integer) data[row][data[row].length-1]);
+            else
+                selection.remove((Integer) data[row][data[row].length-1]);
+            
+        //recordsArray.get((Integer)data[row][1]-1).selected = (Boolean)value;
         //repaint view - with new value
         this.fireTableCellUpdated(row, column);
     }
     
     public boolean isCellEditable(int row, int column) {
-        if (column == 0 ) {
+        if (column == selectionColumnIndex) {
             return true;
         }
         return false;
@@ -245,7 +253,7 @@
     
     public int getColumnSize(int col) {
         //return columnSizes[col];
-        return columns[col].getPreferredSize();
+        return columns.get(col+1).getPreferredSize();//col+1 --&gt; skip the occurrence.id
     }
     
     public boolean isSimple() {
@@ -258,22 +266,22 @@
     
     public void selectAll() {
         for (int i = 0; i &lt; data.length; i++) {
-            setValueAt(true,i,0);
+            setValueAt(true,i,selectionColumnIndex);
         }
     }
     
     public void selectNone() {
         for (int i = 0; i &lt; data.length; i++) {
-            setValueAt(false, i, 0);
+            setValueAt(false, i, selectionColumnIndex);
         }
     }
     
     public void invertSelected() {
         for (int i = 0; i &lt; data.length; i++) {
-            if ((Boolean)data[i][0] == true)
-                setValueAt(false, i, 0);
+            if ((Boolean)data[i][selectionColumnIndex+1] == true) //+1 --&gt; skip the occurrence.id, the selectionColumnIndex is from the JTable's point of view
+                setValueAt(false, i, selectionColumnIndex);
             else
-                setValueAt(true, i, 0);
+                setValueAt(true, i, selectionColumnIndex);
         }
     }
     
@@ -352,7 +360,8 @@
         //FIXME
         try {
             loadData();
-            fireTableDataChanged(); //let the table compoment know it should redraw itself
+            //fireTableDataChanged(); //let the table compoment know it should redraw itself
+            fireTableStructureChanged();
         } catch (DBLayerException ex) {
             ex.printStackTrace();
         } catch (RemoteException ex) {
@@ -373,12 +382,24 @@
         return ((Number)Math.ceil(resultsCount / (pageSize*1.0))).intValue();
     }
 
-    public Column[] getColumns() {
-        return columns;
+    public ArrayList&lt;Column&gt; getColumns() {
+        return (ArrayList&lt;Column&gt;) columns.clone();
     }
 
-    public void setColumns(Column[] columns) {
+    public void setColumns(ArrayList&lt;Column&gt; columns) {
+        logger.debug(&quot;Setting new overview columns.&quot;);
+        selectionColumnIndex = columns.indexOf(new Column(Column.Type.SELECTION)) - 1; // we don't display the first column which is always Occurrence.ID
+                                                                                       // so the index as JTable sees it is -1
+        
         this.columns = columns;
     }
+    
+    public Selection getSelection() {
+        return selection.clone();
+    }
+    
+    public Integer getOccurrenceId(int row) {
+        return (Integer)data[row][data[row].length-1];
+    }
 }
 

Modified: trunk/src/net/sf/plantlore/client/Search.java
===================================================================
--- trunk/src/net/sf/plantlore/client/Search.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/Search.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -91,14 +91,17 @@
     private int timeChoice = INTERVAL;
     private Boolean editMode = false;
     
-    private Column[] columns;
+    private ArrayList&lt;Column&gt; columns;
     private int newResultId = -1;
+    private SelectQuery exportQuery = null;
     
+    
     /** Creates a new instance of AddEdit */
     public Search(DBLayer database) {
         this.database = database;
         this.editMode = editMode;
-        logger = Logger.getLogger(this.getClass().getPackage().getName());                
+        logger = Logger.getLogger(this.getClass().getPackage().getName());         
+        clear();
     }
  
 
@@ -491,9 +494,9 @@
             return new Pair&lt;Boolean,String&gt;(true,&quot;&quot;);
     }
     
-    public SelectQuery constructQuery() {
+    public Pair&lt;SelectQuery,SelectQuery&gt; constructQuery() {
         DBLayerUtils dlu = new DBLayerUtils(database);
-        SelectQuery sq = null;
+        SelectQuery sq = null, exportQuery = null;
             //FIXME:
             try {
                 sq = database.createQuery(AuthorOccurrence.class);
@@ -509,8 +512,21 @@
                 sq.addOrder(PlantloreConstants.DIRECT_ASC, &quot;occ.&quot;+Occurrence.YEARCOLLECTED); //setridit podle roku
                 sq.addRestriction(PlantloreConstants.RESTR_NE, &quot;occ.&quot;+Occurrence.DELETED, null, 1, null);
                 
-                for (int i=0; i &lt; columns.length; i++) {
-                    switch (columns[i].type) {
+                exportQuery = database.createQuery(AuthorOccurrence.class);
+                exportQuery.createAlias(AuthorOccurrence.AUTHOR,&quot;author&quot;);
+                exportQuery.createAlias(AuthorOccurrence.OCCURRENCE,&quot;occ&quot;);
+                exportQuery.createAlias(&quot;occ.&quot;+Occurrence.HABITAT,&quot;habitat&quot;);
+                exportQuery.createAlias(&quot;occ.&quot;+Occurrence.PLANT,&quot;plant&quot;);
+                exportQuery.createAlias(&quot;occ.&quot;+Occurrence.PUBLICATION,&quot;publication&quot;);
+                exportQuery.createAlias(&quot;occ.&quot;+Occurrence.METADATA,&quot;metadata&quot;);
+                exportQuery.createAlias(&quot;habitat.&quot;+Habitat.PHYTOCHORION,&quot;phyt&quot;);
+                exportQuery.createAlias(&quot;habitat.&quot;+Habitat.NEARESTVILLAGE,&quot;vill&quot;);
+                exportQuery.createAlias(&quot;habitat.&quot;+Habitat.TERRITORY,&quot;territory&quot;);
+                exportQuery.addOrder(PlantloreConstants.DIRECT_ASC, &quot;occ.&quot;+Occurrence.YEARCOLLECTED); //setridit podle roku
+                exportQuery.addRestriction(PlantloreConstants.RESTR_NE, &quot;occ.&quot;+Occurrence.DELETED, null, 1, null);
+
+                for (Column column : columns) {
+                    switch (column.type) {
                         case AUTHOR:
                             sq.addProjection(PlantloreConstants.PROJ_PROPERTY,&quot;author.&quot;+Author.WHOLENAME);
                             break;
@@ -590,6 +606,7 @@
                 
                 if (isNotEmpty(village)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.NEARESTVILLAGE,null,dlu.getObjectFor(village.getSecond(),Village.class),null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.NEARESTVILLAGE,null,dlu.getObjectFor(village.getSecond(),Village.class),null);
                 }
                 
                 int notEmpty = 0;
@@ -622,6 +639,7 @@
                         }
                     }
                     sq.addOrRestriction(args);
+                    exportQuery.addOrRestriction(args);
                 }
 
                 notEmpty = 0;
@@ -643,62 +661,77 @@
                         }
                     }
                     sq.addOrRestriction(args);
+                    exportQuery.addOrRestriction(args);
                 }
                 if (isNotEmpty(localityDescription)) {
                     sq.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;habitat.&quot;+Habitat.DESCRIPTION,null,&quot;%&quot;+localityDescription+&quot;%&quot;,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;habitat.&quot;+Habitat.DESCRIPTION,null,&quot;%&quot;+localityDescription+&quot;%&quot;,null);
                 }
                 
                 if (isNotEmpty(occurrenceNote)) {
                     sq.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;occ.&quot;+Occurrence.NOTE,null,&quot;%&quot;+occurrenceNote+&quot;%&quot;,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;occ.&quot;+Occurrence.NOTE,null,&quot;%&quot;+occurrenceNote+&quot;%&quot;,null);
                 }
                 
                 if (isNotEmpty(habitatNote)) {
                     sq.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;habitat.&quot;+Habitat.NOTE,null,&quot;%&quot;+habitatNote+&quot;%&quot;,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_LIKE,&quot;habitat.&quot;+Habitat.NOTE,null,&quot;%&quot;+habitatNote+&quot;%&quot;,null);
                 }
                 
                 if (isNotEmpty(territoryName)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.TERRITORY,null,dlu.getObjectFor(territoryName.getSecond(),Territory.class),null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.TERRITORY,null,dlu.getObjectFor(territoryName.getSecond(),Territory.class),null);
                 }
                 
                 if (isNotEmpty(phytName)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.PHYTOCHORION,null,dlu.getObjectFor(phytName.getSecond(),Phytochorion.class),null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.PHYTOCHORION,null,dlu.getObjectFor(phytName.getSecond(),Phytochorion.class),null);
                 }
                 
                 if (isNotEmpty(phytCountry)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.COUNTRY,null,phytCountry,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.COUNTRY,null,phytCountry,null);
                 }
                 
                 if (isNotEmpty(quadrant)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.QUADRANT,null,quadrant,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.QUADRANT,null,quadrant,null);
                 }
                 
                 if (isNotEmpty(altitude)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.ALTITUDE,null,altitude,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.ALTITUDE,null,altitude,null);
                 }
                 
                 if (isNotEmpty(longitude)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.LONGITUDE,null,longitude,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.LONGITUDE,null,longitude,null);
                 }
 
                 if (isNotEmpty(latitude)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.LATITUDE,null,latitude,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;habitat.&quot;+Habitat.LATITUDE,null,latitude,null);
                 }
 
                 if (isNotEmpty(source)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.DATASOURCE,null,source,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.DATASOURCE,null,source,null);
                 }
                 
                 if (isNotEmpty(publication)) {
                     //FIXME: mozna pridat addOrRestriction na vsechny relevantni sloupky Publication
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.PUBLICATION,null,dlu.getObjectFor(publication.getSecond(),Publication.class),null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.PUBLICATION,null,dlu.getObjectFor(publication.getSecond(),Publication.class),null);
                 }
                 
                 if (isNotEmpty(herbarium)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.HERBARIUM,null,herbarium,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.HERBARIUM,null,herbarium,null);
                 }
                 
                 if (isNotEmpty(project)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.METADATA,null,dlu.getObjectFor(project.getSecond(),Metadata.class),null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.METADATA,null,dlu.getObjectFor(project.getSecond(),Metadata.class),null);
                 }
                 
                 if (timeChoice == INTERVAL &amp;&amp; isNotEmpty(fromDate)) {
@@ -722,12 +755,15 @@
                     a.add(to.getTime());
                     System.out.println(&quot;Searching between &quot;+from.getTime()+&quot; and &quot;+to.getTime());
                     sq.addRestriction(PlantloreConstants.RESTR_BETWEEN,&quot;occ.&quot;+Occurrence.ISODATETIMEBEGIN,null,null,a);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_BETWEEN,&quot;occ.&quot;+Occurrence.ISODATETIMEBEGIN,null,null,a);
                 }
                 
                 if (timeChoice == MONTH &amp;&amp; isNotEmpty(month)) {
                     sq.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.MONTHCOLLECTED,null,month,null);
+                    exportQuery.addRestriction(PlantloreConstants.RESTR_EQ,&quot;occ.&quot;+Occurrence.MONTHCOLLECTED,null,month,null);
                 }
                 
+                this.exportQuery = exportQuery;
                 int resultId = database.executeQuery(sq);
                 this.newResultId = resultId;
                 logger.debug(&quot;Created new query. Number of results: &quot;+database.getNumRows(resultId));
@@ -739,7 +775,7 @@
             } catch (DBLayerException ex) {
                 ex.printStackTrace();
             }
-        return sq;
+        return new Pair&lt;SelectQuery,SelectQuery&gt;(sq,exportQuery);
     }
     
     public void clear() {
@@ -838,7 +874,7 @@
         return newResultId;
     }
 
-    public void setColumns(Column[] columns) {
+    public void setColumns(ArrayList&lt;Column&gt; columns) {
         logger.debug(&quot;Setting columns.&quot;);
         this.columns = columns;
     }
@@ -930,6 +966,10 @@
     public void setProjects(Pair&lt;String, Integer&gt;[] projects) {
         this.projects = projects;
     }
+    
+    public SelectQuery getExportQuery() {
+        return exportQuery;
+    }
 }
 
 

Modified: trunk/src/net/sf/plantlore/client/SearchView.form
===================================================================
--- trunk/src/net/sf/plantlore/client/SearchView.form	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/SearchView.form	2006-05-16 18:01:09 UTC (rev 284)
@@ -54,8 +54,8 @@
                   &lt;Component id=&quot;TaxonLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                      &lt;Component id=&quot;jScrollPane3&quot; alignment=&quot;0&quot; pref=&quot;322&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                      &lt;Component id=&quot;jScrollPane1&quot; alignment=&quot;0&quot; pref=&quot;322&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;jScrollPane3&quot; pref=&quot;245&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                      &lt;Component id=&quot;jScrollPane1&quot; alignment=&quot;0&quot; pref=&quot;245&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
                   &lt;EmptySpace min=&quot;-2&quot; pref=&quot;85&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
@@ -63,15 +63,10 @@
                       &lt;Component id=&quot;jLabel2&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-                      &lt;Component id=&quot;townComboBox&quot; pref=&quot;223&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                      &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;extendedButton&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;jScrollPane2&quot; alignment=&quot;0&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                          &lt;/Group&gt;
-                      &lt;/Group&gt;
+                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                      &lt;Component id=&quot;townComboBox&quot; alignment=&quot;1&quot; pref=&quot;300&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                      &lt;Component id=&quot;jScrollPane2&quot; alignment=&quot;0&quot; pref=&quot;300&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                      &lt;Component id=&quot;extendedButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;/Group&gt;
@@ -83,27 +78,27 @@
                   &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                       &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;3&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;townComboBox&quot; alignment=&quot;3&quot; min=&quot;-2&quot; pref=&quot;24&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                               &lt;Component id=&quot;TownLabel&quot; alignment=&quot;3&quot; min=&quot;-2&quot; pref=&quot;16&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;Component id=&quot;townComboBox&quot; alignment=&quot;3&quot; min=&quot;-2&quot; pref=&quot;24&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;/Group&gt;
-                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;19&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                              &lt;Component id=&quot;jScrollPane2&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                               &lt;Component id=&quot;jLabel2&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;jScrollPane2&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                           &lt;/Group&gt;
+                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;Component id=&quot;extendedButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                       &lt;/Group&gt;
                       &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                          &lt;Component id=&quot;jScrollPane1&quot; min=&quot;-2&quot; pref=&quot;69&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;Component id=&quot;jScrollPane1&quot; min=&quot;-2&quot; pref=&quot;82&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;14&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;TaxonLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;jScrollPane3&quot; min=&quot;-2&quot; pref=&quot;53&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
+                              &lt;Component id=&quot;jScrollPane3&quot; pref=&quot;67&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                              &lt;Component id=&quot;TaxonLabel&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;/Group&gt;
-                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;Component id=&quot;extendedButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                       &lt;/Group&gt;
                   &lt;/Group&gt;
-                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;183&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;/Group&gt;
           &lt;/Group&gt;
         &lt;/DimensionLayout&gt;
@@ -159,7 +154,7 @@
                 &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
               &lt;/Properties&gt;
               &lt;AuxValues&gt;
-                &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;descriptionArea.setLineWrap(true);&quot;/&gt;
+                &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;descriptionArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(descriptionArea);&quot;/&gt;
                 &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
               &lt;/AuxValues&gt;
             &lt;/Component&gt;
@@ -237,7 +232,7 @@
           &lt;Dimension value=&quot;[800, 395]&quot;/&gt;
         &lt;/Property&gt;
         &lt;Property name=&quot;preferredSize&quot; type=&quot;java.awt.Dimension&quot; editor=&quot;org.netbeans.beaninfo.editors.DimensionEditor&quot;&gt;
-          &lt;Dimension value=&quot;[800, 395]&quot;/&gt;
+          &lt;Dimension value=&quot;[800, 415]&quot;/&gt;
         &lt;/Property&gt;
       &lt;/Properties&gt;
       &lt;Constraints&gt;
@@ -263,9 +258,9 @@
                               &lt;Component id=&quot;jPanel5&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                           &lt;/Group&gt;
                           &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;jPanel7&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                              &lt;Component id=&quot;jPanel9&quot; alignment=&quot;0&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                          &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                              &lt;Component id=&quot;jPanel9&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                              &lt;Component id=&quot;jPanel7&quot; alignment=&quot;0&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
                           &lt;/Group&gt;
                       &lt;/Group&gt;
                   &lt;/Group&gt;
@@ -282,19 +277,11 @@
                   &lt;/Group&gt;
                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                      &lt;Group type=&quot;102&quot; attributes=&quot;0&quot;&gt;
-                          &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;jPanel6&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                              &lt;Component id=&quot;jPanel1&quot; alignment=&quot;1&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
-                          &lt;/Group&gt;
-                          &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                      &lt;/Group&gt;
-                      &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                          &lt;Component id=&quot;jPanel9&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
-                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;10&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                      &lt;/Group&gt;
+                      &lt;Component id=&quot;jPanel9&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                      &lt;Component id=&quot;jPanel6&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                      &lt;Component id=&quot;jPanel1&quot; alignment=&quot;1&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
                   &lt;/Group&gt;
-                  &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;0&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Component id=&quot;jPanel4&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
                   &lt;EmptySpace min=&quot;-2&quot; pref=&quot;358&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;/Group&gt;
@@ -823,7 +810,7 @@
                     &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
                   &lt;/Properties&gt;
                   &lt;AuxValues&gt;
-                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;locationNoteArea.setLineWrap(true);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;locationNoteArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(locationNoteArea);&quot;/&gt;
                     &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
                   &lt;/AuxValues&gt;
                 &lt;/Component&gt;
@@ -1070,7 +1057,7 @@
             &lt;DimensionLayout dim=&quot;1&quot;&gt;
               &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                   &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                      &lt;Component id=&quot;jScrollPane5&quot; pref=&quot;105&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;jScrollPane5&quot; pref=&quot;115&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
               &lt;/Group&gt;
@@ -1090,7 +1077,7 @@
                     &lt;Property name=&quot;rows&quot; type=&quot;int&quot; value=&quot;5&quot;/&gt;
                   &lt;/Properties&gt;
                   &lt;AuxValues&gt;
-                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;occurrenceNoteArea.setLineWrap(true);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;occurrenceNoteArea.setLineWrap(true);&amp;#xa;new TabTransfersFocus(occurrenceNoteArea);&quot;/&gt;
                     &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
                   &lt;/AuxValues&gt;
                 &lt;/Component&gt;

Modified: trunk/src/net/sf/plantlore/client/SearchView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/SearchView.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/SearchView.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -22,6 +22,7 @@
 import net.sf.plantlore.common.AutoComboBox;
 import net.sf.plantlore.common.AutoTextArea;
 import net.sf.plantlore.common.Pair;
+import net.sf.plantlore.common.TabTransfersFocus;
 import net.sf.plantlore.l10n.L10n;
 
 /**
@@ -42,7 +43,7 @@
         setDefaultCloseOperation(JDialog.HIDE_ON_CLOSE);
         initComponents();
         jPanel3.setVisible(visible);
-        jPanel2.setPreferredSize(new Dimension(DIALOG_WIDTH,190));
+        jPanel2.setPreferredSize(new Dimension(DIALOG_WIDTH,210));
         jPanel8.setPreferredSize(new Dimension(DIALOG_WIDTH,50));
         this.pack();        
     }
@@ -143,6 +144,7 @@
         descriptionArea.setColumns(20);
         descriptionArea.setRows(5);
         descriptionArea.setLineWrap(true);
+        new TabTransfersFocus(descriptionArea);
         jScrollPane2.setViewportView(descriptionArea);
 
         taxonTextArea.setColumns(20);
@@ -184,20 +186,17 @@
                 .add(TaxonLabel)
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                 .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                    .add(jScrollPane3, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 322, Short.MAX_VALUE)
-                    .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 322, Short.MAX_VALUE))
+                    .add(jScrollPane3, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 245, Short.MAX_VALUE)
+                    .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 245, Short.MAX_VALUE))
                 .add(85, 85, 85)
                 .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                     .add(TownLabel)
                     .add(jLabel2))
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
-                    .add(townComboBox, 0, 223, Short.MAX_VALUE)
-                    .add(org.jdesktop.layout.GroupLayout.LEADING, jPanel2Layout.createSequentialGroup()
-                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                            .add(extendedButton)
-                            .add(jScrollPane2))))
+                .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+                    .add(org.jdesktop.layout.GroupLayout.TRAILING, townComboBox, 0, 300, Short.MAX_VALUE)
+                    .add(jScrollPane2, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 300, Short.MAX_VALUE)
+                    .add(extendedButton))
                 .addContainerGap())
         );
         jPanel2Layout.setVerticalGroup(
@@ -206,27 +205,27 @@
                 .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                     .add(jPanel2Layout.createSequentialGroup()
                         .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
-                            .add(townComboBox, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 24, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
-                            .add(TownLabel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 16, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                            .add(TownLabel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 16, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                            .add(townComboBox, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 24, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
+                        .add(19, 19, 19)
                         .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                            .add(jLabel2)
-                            .add(jScrollPane2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
-                    .add(jPanel2Layout.createSequentialGroup()
-                        .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 69, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                            .add(jScrollPane2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                            .add(jLabel2))
                         .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                        .add(extendedButton))
+                    .add(jPanel2Layout.createSequentialGroup()
+                        .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 82, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                        .add(14, 14, 14)
                         .add(jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                            .add(TaxonLabel)
-                            .add(jScrollPane3, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 53, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(extendedButton)))
-                .add(183, 183, 183))
+                            .add(jScrollPane3, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 67, Short.MAX_VALUE)
+                            .add(TaxonLabel))))
+                .addContainerGap())
         );
         getContentPane().add(jPanel2, java.awt.BorderLayout.NORTH);
 
         jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder(null, &quot;Extended data&quot;, javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font(&quot;Dialog&quot;, 0, 12)));
         jPanel3.setMinimumSize(new java.awt.Dimension(800, 395));
-        jPanel3.setPreferredSize(new java.awt.Dimension(800, 395));
+        jPanel3.setPreferredSize(new java.awt.Dimension(800, 415));
         jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder(null, &quot;Time&quot;, javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font(&quot;Dialog&quot;, 0, 12)));
 
         fromLabel.setText(&quot;From:&quot;);
@@ -443,6 +442,7 @@
         locationNoteArea.setColumns(20);
         locationNoteArea.setRows(5);
         locationNoteArea.setLineWrap(true);
+        new TabTransfersFocus(locationNoteArea);
         jScrollPane4.setViewportView(locationNoteArea);
 
         org.jdesktop.layout.GroupLayout jPanel7Layout = new org.jdesktop.layout.GroupLayout(jPanel7);
@@ -556,6 +556,7 @@
         occurrenceNoteArea.setColumns(20);
         occurrenceNoteArea.setRows(5);
         occurrenceNoteArea.setLineWrap(true);
+        new TabTransfersFocus(occurrenceNoteArea);
         jScrollPane5.setViewportView(occurrenceNoteArea);
 
         org.jdesktop.layout.GroupLayout jPanel9Layout = new org.jdesktop.layout.GroupLayout(jPanel9);
@@ -570,7 +571,7 @@
         jPanel9Layout.setVerticalGroup(
             jPanel9Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
             .add(jPanel9Layout.createSequentialGroup()
-                .add(jScrollPane5, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 105, Short.MAX_VALUE)
+                .add(jScrollPane5, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 115, Short.MAX_VALUE)
                 .addContainerGap())
         );
 
@@ -590,9 +591,9 @@
                                 .add(jPanel6, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                             .add(jPanel5, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                         .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
-                            .add(jPanel7, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
-                            .add(org.jdesktop.layout.GroupLayout.LEADING, jPanel9, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))))
+                        .add(jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+                            .add(jPanel9, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
+                            .add(jPanel7, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))))
                 .addContainerGap())
         );
         jPanel3Layout.setVerticalGroup(
@@ -603,15 +604,10 @@
                     .add(jPanel5, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                 .add(jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                    .add(jPanel3Layout.createSequentialGroup()
-                        .add(jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                            .add(jPanel6, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
-                            .add(org.jdesktop.layout.GroupLayout.TRAILING, jPanel1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
-                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED))
-                    .add(jPanel3Layout.createSequentialGroup()
-                        .add(jPanel9, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
-                        .add(10, 10, 10)))
-                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
+                    .add(jPanel9, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
+                    .add(jPanel6, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
+                    .add(org.jdesktop.layout.GroupLayout.TRAILING, jPanel1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
+                .add(0, 0, 0)
                 .add(jPanel4, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                 .add(358, 358, 358))
         );

Modified: trunk/src/net/sf/plantlore/client/Settings.java
===================================================================
--- trunk/src/net/sf/plantlore/client/Settings.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/Settings.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -7,6 +7,8 @@
 
 package net.sf.plantlore.client;
 
+import java.util.ArrayList;
+import java.util.Observable;
 import java.util.prefs.Preferences;
 import net.sf.plantlore.l10n.L10n;
 import org.apache.log4j.Logger;
@@ -18,7 +20,7 @@
  *
  * @author Jakub
  */
-public class Settings
+public class Settings extends Observable
 {
     public static final int DEFAULT_LANGUAGE = 0;
     public static final int CZECH = 1;
@@ -27,6 +29,9 @@
     private String language;
     private Logger logger;
     
+    private ArrayList&lt;Column&gt; selectedColumns;
+    private ArrayList&lt;Column&gt; unselectedColumns;
+    
     /** Creates a new instance of Settings */
     public Settings()
     {
@@ -77,5 +82,32 @@
             prefs.remove(&quot;locale&quot;);
         else
             prefs.put(&quot;locale&quot;,language);
+        setChanged();
+        notifyObservers(&quot;COLUMNS&quot;);        
     }//store()
+    
+    public void setSelectedColumns(ArrayList&lt;Column&gt; columns) {
+        this.selectedColumns = columns;
+        this.unselectedColumns = new ArrayList&lt;Column&gt;();
+        for (Column.Type type : Column.Type.values()) {
+            Column column = new Column(type);
+            
+            if (type.equals(Column.Type.OCCURRENCE_ID))
+                continue;
+            
+            if (!selectedColumns.contains(column))
+                unselectedColumns.add(column);
+        }
+    }
+    
+    public ArrayList&lt;Column&gt; getSelectedColumns() {
+        return selectedColumns;
+    }
+    
+    public ArrayList&lt;Column&gt; getUnselectedColumns() {
+        return unselectedColumns;
+    }
+    
+    
+    
 }

Modified: trunk/src/net/sf/plantlore/client/SettingsCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/SettingsCtrl.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/SettingsCtrl.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -13,7 +13,10 @@
 import java.awt.event.ItemListener;
 import java.awt.event.WindowEvent;
 import java.awt.event.WindowListener;
+import java.util.ArrayList;
 import java.util.Observable;
+import javax.swing.DefaultListModel;
+import javax.swing.JOptionPane;
 import javax.swing.JRadioButton;
 import javax.swing.JToggleButton;
 import net.sf.plantlore.l10n.L10n;
@@ -41,6 +44,11 @@
         view.englishRadioButton.addActionListener(new LanguagesListener());
         view.czechRadioButton.addActionListener(new LanguagesListener());
         view.defaultRadioButton.addActionListener(new LanguagesListener());
+        
+        view.addButton.addActionListener(new ButtonListener());
+        view.removeButton.addActionListener(new ButtonListener());
+        view.upButton.addActionListener(new ButtonListener());
+        view.downButton.addActionListener(new ButtonListener());
     }
     
     /** Handles clicks on languages radio buttons.
@@ -72,15 +80,88 @@
         {
             String s = actionEvent.getActionCommand();
             if (s.equals(&quot;OK&quot;)) {
+                DefaultListModel selectedModel = (DefaultListModel)view.selectedList.getModel();
+                ArrayList&lt;Column&gt; columns = new ArrayList&lt;Column&gt;(selectedModel.size());
+                
+                //!! Overview and Search expect that the first column is always Occurrence.ID!!
+                columns.add(new Column(Column.Type.OCCURRENCE_ID));
+                
+                for (int i = 0; i &lt; selectedModel.size(); i++) {
+                    columns.add((Column) selectedModel.get(i));
+                }
+                model.setSelectedColumns(columns);                
                 model.store();
                 view.setVisible(false);
+                return;
             }
-            if (s.equals(&quot;HELP&quot;))
+            if (s.equals(&quot;HELP&quot;)) {
                 System.out.println(&quot;Tady se bude volat Help!&quot;);
-            if (s.equals(&quot;CANCEL&quot;))
+                return;
+            }
+            if (s.equals(&quot;CANCEL&quot;)) {
                 view.setVisible(false);
+                return;
+            }
+            
+            if (s.equals(&quot;ADD&quot;)) {
+                DefaultListModel availableModel = (DefaultListModel)view.availableList.getModel();
+                DefaultListModel selectedModel = (DefaultListModel)view.selectedList.getModel();
+                
+                Object[] columns = view.availableList.getSelectedValues();
+                for (Object c :  columns) {                    
+                    selectedModel.addElement(c);
+                    availableModel.removeElement(c);
+                }
+                return;
+            }
+            if (s.equals(&quot;REMOVE&quot;)) {
+                DefaultListModel availableModel = (DefaultListModel)view.availableList.getModel();
+                DefaultListModel selectedModel = (DefaultListModel)view.selectedList.getModel();
+                
+                Object[] columns = view.selectedList.getSelectedValues();
+                for (Object c :  columns) {
+                    Column col = (Column)c;
+                    switch (col.type) {
+                        case SELECTION:
+                            JOptionPane.showMessageDialog(view,&quot;You can't remove the selection column.&quot;);
+                            continue;
+                    }
+                    availableModel.addElement(c);
+                    selectedModel.removeElement(c);
+                }
+                
+                return;
+            }
+            if (s.equals(&quot;UP&quot;)) {
+                DefaultListModel selectedModel = (DefaultListModel)view.selectedList.getModel();
+                int min = view.selectedList.getMinSelectionIndex();
+                int max = view.selectedList.getMaxSelectionIndex();
+                
+                if (min &gt; 0) {
+                    Object o = selectedModel.remove(min-1);
+                    selectedModel.add(max,o);
+                }
+                
+                return;
+            }
+            if (s.equals(&quot;DOWN&quot;)) {
+                DefaultListModel selectedModel = (DefaultListModel)view.selectedList.getModel();
+                int min = view.selectedList.getMinSelectionIndex();
+                int max = view.selectedList.getMaxSelectionIndex();
+                
+                if (max &lt; selectedModel.getSize() - 1) {
+                    Object o = selectedModel.getElementAt(max+1);
+                    
+                    for (int i = max; i &gt;= min; i--) {
+                        selectedModel.set(i+1,selectedModel.getElementAt(i));
+                    }
+                    selectedModel.set(min,o);
+                    view.selectedList.setSelectionInterval(min+1,max+1);
+                }
+                
+                return;
+            }
         }
     }
     
-    
 }

Modified: trunk/src/net/sf/plantlore/client/SettingsView.form
===================================================================
--- trunk/src/net/sf/plantlore/client/SettingsView.form	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/SettingsView.form	2006-05-16 18:01:09 UTC (rev 284)
@@ -21,19 +21,19 @@
           &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
               &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;Component id=&quot;helpButton&quot; linkSize=&quot;1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-              &lt;EmptySpace pref=&quot;334&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace pref=&quot;321&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
               &lt;Component id=&quot;cancelButton&quot; linkSize=&quot;1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;Component id=&quot;okButton&quot; linkSize=&quot;1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
           &lt;/Group&gt;
-          &lt;Component id=&quot;jTabbedPane1&quot; alignment=&quot;0&quot; pref=&quot;589&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+          &lt;Component id=&quot;jTabbedPane1&quot; alignment=&quot;0&quot; pref=&quot;576&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
       &lt;/Group&gt;
     &lt;/DimensionLayout&gt;
     &lt;DimensionLayout dim=&quot;1&quot;&gt;
       &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
           &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-              &lt;Component id=&quot;jTabbedPane1&quot; pref=&quot;314&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;jTabbedPane1&quot; pref=&quot;323&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
               &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;Group type=&quot;103&quot; groupAlignment=&quot;3&quot; attributes=&quot;0&quot;&gt;
                   &lt;Component id=&quot;helpButton&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
@@ -74,7 +74,7 @@
                   &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                       &lt;Component id=&quot;jPanel2&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                      &lt;EmptySpace pref=&quot;141&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;EmptySpace pref=&quot;149&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
               &lt;/Group&gt;
             &lt;/DimensionLayout&gt;
@@ -99,7 +99,7 @@
                               &lt;Component id=&quot;czechRadioButton&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                               &lt;Component id=&quot;defaultRadioButton&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;/Group&gt;
-                          &lt;EmptySpace pref=&quot;475&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;EmptySpace pref=&quot;462&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                       &lt;/Group&gt;
                   &lt;/Group&gt;
                 &lt;/DimensionLayout&gt;
@@ -112,7 +112,7 @@
                           &lt;Component id=&quot;czechRadioButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Component id=&quot;defaultRadioButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;EmptySpace pref=&quot;43&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;EmptySpace pref=&quot;44&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                       &lt;/Group&gt;
                   &lt;/Group&gt;
                 &lt;/DimensionLayout&gt;
@@ -196,7 +196,7 @@
               &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                   &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                      &lt;Component id=&quot;jPanel4&quot; pref=&quot;560&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;jPanel4&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
               &lt;/Group&gt;
@@ -205,7 +205,7 @@
               &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                   &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                      &lt;Component id=&quot;jPanel4&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;jPanel4&quot; pref=&quot;272&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                       &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;/Group&gt;
               &lt;/Group&gt;
@@ -227,20 +227,32 @@
                       &lt;Group type=&quot;102&quot; max=&quot;-2&quot; attributes=&quot;0&quot;&gt;
                           &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;availableLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;jScrollPane1&quot; linkSize=&quot;5&quot; min=&quot;-2&quot; pref=&quot;156&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;Group type=&quot;102&quot; attributes=&quot;0&quot;&gt;
+                                  &lt;Component id=&quot;jScrollPane1&quot; linkSize=&quot;5&quot; min=&quot;-2&quot; pref=&quot;156&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;21&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                                      &lt;Component id=&quot;addButton&quot; linkSize=&quot;2&quot; min=&quot;-2&quot; pref=&quot;80&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                      &lt;Component id=&quot;removeButton&quot; linkSize=&quot;2&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;/Group&gt;
+                              &lt;/Group&gt;
+                              &lt;Component id=&quot;availableLabel&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;/Group&gt;
-                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;45&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;21&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;removeButton&quot; linkSize=&quot;2&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;addButton&quot; linkSize=&quot;2&quot; min=&quot;-2&quot; pref=&quot;80&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;Group type=&quot;102&quot; attributes=&quot;0&quot;&gt;
+                                  &lt;Component id=&quot;selectedLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;243&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;/Group&gt;
+                              &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                                  &lt;Component id=&quot;jScrollPane2&quot; linkSize=&quot;5&quot; min=&quot;-2&quot; pref=&quot;136&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;19&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
+                                      &lt;Component id=&quot;upButton&quot; linkSize=&quot;6&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                      &lt;Component id=&quot;downButton&quot; linkSize=&quot;6&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;/Group&gt;
+                                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;45&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;/Group&gt;
                           &lt;/Group&gt;
-                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;53&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                              &lt;Component id=&quot;selectedLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                              &lt;Component id=&quot;jScrollPane2&quot; linkSize=&quot;5&quot; min=&quot;-2&quot; pref=&quot;136&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                          &lt;/Group&gt;
-                          &lt;EmptySpace min=&quot;-2&quot; pref=&quot;65&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                       &lt;/Group&gt;
                   &lt;/Group&gt;
                 &lt;/DimensionLayout&gt;
@@ -250,19 +262,24 @@
                           &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                           &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
                               &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-                                  &lt;Component id=&quot;addButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;3&quot; attributes=&quot;0&quot;&gt;
+                                      &lt;Component id=&quot;availableLabel&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                      &lt;Component id=&quot;selectedLabel&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;/Group&gt;
                                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                                  &lt;Component id=&quot;removeButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Group type=&quot;103&quot; groupAlignment=&quot;1&quot; max=&quot;-2&quot; attributes=&quot;0&quot;&gt;
+                                      &lt;Component id=&quot;jScrollPane2&quot; alignment=&quot;0&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                                      &lt;Component id=&quot;jScrollPane1&quot; alignment=&quot;1&quot; min=&quot;-2&quot; pref=&quot;194&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
+                                  &lt;/Group&gt;
                               &lt;/Group&gt;
-                              &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;0&quot;&gt;
-                                  &lt;Component id=&quot;availableLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                              &lt;Group type=&quot;102&quot; alignment=&quot;1&quot; attributes=&quot;1&quot;&gt;
+                                  &lt;Component id=&quot;upButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                                  &lt;Component id=&quot;jScrollPane1&quot; min=&quot;-2&quot; pref=&quot;194&quot; max=&quot;-2&quot; attributes=&quot;1&quot;/&gt;
-                              &lt;/Group&gt;
-                              &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
-                                  &lt;Component id=&quot;selectedLabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Component id=&quot;downButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;EmptySpace min=&quot;-2&quot; pref=&quot;17&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                                  &lt;Component id=&quot;addButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                                   &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-                                  &lt;Component id=&quot;jScrollPane2&quot; pref=&quot;194&quot; max=&quot;32767&quot; attributes=&quot;1&quot;/&gt;
+                                  &lt;Component id=&quot;removeButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                               &lt;/Group&gt;
                           &lt;/Group&gt;
                           &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
@@ -286,7 +303,7 @@
                       &lt;/Properties&gt;
                       &lt;AuxValues&gt;
                         &lt;AuxValue name=&quot;JavaCodeGenerator_CreateCodeCustom&quot; type=&quot;java.lang.String&quot; value=&quot;new JList(new DefaultListModel());&quot;/&gt;
-                        &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;DefaultListModel lm = (DefaultListModel)availableList.getModel();&amp;#xa;Column.Type[] types = Column.Type.values();&amp;#xa;for (int i=0; i &lt; types.length; i++)&amp;#xa;    lm.addElement(types[i]);&quot;/&gt;
+                        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
                       &lt;/AuxValues&gt;
                     &lt;/Component&gt;
                   &lt;/SubComponents&gt;
@@ -304,6 +321,11 @@
                           &lt;StringArray count=&quot;0&quot;/&gt;
                         &lt;/Property&gt;
                       &lt;/Properties&gt;
+                      &lt;AuxValues&gt;
+                        &lt;AuxValue name=&quot;JavaCodeGenerator_CreateCodeCustom&quot; type=&quot;java.lang.String&quot; value=&quot;new JList(new DefaultListModel());&quot;/&gt;
+                        &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;selectedList.setSelectionMode(ListSelectionModel.SINGLE_INTERVAL_SELECTION);&quot;/&gt;
+                        &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+                      &lt;/AuxValues&gt;
                     &lt;/Component&gt;
                   &lt;/SubComponents&gt;
                 &lt;/Container&gt;
@@ -321,12 +343,41 @@
                   &lt;Properties&gt;
                     &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Add&quot;/&gt;
                   &lt;/Properties&gt;
+                  &lt;AuxValues&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;addButton.setActionCommand(&quot;ADD&quot;);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+                  &lt;/AuxValues&gt;
                 &lt;/Component&gt;
                 &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;removeButton&quot;&gt;
                   &lt;Properties&gt;
                     &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Remove&quot;/&gt;
                   &lt;/Properties&gt;
+                  &lt;AuxValues&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;removeButton.setActionCommand(&quot;REMOVE&quot;);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+                  &lt;/AuxValues&gt;
                 &lt;/Component&gt;
+                &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;upButton&quot;&gt;
+                  &lt;Properties&gt;
+                    &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Up&quot;/&gt;
+                  &lt;/Properties&gt;
+                  &lt;Events&gt;
+                    &lt;EventHandler event=&quot;actionPerformed&quot; listener=&quot;java.awt.event.ActionListener&quot; parameters=&quot;java.awt.event.ActionEvent&quot; handler=&quot;upButtonActionPerformed&quot;/&gt;
+                  &lt;/Events&gt;
+                  &lt;AuxValues&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;upButton.setActionCommand(&quot;UP&quot;);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+                  &lt;/AuxValues&gt;
+                &lt;/Component&gt;
+                &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;downButton&quot;&gt;
+                  &lt;Properties&gt;
+                    &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Down&quot;/&gt;
+                  &lt;/Properties&gt;
+                  &lt;AuxValues&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_InitCodePost&quot; type=&quot;java.lang.String&quot; value=&quot;downButton.setActionCommand(&quot;DOWN&quot;);&quot;/&gt;
+                    &lt;AuxValue name=&quot;JavaCodeGenerator_VariableModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;4&quot;/&gt;
+                  &lt;/AuxValues&gt;
+                &lt;/Component&gt;
               &lt;/SubComponents&gt;
             &lt;/Container&gt;
           &lt;/SubComponents&gt;

Modified: trunk/src/net/sf/plantlore/client/SettingsView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/SettingsView.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/SettingsView.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -6,14 +6,18 @@
 
 package net.sf.plantlore.client;
 
+import java.util.ArrayList;
+import java.util.Observable;
+import java.util.Observer;
 import javax.swing.DefaultListModel;
 import javax.swing.JList;
+import javax.swing.ListSelectionModel;
 
 /**
  *
  * @author  fraktalek
  */
-public class SettingsView extends javax.swing.JDialog {
+public class SettingsView extends javax.swing.JDialog implements Observer {
     Settings model;
     
     
@@ -22,8 +26,42 @@
         super(parent, modal);
         this.model = model;
         initComponents();
+        loadValues();
     }
     
+    public void loadValues() {
+        switch (model.getLanguage()) {
+            case Settings.CZECH:
+                czechRadioButton.setSelected(true);
+                break;
+            case Settings.DEFAULT_LANGUAGE:
+                defaultRadioButton.setSelected(true);
+                break;
+            case Settings.ENGLISH:
+                englishRadioButton.setSelected(true);
+                break;
+            default:
+                defaultRadioButton.setSelected(true);                
+        }
+
+        DefaultListModel lm = (DefaultListModel)availableList.getModel();
+
+        ArrayList&lt;Column&gt; columns = model.getUnselectedColumns();
+        for (Column column : columns)
+            if (column.type.equals(Column.Type.OCCURRENCE_ID))
+                continue;
+            else
+                lm.addElement(column);        
+        
+        lm = (DefaultListModel)selectedList.getModel();
+        columns = model.getSelectedColumns();
+        for (Column column : columns)
+            if (column.type.equals(Column.Type.OCCURRENCE_ID))
+                continue;
+            else
+                lm.addElement(column);        
+    }
+    
     /** This method is called from within the constructor to
      * initialize the form.
      * WARNING: Do NOT modify this code. The content of this method is
@@ -43,11 +81,13 @@
         jScrollPane1 = new javax.swing.JScrollPane();
         availableList = new JList(new DefaultListModel());
         jScrollPane2 = new javax.swing.JScrollPane();
-        selectedList = new javax.swing.JList();
+        selectedList = new JList(new DefaultListModel());
         availableLabel = new javax.swing.JLabel();
         selectedLabel = new javax.swing.JLabel();
         addButton = new javax.swing.JButton();
         removeButton = new javax.swing.JButton();
+        upButton = new javax.swing.JButton();
+        downButton = new javax.swing.JButton();
         cancelButton = new javax.swing.JButton();
         okButton = new javax.swing.JButton();
         helpButton = new javax.swing.JButton();
@@ -81,7 +121,7 @@
                     .add(englishRadioButton)
                     .add(czechRadioButton)
                     .add(defaultRadioButton))
-                .addContainerGap(475, Short.MAX_VALUE))
+                .addContainerGap(462, Short.MAX_VALUE))
         );
         jPanel2Layout.setVerticalGroup(
             jPanel2Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
@@ -92,7 +132,7 @@
                 .add(czechRadioButton)
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                 .add(defaultRadioButton)
-                .addContainerGap(43, Short.MAX_VALUE))
+                .addContainerGap(44, Short.MAX_VALUE))
         );
 
         org.jdesktop.layout.GroupLayout jPanel1Layout = new org.jdesktop.layout.GroupLayout(jPanel1);
@@ -109,17 +149,14 @@
             .add(jPanel1Layout.createSequentialGroup()
                 .addContainerGap()
                 .add(jPanel2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
-                .addContainerGap(141, Short.MAX_VALUE))
+                .addContainerGap(149, Short.MAX_VALUE))
         );
         jTabbedPane1.addTab(&quot;tab1&quot;, jPanel1);
 
         jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder(&quot;Displayed columns&quot;));
-        DefaultListModel lm = (DefaultListModel)availableList.getModel();
-        Column.Type[] types = Column.Type.values();
-        for (int i=0; i &lt; types.length; i++)
-        lm.addElement(types[i]);
         jScrollPane1.setViewportView(availableList);
 
+        selectedList.setSelectionMode(ListSelectionModel.SINGLE_INTERVAL_SELECTION);
         jScrollPane2.setViewportView(selectedList);
 
         availableLabel.setText(&quot;Available:&quot;);
@@ -127,9 +164,22 @@
         selectedLabel.setText(&quot;Displayed:&quot;);
 
         addButton.setText(&quot;Add&quot;);
+        addButton.setActionCommand(&quot;ADD&quot;);
 
         removeButton.setText(&quot;Remove&quot;);
+        removeButton.setActionCommand(&quot;REMOVE&quot;);
 
+        upButton.setText(&quot;Up&quot;);
+        upButton.setActionCommand(&quot;UP&quot;);
+        upButton.addActionListener(new java.awt.event.ActionListener() {
+            public void actionPerformed(java.awt.event.ActionEvent evt) {
+                upButtonActionPerformed(evt);
+            }
+        });
+
+        downButton.setText(&quot;Down&quot;);
+        downButton.setActionCommand(&quot;DOWN&quot;);
+
         org.jdesktop.layout.GroupLayout jPanel4Layout = new org.jdesktop.layout.GroupLayout(jPanel4);
         jPanel4.setLayout(jPanel4Layout);
         jPanel4Layout.setHorizontalGroup(
@@ -137,21 +187,31 @@
             .add(jPanel4Layout.createSequentialGroup()
                 .addContainerGap()
                 .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                    .add(availableLabel)
-                    .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 156, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                .add(45, 45, 45)
+                    .add(jPanel4Layout.createSequentialGroup()
+                        .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 156, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                        .add(21, 21, 21)
+                        .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
+                            .add(addButton, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 80, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                            .add(removeButton)))
+                    .add(availableLabel))
+                .add(21, 21, 21)
                 .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
-                    .add(removeButton)
-                    .add(addButton, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 80, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                .add(53, 53, 53)
-                .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
-                    .add(selectedLabel)
-                    .add(jScrollPane2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 136, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                .add(65, 65, 65))
+                    .add(jPanel4Layout.createSequentialGroup()
+                        .add(selectedLabel)
+                        .add(243, 243, 243))
+                    .add(org.jdesktop.layout.GroupLayout.LEADING, jPanel4Layout.createSequentialGroup()
+                        .add(jScrollPane2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 136, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
+                        .add(19, 19, 19)
+                        .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
+                            .add(upButton)
+                            .add(downButton))
+                        .add(45, 45, 45))))
         );
 
         jPanel4Layout.linkSize(new java.awt.Component[] {addButton, removeButton}, org.jdesktop.layout.GroupLayout.HORIZONTAL);
 
+        jPanel4Layout.linkSize(new java.awt.Component[] {downButton, upButton}, org.jdesktop.layout.GroupLayout.HORIZONTAL);
+
         jPanel4Layout.linkSize(new java.awt.Component[] {jScrollPane1, jScrollPane2}, org.jdesktop.layout.GroupLayout.HORIZONTAL);
 
         jPanel4Layout.setVerticalGroup(
@@ -160,17 +220,21 @@
                 .addContainerGap()
                 .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                     .add(jPanel4Layout.createSequentialGroup()
-                        .add(addButton)
+                        .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
+                            .add(availableLabel)
+                            .add(selectedLabel))
                         .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(removeButton))
+                        .add(jPanel4Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
+                            .add(org.jdesktop.layout.GroupLayout.LEADING, jScrollPane2)
+                            .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 194, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
                     .add(jPanel4Layout.createSequentialGroup()
-                        .add(availableLabel)
+                        .add(upButton)
                         .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 194, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
-                    .add(org.jdesktop.layout.GroupLayout.LEADING, jPanel4Layout.createSequentialGroup()
-                        .add(selectedLabel)
+                        .add(downButton)
+                        .add(17, 17, 17)
+                        .add(addButton)
                         .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
-                        .add(jScrollPane2, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 194, Short.MAX_VALUE)))
+                        .add(removeButton)))
                 .addContainerGap())
         );
 
@@ -180,14 +244,14 @@
             jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
             .add(jPanel3Layout.createSequentialGroup()
                 .addContainerGap()
-                .add(jPanel4, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 560, Short.MAX_VALUE)
+                .add(jPanel4, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                 .addContainerGap())
         );
         jPanel3Layout.setVerticalGroup(
             jPanel3Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
             .add(jPanel3Layout.createSequentialGroup()
                 .addContainerGap()
-                .add(jPanel4, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
+                .add(jPanel4, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 272, Short.MAX_VALUE)
                 .addContainerGap())
         );
         jTabbedPane1.addTab(&quot;tab2&quot;, jPanel3);
@@ -208,12 +272,12 @@
             .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                 .addContainerGap()
                 .add(helpButton)
-                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, 334, Short.MAX_VALUE)
+                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, 321, Short.MAX_VALUE)
                 .add(cancelButton)
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                 .add(okButton)
                 .addContainerGap())
-            .add(jTabbedPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 589, Short.MAX_VALUE)
+            .add(jTabbedPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 576, Short.MAX_VALUE)
         );
 
         layout.linkSize(new java.awt.Component[] {cancelButton, helpButton, okButton}, org.jdesktop.layout.GroupLayout.HORIZONTAL);
@@ -221,7 +285,7 @@
         layout.setVerticalGroup(
             layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
             .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
-                .add(jTabbedPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 314, Short.MAX_VALUE)
+                .add(jTabbedPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 323, Short.MAX_VALUE)
                 .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                 .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                     .add(helpButton)
@@ -231,6 +295,10 @@
         );
         pack();
     }// &lt;/editor-fold&gt;//GEN-END:initComponents
+
+    private void upButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_upButtonActionPerformed
+// TODO add your handling code here:
+    }//GEN-LAST:event_upButtonActionPerformed
     
     /**
      * @param args the command line arguments
@@ -242,14 +310,18 @@
             }
         });
     }
+
+    public void update(Observable o, Object arg) {
+    }
     
     // Variables declaration - do not modify//GEN-BEGIN:variables
-    private javax.swing.JButton addButton;
+    protected javax.swing.JButton addButton;
     private javax.swing.JLabel availableLabel;
-    private javax.swing.JList availableList;
+    protected javax.swing.JList availableList;
     protected javax.swing.JButton cancelButton;
     protected javax.swing.JRadioButton czechRadioButton;
     protected javax.swing.JRadioButton defaultRadioButton;
+    protected javax.swing.JButton downButton;
     protected javax.swing.JRadioButton englishRadioButton;
     protected javax.swing.JButton helpButton;
     private javax.swing.JPanel jPanel1;
@@ -261,9 +333,10 @@
     private javax.swing.JTabbedPane jTabbedPane1;
     private javax.swing.ButtonGroup languagesButtonGroup;
     protected javax.swing.JButton okButton;
-    private javax.swing.JButton removeButton;
+    protected javax.swing.JButton removeButton;
     private javax.swing.JLabel selectedLabel;
-    private javax.swing.JList selectedList;
+    protected javax.swing.JList selectedList;
+    protected javax.swing.JButton upButton;
     // End of variables declaration//GEN-END:variables
     
 }

Added: trunk/src/net/sf/plantlore/client/TableSorter.java
===================================================================
--- trunk/src/net/sf/plantlore/client/TableSorter.java	2006-05-16 17:43:19 UTC (rev 283)
+++ trunk/src/net/sf/plantlore/client/TableSorter.java	2006-05-16 18:01:09 UTC (rev 284)
@@ -0,0 +1,483 @@
+package net.sf.plantlore.client;
+
+import java.awt.*;
+import java.awt.event.*;
+import java.util.*;
+import java.util.List;
+
+import javax.swing.*;
+import javax.swing.event.TableModelEvent;
+import javax.swing.event.TableModelListener;
+import javax.swing.table.*;
+
+/**
+ * TableSorter is a decorator for TableModels; adding sorting
+ * functionality to a supplied TableModel. TableSorter does
+ * not store or copy the data in its TableModel; instead it maintains
+ * a map from the row indexes of the view to the row indexes of the
+ * model. As requests are made of the sorter (like getValueAt(row, col))
+ * they are passed to the underlying model after the row numbers
+ * have been translated via the internal mapping array. This way,
+ * the TableSorter appears to hold another copy of the table
+ * with the rows in a different order.
+ * &lt;p/&gt;
+ * TableSorter registers itself as a listener to the underlying model,
+ * just as the JTable itself would. Events recieved from the model
+ * are examined, sometimes manipulated (typically widened), and then
+ * passed on to the TableSorter's listeners (typically the JTable).
+ * If a change to the model has invalidated the order of TableSorter's
+ * rows, a note of this is made and the sorter will resort the
+ * rows the next time a value is requested.
+ * &lt;p/&gt;
+ * When the tableHeader property is set, either by using the
+ * setTableHeader() method or the two argument constructor, the
+ * table header may be used as a complete UI for TableSorter.
+ * The default renderer of the tableHeader is decorated with a renderer
+ * that indicates the sorting status of each column. In addition,
+ * a mouse listener is installed with the following behavior:
+ * &lt;ul&gt;
+ * &lt;li&gt;
+ * Mouse-click: Clears the sorting status of all other columns
+ * and advances the sorting status of that column through three
+ * values: {NOT_SORTED, ASCENDING, DESCENDING} (then back to
+ * NOT_SORTED again).
+ * &lt;li&gt;
+ * SHIFT-mouse-click: Clears the sorting status of all other columns
+ * and cycles the sorting status of the column through the same
+ * three values, in the opposite order: {NOT_SORTED, DESCENDING, ASCENDING}.
+ * &lt;li&gt;
+ * CONTROL-mouse-click and CONTROL-SHIFT-mouse-click: as above except
+ * that the changes to the column do not cancel the statuses of columns
+ * that are already sorting - giving a way to initiate a compound
+ * sort.
+ * &lt;/ul&gt;
+ * &lt;p/&gt;
+ * This is a long overdue rewrite of a class of the same name that
+ * first appeared in the swing table demos in 1997.
+ * 
+ * @author Philip Milne
+ * @author Brendon McLean 
+ * @author Dan van Enckevort
+ * @author Parwinder Sekhon
+ * @version 2.0 02/27/04
+ */
+
+public class TableSorter extends AbstractTableModel {
+    protected TableModel tableModel;
+
+    public static final int DESCENDING = -1;
+    public static final int NOT_SORTED = 0;
+    public static final int ASCENDING = 1;
+
+    private static Directive EMPTY_DIRECTIVE = new Directive(-1, NOT_SORTED);
+
+    public static final Comparator COMPARABLE_COMAPRATOR = new Comparator() {
+        public int compare(Object o1, Object o2) {
+            return ((Comparable) o1).compareTo(o2);
+        }
+    };
+    public static final Comparator LEXICAL_COMPARATOR = new Comparator() {
+        public int compare(Object o1, Object o2) {
+            return o1.toString().compareTo(o2.toString());
+        }
+    };
+
+    private Row[] viewToModel;
+    private int[] modelToView;
+
+    private JTableHeader tableHeader;
+    private MouseListener mouseListener;
+    private TableModelListener tableModelListener;
+    private Map columnComparators = new HashMap();
+    private List sortingColumns = new ArrayList();
+
+    public TableSorter() {
+        this.mouseListener = new MouseHandler();
+        this.tableModelListener = new TableModelHandler();
+    }
+
+    public TableSorter(TableModel tableModel) {
+        this();
+        setTableModel(tableModel);
+    }
+
+    public TableSorter(TableModel tableModel, JTableHeader tableHeader) {
+        this();
+        setTableHeader(tableHeader);
+        setTableModel(tableModel);
+    }
+
+    private void clearSortingState() {
+        viewToModel = null;
+        modelToView = null;
+    }
+
+    public TableModel getTableModel() {
+        return tableModel;
+    }
+
+    public void setTableModel(TableModel tableModel) {
+        if (this.tableModel != null) {
+            this.tableModel.removeTableModelListener(tableModelListener);
+        }
+
+        this.tableModel = tableModel;
+        if (this.tableModel != null) {
+            this.tableModel.addTableModelListener(tableModelListener);
+        }
+
+        clearSortingState();
+        fireTableStructureChanged();
+    }
+
+    public JTableHeader getTableHeader() {
+        return tableHeader;
+    }
+
+    public void setTableHeader(JTableHeader tableHeader) {
+        if (this.tableHeader != null) {
+            this.tableHeader.removeMouseListener(mouseListener);
+            TableCellRenderer defaultRenderer = this.tableHeader.getDefaultRenderer();
+            if (defaultRenderer instanceof SortableHeaderRenderer) {
+                this.tableHeader.setDefaultRenderer(((SortableHeaderRenderer) defaultRenderer).tableCellRenderer);
+            }
+        }
+        this.tableHeader = tableHeader;
+        if (this.tableHeader != null) {
+            this.tableHeader.addMouseListener(mouseListener);
+            this.tableHeader.setDefaultRenderer(
+                    new SortableHeaderRenderer(this.tableHeader.getDefaultRenderer()));
+        }
+    }
+
+    public boolean isSorting() {
+        return sortingColumns.size() != 0;
+    }
+
+    private Directive getDirective(int column) {
+        for (int i = 0; i &lt; sortingColumns.size(); i++) {
+            Directive directive = (Directive)sortingColumns.get(i);
+            if (directive.column == column) {
+                return directive;
+            }
+        }
+        return EMPTY_DIRECTIVE;
+    }
+
+    public int getSortingStatus(int column) {
+        return getDirective(column).direction;
+    }
+
+    private void sortingStatusChanged() {
+        clearSortingState();
+        fireTableDataChanged();
+        if (tableHeader != null) {
+            tableHeader.repaint();
+        }
+    }
+
+    public void setSortingStatus(int column, int status) {
+        Directive directive = getDirective(column);
+        if (directive != EMPTY_DIRECTIVE) {
+            sortingColumns.remove(directive);
+        }
+        if (status != NOT_SORTED) {
+            sortingColumns.add(new Directive(column, status));
+        }
+        sortingStatusChanged();
+    }
+
+    protected Icon getHeaderRendererIcon(int column, int size) {
+        Directive directive = getDirective(column);
+        if (directive == EMPTY_DIRECTIVE) {
+            return null;
+        }
+        return new Arrow(directive.direction == DESCENDING, size, sortingColumns.indexOf(directive));
+    }
+
+    private void cancelSorting() {
+        sortingColumns.clear();
+        sortingStatusChanged();
+    }
+
+    public void setColumnComparator(Class type, Comparator comparator) {
+        if (comparator == null) {
+            columnComparators.remove(type);
+        } else {
+            columnComparators.put(type, comparator);
+        }
+    }
+
+    protected Comparator getComparator(int column) {
+        Class columnType = tableModel.getColumnClass(column);
+        Comparator comparator = (Comparator) columnComparators.get(columnType);
+        if (comparator != null) {
+            return comparator;
+        }
+        if (Comparable.class.isAssignableFrom(columnType)) {
+            return COMPARABLE_COMAPRATOR;
+        }
+        return LEXICAL_COMPARATOR;
+    }
+
+    private Row[] getViewToModel() {
+        if (viewToModel == null) {
+            int tableModelRowCount = tableModel.getRowCount();
+            viewToModel = new Row[tableModelRowCount];
+            for (int row = 0; row &lt; tableModelRowCount; row++) {
+                viewToModel[row] = new Row(row);
+            }
+
+            if (isSorting()) {
+                Arrays.sort(viewToModel);
+            }
+        }
+        return viewToModel;
+    }
+
+    public int modelIndex(int viewIndex) {
+        return getViewToModel()[viewIndex].modelIndex;
+    }
+
+    private int[] getModelToView() {
+        if (modelToView == null) {
+            int n = getViewToModel().length;
+            modelToView = new int[n];
+            for (int i = 0; i &lt; n; i++) {
+                modelToView[modelIndex(i)] = i;
+            }
+        }
+        return modelToView;
+    }
+
+    // TableModel interface methods 
+
+    public int getRowCount() {
+        return (tableModel == null) ? 0 : tableModel.getRowCount();
+    }
+
+    public int getColumnCount() {
+        return (tableModel == null) ? 0 : tableModel.getColumnCount();
+    }
+
+    public String getColumnName(int column) {
+        return tableModel.getColumnName(column);
+    }
+
+    public Class getColumnClass(int column) {
+        return tableModel.getColumnClass(column);
+    }
+
+    public boolean isCellEditable(int row, int column) {
+        return tableModel.isCellEditable(modelIndex(row), column);
+    }
+
+    public Object getValueAt(int row, int column) {
+        return tableModel.getValueAt(modelIndex(row), column);
+    }
+
+    public void setValueAt(Object aValue, int row, int column) {
+        tableModel.setValueAt(aValue, modelIndex(row), column);
+    }
+
+    // Helper classes
+    
+    private class Row implements Comparable {
+        private int modelIndex;
+
+        public Row(int index) {
+            this.modelIndex = index;
+        }
+
+        public int compareTo(Object o) {
+            int row1 = modelIndex;
+            int row2 = ((Row) o).modelIndex;
+
+            for (Iterator it = sortingColumns.iterator(); it.hasNext();) {
+                Directive directive = (Directive) it.next();
+                int column = directive.column;
+                Object o1 = tableModel.getValueAt(row1, column);
+                Object o2 = tableModel.getValueAt(row2, column);
+
+                int comparison = 0;
+                // Define null less than everything, except null.
+                if (o1 == null &amp;&amp; o2 == null) {
+                    comparison = 0;
+                } else if (o1 == null) {
+                    comparison = -1;
+                } else if (o2 == null) {
+                    comparison = 1;
+                } else {
+                    comparison = getComparator(column).compare(o1, o2);
+                }
+                if (comparison != 0) {
+                    return directive.direction == DESCENDING ? -comparison : comparison;
+                }
+            }
+            return 0;
+        }
+    }
+
+    private class TableModelHandler implements TableModelListener {
+        public void tableChanged(TableModelEvent e) {
+            // If we're not sorting by anything, just pass the event along.             
+            if (!isSorting()) {
+                clearSortingState();
+                fireTableChanged(e);
+                return;
+            }
+                
+            // If the table structure has changed, cancel the sorting; the             
+            // sorting columns may have been either moved or deleted from             
+            // the model. 
+            if (e.getFirstRow() == TableModelEvent.HEADER_ROW) {
+                cancelSorting();
+                fireTableChanged(e);
+                return;
+            }
+
+            // We can map a cell event through to the view without widening             
+            // when the following conditions apply: 
+            // 
+            // a) all the changes are on one row (e.getFirstRow() == e.getLastRow()) and, 
+            // b) all the changes are in one column (column != TableModelEvent.ALL_COLUMNS) and,
+            // c) we are not sorting on that column (getSortingStatus(column) == NOT_SORTED) and, 
+            // d) a reverse lookup will not trigger a sort (modelToView != null)
+            //
+            // Note: INSERT and DELETE events fail this test as they have column == ALL_COLUMNS.
+            // 
+            // The last check, for (modelToView != null) is to see if modelToView 
+            // is already allocated. If we don't do this check; sorting can become 
+            // a performance bottleneck for applications where cells  
+            // change rapidly in different parts of the table. If cells 
+            // change alternately in the sorting column and then outside of             
+            // it this class can end up re-sorting on alternate cell updates - 
+            // which can be a performance problem for large tables. The last 
+            // clause avoids this problem. 
+            int column = e.getColumn();
+            if (e.getFirstRow() == e.getLastRow()
+                    &amp;&amp; column != TableModelEvent.ALL_COLUMNS
+                    &amp;&amp; getSortingStatus(column) == NOT_SORTED
+                    &amp;&amp; modelToView != null) {
+                int viewIndex = getModelToView()[e.getFirstRow()];
+                fireTableChanged(new TableModelEvent(TableSorter.this, 
+                                                     viewIndex, viewIndex, 
+                                                     column, e.getType()));
+                return;
+            }
+
+            // Something has happened to the data that may have invalidated the row order. 
+            clearSortingState();
+            fireTableDataChanged();
+            return;
+        }
+    }
+
+    private class MouseHandler extends MouseAdapter {
+        public void mouseClicked(MouseEvent e) {
+            JTableHeader h = (JTableHeader) e.getSource();
+            TableColumnModel columnModel = h.getColumnModel();
+            int viewColumn = columnModel.getColumnIndexAtX(e.getX());
+            int column = columnModel.getColumn(viewColumn).getModelIndex();
+            if (column != -1) {
+                int status = getSortingStatus(column);
+                if (!e.isControlDown()) {
+                    cancelSorting();
+                }
+                // Cycle the sorting states through {NOT_SORTED, ASCENDING, DESCENDING} or 
+                // {NOT_SORTED, DESCENDING, ASCENDING} depending on whether shift is pressed. 
+                status = status + (e.isShiftDown() ? -1 : 1);
+                status = (status + 4) % 3 - 1; // signed mod, returning {-1, 0, 1}
+                setSortingStatus(column, status);
+            }
+        }
+    }
+
+    private static class Arrow implements Icon {
+        private boolean descending;
+        private int size;
+        private int priority;
+
+        public Arrow(boolean descending, int size, int priority) {
+            this.descending = descending;
+            this.size = size;
+            this.priority = priority;
+        }
+
+        public void paintIcon(Component c, Graphics g, int x, int y) {
+            Color color = c == null ? Color.GRAY : c.getBackground();             
+            // In a compound sort, make each succesive triangle 20% 
+            // smaller than the previous one. 
+            int dx = (int)(size/2*Math.pow(0.8, priority));
+            int dy = descending ? dx : -dx;
+            // Align icon (roughly) with font baseline. 
+            y = y + 5*size/6 + (descending ? -dy : 0);
+            int shift = descending ? 1 : -1;
+            g.translate(x, y);
+
+            // Right diagonal. 
+            g.setColor(color.darker());
+            g.drawLine(dx / 2, dy, 0, 0);
+            g.drawLine(dx / 2, dy + shift, 0, shift);
+            
+            // Left diagonal. 
+            g.setColor(color.brighter());
+            g.drawLine(dx / 2, dy, dx, 0);
+            g.drawLine(dx / 2, dy + shift, dx, shift);
+            
+            // Horizontal line. 
+            if (descending) {
+                g.setColor(color.darker().darker());
+            } else {
+                g.setColor(color.brighter().brighter());
+            }
+            g.drawLine(dx, 0, 0, 0);
+
+            g.setColor(color);
+            g.translate(-x, -y);
+        }
+
+        public int getIconWidth() {
+            return size;
+        }
+
+        public int getIconHeight() {
+            return size;
+        }
+    }
+
+    private class SortableHeaderRenderer implements TableCellRenderer {
+        private TableCellRenderer tableCellRenderer;
+
+        public SortableHeaderRenderer(TableCellRenderer tableCellRenderer) {
+            this.tableCellRenderer = tableCellRenderer;
+        }
+
+        public Component getTableCellRendererComponent(JTable table, 
+                                                       Object value,
+                                                       boolean isSelected, 
+                                                       boolean hasFocus,
+                                                       int row, 
+                                                       int column) {
+            Component c = tableCellRenderer.getTableCellRendererComponent(table, 
+                    value, isSelected, hasFocus, row, column);
+            if (c instanceof JLabel) {
+                JLabel l = (JLabel) c;
+                l.setHorizontalTextPosition(JLabel.LEFT);
+                int modelColumn = table.convertColumnIndexToModel(column);
+                l.setIcon(getHeaderRendererIcon(modelColumn, l.getFont().getSize()));
+            }
+            return c;
+        }
+    }
+
+    private static class Directive {
+        private int column;
+        private int direction;
+
+        public Directive(int column, int direction) {
+            this.column = column;
+            this.direction = direction;
+        }
+    }
+}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000335.html">[Plantlore-dev] r283 - trunk/src/net/sf/plantlore/l10n
</A></li>
	<LI>Next message: <A HREF="000337.html">[Plantlore-dev] r285 - in trunk/src/net/sf/plantlore/client: checklist resources
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#336">[ date ]</a>
              <a href="thread.html#336">[ thread ]</a>
              <a href="subject.html#336">[ subject ]</a>
              <a href="author.html#336">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plantlore-dev">More information about the Plantlore-dev
mailing list</a><br>
</body></html>
