<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plantlore-dev] r453 - trunk/src/net/sf/plantlore/client
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plantlore-dev/2006-June/index.html" >
   <LINK REL="made" HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r453%20-%20trunk/src/net/sf/plantlore/client&In-Reply-To=%3C200606051957.k55Jv45b001906%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000582.html">
   <LINK REL="Next"  HREF="000584.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plantlore-dev] r453 - trunk/src/net/sf/plantlore/client</H1>
    <B>krater at berlios.de</B> 
    <A HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r453%20-%20trunk/src/net/sf/plantlore/client&In-Reply-To=%3C200606051957.k55Jv45b001906%40sheep.berlios.de%3E"
       TITLE="[Plantlore-dev] r453 - trunk/src/net/sf/plantlore/client">krater at berlios.de
       </A><BR>
    <I>Mon Jun  5 21:57:04 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000582.html">[Plantlore-dev] r452 - trunk/src/net/sf/plantlore/client
</A></li>
        <LI>Next message: <A HREF="000584.html">[Plantlore-dev] r454 - in trunk/src/net/sf/plantlore: middleware server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#583">[ date ]</a>
              <a href="thread.html#583">[ thread ]</a>
              <a href="subject.html#583">[ subject ]</a>
              <a href="author.html#583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: krater
Date: 2006-06-05 21:57:02 +0200 (Mon, 05 Jun 2006)
New Revision: 453

Modified:
   trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
   trunk/src/net/sf/plantlore/client/AppCoreView.java
Log:
Import bound to the Application Core Controller.

Modified: trunk/src/net/sf/plantlore/client/AppCoreCtrl.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-06-05 19:46:25 UTC (rev 452)
+++ trunk/src/net/sf/plantlore/client/AppCoreCtrl.java	2006-06-05 19:57:02 UTC (rev 453)
@@ -105,1264 +105,1525 @@
 
 import org.apache.log4j.Logger;
 
-/** Application core controller.
- *
+/**
+ * Application core controller.
+ * 
  * Creates and sets listeners for components in &lt;code&gt;AppCoreView&lt;/code&gt;.
- *
+ * 
  * @author Jakub
  */
-public class AppCoreCtrl
-{
-    Logger logger;
-    Preferences prefs;
-    private final static int MAX_RECORDS_PER_PAGE = 1000;
-    private boolean showButtonText = true;
-    
-    //--------------SUPPLIED MODELS AND VIEWS-----------------
-    AppCore model;
-    AppCoreView view;
-    
-    //--------------MODELS AND VIEWS THIS CONTROLLER CREATES-----------------
-    AddEdit addModel;
-    AddEdit editModel;
-    AddEditView addView;
-    AddEditView editView;
-    AddEditCtrl addCtrl;
-    AddEditCtrl editCtrl;
-    
-    Search searchModel;
-    SearchView searchView;
-    SearchCtrl searchCtrl;
-    
-    Settings settingsModel;
-    SettingsView settingsView;
-    SettingsCtrl settingsCtrl;
-    
-    Print printModel;
-    PrintView printView;
-    PrintCtrl printCtrl;
-    
-    // History of one occurrence
-    History historyModel;
-    HistoryView historyView;
-    HistoryCtrl historyCtrl;
-    
-    //History of &quot;database&quot; 
-    History wholeHistoryModel;
-    WholeHistoryView wholeHistoryView;
-    WholeHistoryCtrl wholeHistoryCtrl;
-    
-    //MetadataManager
-    MetadataManager metadataManagerModel;
-    MetadataManagerView metadataManagerView;
-    MetadataManagerCtrl metadataManagerCtrl;
-    
-    //PublicationManager
-    PublicationManager publicationManagerModel;
-    PublicationManagerView publicationManagerView;
-    PublicationManagerCtrl publicationManagerCtrl;
-    
-    //UserManager
-    UserManager userManagerModel;
-    UserManagerView userManagerView;
-    UserManagerCtrl userManagerCtrl;
-    
-    // Login
-    Login loginModel;
-    LoginView loginView;
-    LoginCtrl loginCtrl;
-    
-    // Export
-    ExportMng exportModel;
-    ExportMngCtrlA exportCtrl;
-    ExportProgressView exportProgressView;
-    ExportProgressCtrl exportProgressCtrl;
-    
-    // Import
-    ImportMng importModel;
-    ImportMngCtrl importCtrl;
-    ImportProgressView importProgressView;
-    ImportProgressCtrl importProgressCtrl;
-    DecisionView importDecisionView;
-    DecisionCtrl importDecisionCtrl;
-    
-    // Immutable Table Import
-    TableImportMng tableImportModel;
-    TableImportMngCtrl tableImportCtrl;
-    
-    //Detail
-    Detail detailModel;
-    DetailView detailView;
-    DetailCtrl detailCtrl;
+public class AppCoreCtrl {
+	Logger logger;
 
-    //Bridges
-    ManagerBridge managerBridge = new ManagerBridge();
-    
-    //Actions
-    AbstractAction settingsAction = new SettingsAction();
-    AbstractAction printAction = new PrintAction();
-    AbstractAction helpContentsAction = new HelpContentsAction();
-    AbstractAction helpAboutAction = new HelpAboutAction();
-    AbstractAction  exportAction = new ExportAction();
-    AbstractAction importAction = new TableImportAction();
-    
-    AbstractAction dataAuthorsAction = new DataAuthorsAction();
-    AbstractAction dataPublicationsAction = new DataPublicationsAction();
-    AbstractAction dataMetadataAction = new DataMetadataAction();
-    AbstractAction dataHistoryAction = new DataHistoryAction();
-    AbstractAction dataWholeHistoryAction = new DataWholeHistoryAction();
-    AbstractAction dataUserAction = new DataUserAction();
-    
-    AbstractAction historyAction = new DataHistoryAction();
-    AbstractAction schedaAction = new SchedaAction();
-    AbstractAction searchAction = new SearchAction();
-    AbstractAction addAction = new AddAction();
-    AbstractAction editAction = new EditAction();
-    AbstractAction deleteAction = new DeleteAction();
-    AbstractAction selectAllAction = new SelectAllAction();
-    AbstractAction selectNoneAction = new SelectNoneAction();
-    AbstractAction invertSelectedAction = new InvertSelectedAction();
-    AbstractAction nextPageAction = new NextPageAction();
-    AbstractAction prevPageAction = new PreviousPageAction();
-    AbstractAction refreshAction = new RefreshAction();
-    
-    AbstractAction loginAction = new LoginAction();
-    
-    /** Creates a new instance of AppCoreCtrl */
-    public AppCoreCtrl(AppCore model, AppCoreView view)
-    {
-        logger = Logger.getLogger(this.getClass().getPackage().getName());
-        prefs = Preferences.userNodeForPackage(this.getClass());
+	Preferences prefs;
 
-        this.model = model;
-        this.view = view;
-        view.setSettingsAction(settingsAction);
-        view.setPrintAction(printAction);
-        view.addExitListener(new ExitListener());
-        view.setHelpContentsAction(helpContentsAction);
-        view.setHelpAboutAction(helpAboutAction);
-        view.setExportAction(exportAction);
-        view.setImportAction(importAction);
-        
-        view.addDataAuthorsAction(dataAuthorsAction);
-        view.addDataPublicationsAction(dataPublicationsAction);
-        view.addDataMetadataAction(dataMetadataAction);
-        view.addDataHistoryAction(dataHistoryAction);
-        view.addDataWholeHistoryAction(dataWholeHistoryAction);
-        view.addDataUserAction(dataUserAction);
-        
-        view.setSearchAction(searchAction);
-        view.setAddAction(addAction);
-        view.setEditAction(editAction);
-        view.setDeleteAction(deleteAction);
-        view.setSchedaAction(schedaAction);
-        view.setHistoryRecordAction(historyAction);
+	private final static int MAX_RECORDS_PER_PAGE = 1000;
 
-        view.setSelectAllAction(selectAllAction);
-        view.setSelectNoneAction(selectNoneAction);
-        view.setInvertSelectedAction(invertSelectedAction);
-        view.setNextPageAction(nextPageAction);
-        view.setPrevPageAction(prevPageAction);
-        view.setSelectedRowListener(new OverviewSelectionListener());
-        view.overview.addMouseListener(new OverviewMouseListener());
-        view.refreshButton.setAction(refreshAction);
-        view.occurrencesRefresh.setAction(refreshAction);
-        
-        view.overview.addKeyListener(new OverviewKeyListener());
+	private boolean showButtonText = true;
 
-        view.addWindowListener(new AppWindowListener());
-        view.setRecordsPerPageListener(new RecordsPerPagePropertyChangeListener());
-        
-        view.setLoginAction(loginAction);
-                
-        constructDialogs();                
-               
-        // This is here in order to skip login procedure and connect to the database automatically
-        // For developement purposes only - so that we don't have to go through login each time we run Plantlore 
-        // view.initOverview();
-        
-        setDatabaseDependentCommandsEnabled(false);
-    }
-    
-    private void constructDialogs() {
-        //--- Add ---
-        addModel = new AddEdit(model.getDatabase(),false);
-        addView = new AddEditView(view, true, addModel, false);
-        addView.setTitle(L10n.getString(&quot;AddEdit.AddDialogTitle&quot;));
-        addCtrl = new AddEditCtrl(addModel, addView, false);
+	// --------------SUPPLIED MODELS AND VIEWS-----------------
+	AppCore model;
 
-        //--- Edit ---
-        editModel = new AddEdit(model.getDatabase(),true);
-        editView = new AddEditView(view, true, editModel, true);
-        editView.setTitle(L10n.getString(&quot;AddEdit.EditDialogTitle&quot;));
-        editCtrl = new AddEditCtrl(editModel, editView, true);
-        
-        
-        //--- Search ---
-        searchModel = new Search(model.getDatabase());
-        StatusBarManager sbm = view.getSBM();
-        searchModel.setColumns(model.getTableModel().getColumns());
-        searchView = new SearchView(view, true, searchModel);
-        searchView.setTitle(L10n.getString(&quot;Search.DialogTitle&quot;));
-        searchCtrl = new SearchCtrl(searchModel, searchView);
-        searchModel.addObserver(new SearchBridge());
-        
-        //--- Detail ---
-        detailModel = new Detail(model);
-        detailView = new DetailView(detailModel, view, true);
-        detailCtrl = new DetailCtrl(detailModel, detailView);        
-    }
-    
-    private void setDatabaseDependentCommandsEnabled(boolean enabled) {
-        settingsAction.setEnabled(enabled);
-        printAction.setEnabled(enabled);
-        exportAction.setEnabled(enabled);
-        importAction.setEnabled(enabled);
-        
-        dataAuthorsAction.setEnabled(enabled);
-        dataPublicationsAction.setEnabled(enabled);
-        dataMetadataAction.setEnabled(enabled);
-        dataHistoryAction.setEnabled(enabled);
-        dataWholeHistoryAction.setEnabled(enabled);
-        dataUserAction.setEnabled(enabled);
-        
-        historyAction.setEnabled(enabled);
-        schedaAction.setEnabled(enabled);
-        searchAction.setEnabled(enabled);
-        addAction.setEnabled(enabled);
-        editAction.setEnabled(enabled);
-        deleteAction.setEnabled(enabled);
+	AppCoreView view;
 
-        selectAllAction.setEnabled(enabled);
-        selectNoneAction.setEnabled(enabled);
-        invertSelectedAction.setEnabled(enabled);
-        nextPageAction.setEnabled(enabled);
-        prevPageAction.setEnabled(enabled);  
-        view.recordsPerPage.setEnabled(enabled);
-        refreshAction.setEnabled(enabled);
-    }
-    
-    /** Handles click to menu item Settings.
-     *
-     */
-    class SettingsAction extends AbstractAction {
-        public SettingsAction() {
-            putValue(NAME, L10n.getString(&quot;Settings&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;SettingsTooltip&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Settings&quot;));            
-        }
-        public void actionPerformed(ActionEvent actionEvent)
-        {
-            logger.info(&quot;Settings selected&quot;);
-            //If the dialog is already constructed then use it. Otherwise construct it first.
-            if (settingsModel == null) {
-                settingsModel = new Settings();
-                settingsModel.setSelectedColumns(model.getTableModel().getColumns());
-                settingsModel.addObserver(new SettingsBridge());
-                settingsView = new SettingsView(view,true,settingsModel);
-                settingsCtrl = new SettingsCtrl(settingsModel, settingsView);
-            } 
-            //settingsView.loadValues();
-            settingsView.setVisible(true);
-        }
-    }
-    
-    /** Assumes that user doesn't work with the Search dialog at time of the update.
-     *
-     */
-    class SettingsBridge implements Observer {        
-        public void update(Observable o, Object arg) {
-            if (arg instanceof String) {                
-                String s = (String)arg;
-                if (s.equals(&quot;COLUMNS&quot;)) {
-                    logger.debug(&quot;User changed columns in settings. Propagating the change to overview and config.&quot;);
-                    ArrayList&lt;Column&gt; columns = settingsModel.getSelectedColumns();
-                    model.getTableSorter().setColumns(columns);
-                    model.getMainConfig().setColumns(columns);
-                    
-                    searchModel.setColumns(columns);
-                    searchModel.clear();
-                    searchModel.constructQuery();
-                }
-            }
-        }        
-    }
-    
-    class PrintAction extends AbstractAction {
-        public PrintAction() {
-            putValue(NAME, L10n.getString(&quot;Print&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;PrintTooltip&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Print&quot;));                        
-        }
-        public void actionPerformed(ActionEvent actionEvent)
-        {
-            if (printModel == null) {
-                printModel = new Print();
-                printView = new PrintView(view, true, printModel);
-                printCtrl = new PrintCtrl(printModel, printView);
-            }
-            Selection sel = model.getTableModel().getSelection();
-            if (sel.values().size() &lt; 1) {
-                JOptionPane.showMessageDialog(view, &quot;Please check at least one record.&quot;);
-                return;
-            }
-            printModel.setSource(model.getDatabase(), sel);
-            printView.setVisible(true);
-        }
-    }
-    
-    
-    /** Handles the exit command.
-     *
-     * Maybe settings should be stored first?
-     */
-    class ExitListener implements ActionListener {
-        public void actionPerformed(ActionEvent actionEvent) 
-        {
-            try {
-                model.savePreferences();
-            } catch (IOException ex) {
-                JOptionPane.showMessageDialog(view, &quot;Problem while saving configuration: &quot;+ex.getMessage());
-            }
-            // Destroy the DBLayer
-            //model.getDatabase().destroy();  --- takhle se to nesmi delat, musi ji znicit factory, ktera ji vyrobila
-            System.exit(0);
-        }
-    }
+	// --------------MODELS AND VIEWS THIS CONTROLLER CREATES-----------------
+	AddEdit addModel;
 
-    class HelpContentsAction extends AbstractAction {
-        public HelpContentsAction() {
-            putValue(NAME, L10n.getString(&quot;helpContents&quot;));
-            putValue(SHORT_DESCRIPTION, &quot;Help contents&quot;);
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;helpContents&quot;));
-        }
-        public void actionPerformed(ActionEvent actionEvent) {
-            System.out.println(&quot;Help contents selected&quot;);
-        }
-    }
-        
-    class HelpAboutAction extends AbstractAction {
-        public HelpAboutAction() {
-            putValue(NAME, L10n.getString(&quot;helpAbout&quot;));
-            putValue(SHORT_DESCRIPTION, &quot;Help about tooltip&quot;);
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;helpAbout&quot;));
-        }
-        public void actionPerformed(ActionEvent actionEvent)
-        {
-            System.out.println(&quot;Help about selected&quot;);
-        }
-    }
-    
-    class ImportAction extends AbstractAction {
-        public ImportAction() {
-            putValue(NAME, L10n.getString(&quot;dataImport&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;dataImportTooltip&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;dataImport&quot;));            
-        } 
+	AddEdit editModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-        	if(importModel == null) {
-        		try {
-        			importModel = new ImportMng(model.getDatabase());
-        			importProgressView = new ImportProgressView(importModel);
-        			importProgressCtrl = new ImportProgressCtrl(importModel, importProgressView);
-        			
-        			importCtrl = new ImportMngCtrl(importModel, view, importProgressView);
-        			
-        			importDecisionView = new DecisionView(importModel);
-        			importDecisionCtrl = new DecisionCtrl(importModel, importDecisionView);
-        		} catch(ImportException e) {
-        			logger.error(&quot;Import MVC cannot be created. &quot; + e.getMessage());
-        			return;
-        		}
-        	}
-        	
-        	if(importModel.isImportInProgress())
-        		importProgressView.setVisible(true);
-        	else
-        		importCtrl.setVisible(true);
-        	
-        }
-    }
-    
-    
-    class TableImportAction extends AbstractAction {
-        public TableImportAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.TableImport&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.TableImportTT&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.TableImport&quot;));            
-        } 
+	AddEditView addView;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-        	if(tableImportModel == null) {
-        		try {
-        			tableImportModel = new TableImportMng( model.getDatabase() );
-        			tableImportCtrl = new TableImportMngCtrl( tableImportModel, view );
-        		} catch(ImportException e) {
-        			logger.error(&quot;Import MVC cannot be created. &quot; + e.getMessage());
-        			return;
-        		}
-        	}
+	AddEditView editView;
 
-        	tableImportCtrl.setVisible( true );
-        }
-    }
-    
-    
-    class ExportAction extends AbstractAction {
-        public ExportAction() {
-            putValue(NAME, L10n.getString(&quot;dataExport&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;dataExportTooltip&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;dataExport&quot;));            
-        } 
+	AddEditCtrl addCtrl;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            // Create a new dialog if it already doesn't exist.
-            if(exportModel == null) {
-            	try {
-            		exportModel = new ExportMng(model.getDatabase());
-            		exportProgressView = new ExportProgressView(null);
-            		exportProgressCtrl = new ExportProgressCtrl(null, exportProgressView);
-            		exportCtrl = new ExportMngCtrlA(exportModel, view, exportProgressView, exportProgressCtrl);
-            	} catch(ExportException e) {
-            		logger.error(&quot;Export MVC cannot be created. &quot; + e.getMessage());
-            		return;
-            	}
-            }
-            // Display the progress view if an export is already running.
-            if(exportModel.isAnExportInProgress())
-        		exportProgressView.setVisible(true);
-            // Display the Export dialog.
-            else {
-            	try {
-            		/*==============================================================
-            		 * Right after the startup the searchModel may not be initialized!
-            		 * (if Export is called prior to Search...)
-            		 * 
-            		 * FIXME: Solve this with Jakub.
-            		 *==============================================================*/
-            		SelectQuery query;
-            		if(searchModel == null) {
-            			System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; CREATING A FAKE QUERY&quot;);
-            			query = model.getDatabase().createQuery(Occurrence.class); // fake the query
-            		}
-            		else {
-            			Object[] queryParam = searchModel.constructExportQuery();
-            			query = (SelectQuery)queryParam[0];
-            			if( (Boolean)queryParam[1] ) { // use projections
-            				exportModel.useProjections(true);
-            				exportModel.setRootTable( (Class)queryParam[2] );
-            			}
-            		}
-            		exportModel.setSelectQuery( query );
-            		exportModel.setSelection(model.getTableModel().getSelection());
-            	} catch (DBLayerException e) {
-            		JOptionPane.showMessageDialog(view, &quot;DBLayer Exception: &quot;+e);
-            		return;
-            	} catch (RemoteException e) {
-            		JOptionPane.showMessageDialog(view, &quot;Remote Exception: &quot;+e);
-            		return;
-            	}
-            	exportCtrl.setVisible(true);
-            }
-        }
-    }
+	AddEditCtrl editCtrl;
 
-    class AddAction extends AbstractAction {
-        public AddAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.Add&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/Add24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.AddTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_A, ActionEvent.CTRL_MASK));
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Add&quot;));            
-        } 
+	Search searchModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {         
-            try {
-                if (model.getDatabase().getUserRights().getAdd() != 1) {
-                    JOptionPane.showMessageDialog(view, L10n.getString(&quot;AddEdit.InsufficientAddRights&quot;),L10n.getString(&quot;AddEdit.InsufficientRightsTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;
-                }
-            } catch (RemoteException ex) {
-                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.RemoteException&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Error.RemoteExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                logger.error(ex);
-            }
-            addModel.clear();
-            addView.setVisible(true);
-        }
-    }
-    
-    class EditAction extends AbstractAction {
-        public EditAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.Edit&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/Edit24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.EditTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_E, ActionEvent.CTRL_MASK));
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Edit&quot;));            
-        } 
-        
-        public void actionPerformed(ActionEvent actionEvent) {
-            Object[] row = model.getSelectedRow();
-            
-            try {
-                if (!model.isEditAllowed(model.getSelectedOccurrence())) {
-                    JOptionPane.showMessageDialog(view, L10n.getString(&quot;AddEdit.InsufficientEditRights&quot;),L10n.getString(&quot;AddEdit.InsufficientRightsTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;
-                }
-                editModel.setRecord((Integer) row[row.length-1]);
-            } catch (DBLayerException ex) {
-                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.DBLayerException&quot;)+&quot;\n&quot;+ex.getErrorInfo(),L10n.getString(&quot;Error.DBLayerExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                logger.error(ex+&quot;: &quot;+ex.getErrorInfo());
-            } catch (RemoteException ex) {
-                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.RemoteException&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Error.RemoteExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                logger.error(ex);
-            }
-            editView.loadComponentData();
-            editView.setVisible(true);
-        }
-    }
-    
-    class DeleteAction extends AbstractAction {
-        public DeleteAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.Delete&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/Delete24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.DeleteTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_DELETE,0));
+	SearchView searchView;
 
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Delete&quot;));            
-        } 
+	SearchCtrl searchCtrl;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            Selection selection = model.getTableModel().getSelection();
-            Object[] arg = { selection.values().size() };
-            
-            if (arg[0].equals(0)) {
-                JOptionPane.showMessageDialog(view, L10n.getString(&quot;Message.CheckAnOccurrence&quot;),L10n.getString(&quot;Message.CheckAnOccurrenceTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                return;                
-            }
-            
-            try {
-                for (Integer occId : selection.values())
-                    if (!model.isEditAllowed(occId)) {
-                        JOptionPane.showMessageDialog(view, L10n.getString(&quot;Delete.InsufficientRights&quot;), L10n.getString(&quot;Delete.InsufficientRightsTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                        return;
-                    }
-            } catch (RemoteException ex) {  
-                logger.error(&quot;Remote problem: &quot;+ex);
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;RemoteException: &quot;+ex);
-            } catch (DBLayerException ex) {
-                logger.error(&quot;Database problem: &quot;+ex);
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;DBLayerException: &quot;+ex);
-            }
-            
-            int choice = JOptionPane.showConfirmDialog(view, 
-                    L10n.getFormattedString(&quot;Message.DeleteRecords&quot;,arg),
-                    L10n.getString(&quot;Message.DeleteRecordsTitle&quot;),
-                    JOptionPane.OK_CANCEL_OPTION,
-                    JOptionPane.WARNING_MESSAGE);
+	Settings settingsModel;
 
-            switch (choice) {
-                case JOptionPane.CANCEL_OPTION:
-                    return;
-                case JOptionPane.OK_OPTION:
-                    logger.info(&quot;Deleting &quot;+arg[0]+&quot; records.&quot;);
+	SettingsView settingsView;
 
-                    Task task = model.deleteSelected();
-                    
-                    ProgressBar progressBar = new ProgressBar(task,view,true) {
-                        public void exceptionHandler(Exception ex) {
-                            if (ex instanceof DBLayerException) {
-                                DBLayerException e = (DBLayerException)ex;
-                                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.DBLayerException&quot;)+&quot;\n&quot;+e.getErrorInfo(),L10n.getString(&quot;Error.DBLayerExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                                logger.error(e+&quot;: &quot;+e.getErrorInfo());
-                                getTask().stop();
-                                return;
-                            }
-                            if (ex instanceof RemoteException) {
-                                RemoteException e = (RemoteException)ex;
-                                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.RemoteException&quot;)+&quot;\n&quot;+e.getMessage(),L10n.getString(&quot;Error.RemoteExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                                logger.error(e);
-                                getTask().stop();
-                                return;
-                            }
-                            JOptionPane.showMessageDialog(view,L10n.getString(&quot;Delete.Message.UnknownException&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Delete.Message.UnkownExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                            logger.error(ex);                            
-                        }              
-                        
-                        public void afterStopped(Object value) {
-                            refreshOverview(false); //false -&gt; do not create task, refresh the overview directly in this thread
-                        }
-                    };
-                    progressBar.setTitle(L10n.getString(&quot;Delete.ProgressTitle&quot;));
-                    
-                    task.start();
-                    break;
-            }//switch
-        }
-    }
+	SettingsCtrl settingsCtrl;
 
-    class SelectAllAction extends AbstractAction {
-        public SelectAllAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.SelectAll&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SelectAllTT&quot;));
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.SelectAll&quot;));            
-        } 
+	Print printModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            if (model.getResultsCount() &gt; 0)
-                model.selectAll();
-        }
-    }
+	PrintView printView;
 
-    class SelectNoneAction extends AbstractAction {
-        public SelectNoneAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.SelectNone&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SelectNoneTT&quot;));
-//            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.SelectNone&quot;));            
-        } 
+	PrintCtrl printCtrl;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            if (model.getResultsCount() &gt; 0)
-                model.selectNone();
-        }
-    }
-    
-    class InvertSelectedAction extends AbstractAction {
-        public InvertSelectedAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.InvertSelected&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.InvertSelectedTT&quot;));
-//            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.InvertSelected&quot;));            
-        } 
+	// History of one occurrence
+	History historyModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            if (model.getResultsCount() &gt; 0)
-                model.invertSelected();
-        }
-    }
+	HistoryView historyView;
 
-    class SearchAction extends AbstractAction {
-        public SearchAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.Search&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/Search24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SearchTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_S, ActionEvent.CTRL_MASK));
-                        
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Search&quot;));            
-        } 
+	HistoryCtrl historyCtrl;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            searchModel.clear();
-            searchView.setVisible(true);
-        }
-    }
-    
-    class SearchBridge implements Observer {
-        public void update(Observable o, Object arg) {
-            if (arg != null &amp;&amp; arg instanceof Integer) {
-                logger.debug(&quot;Fetching new result id from Search model. Storing it to AppCore model.&quot;);
-                try {
-                    model.setResultId(searchModel.getNewResultId(), searchModel.getNewSelectQuery());
-                } catch (RemoteException ex) {
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.RemoteException&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Error.RemoteExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                    logger.error(ex);
-                } catch (DBLayerException ex) {
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.DBLayerException&quot;)+&quot;\n&quot;+ex.getErrorInfo(),L10n.getString(&quot;Error.DBLayerExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                    logger.error(ex+&quot;: &quot;+ex.getErrorInfo());
-                }
-                //model.setExportQuery(searchModel.getExportQuery(), false, Occurrence.class);
-            }
-        }
-        
-        
-    }
-    
-    class SchedaAction extends AbstractAction {
-        public SchedaAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.Scheda&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SchedaTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_X, ActionEvent.CTRL_MASK));
-//            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Scheda&quot;));            
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/ComposeMail24.gif&quot;));
-        } 
+	// History of &quot;database&quot;
+	History wholeHistoryModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            try {
-                if (model.getTableModel().getSelection().values().size() &lt; 1) {
-                    JOptionPane.showMessageDialog(view, L10n.getString(&quot;Message.CheckAnOccurrence&quot;),L10n.getString(&quot;Message.CheckAnOccurrenceTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;
-                }
+	WholeHistoryView wholeHistoryView;
 
-                final JasperReport schedaReport;
-                InputStream schedaIs = this.getClass().getClassLoader().getResourceAsStream(&quot;net/sf/plantlore/client/resources/SchedaA6.jasper&quot;);
+	WholeHistoryCtrl wholeHistoryCtrl;
 
-                try {
-                    ObjectInputStream schedaOis = new ObjectInputStream(schedaIs);
-                    schedaReport = (JasperReport) schedaOis.readObject();
-                } catch (FileNotFoundException ex) {
-                    logger.error(&quot;Problem loading jasper report resource: &quot;+ex);
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.InternalProblem&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Error.InternalProblemTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;                    
-                } catch (IOException ex) {                    
-                    logger.error(&quot;Problem loading jasper report resource: &quot;+ex);
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.InternalProblem&quot;)+ex.getMessage(),L10n.getString(&quot;Error.InternalProblemTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;
-                } catch (ClassNotFoundException ex) {
-                    logger.error(&quot;Problem loading jasper report resource: &quot;+ex);
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.InternalProblem&quot;)+ex.getMessage(),L10n.getString(&quot;Error.InternalProblemTitle&quot;),JOptionPane.INFORMATION_MESSAGE);
-                    return;                    
-                }
-                                
-                prefs = Preferences.userNodeForPackage(AppCoreCtrl.class);
-                String h1 = prefs.get(&quot;HEADER_ONE&quot;,&quot;Set the first header in settings, please.&quot;);
-                String h2 = prefs.get(&quot;HEADER_TWO&quot;,&quot;Set the second header in settings, please.&quot;);
-                final HashMap params = new HashMap();
-                params.put(&quot;HEADER_ONE&quot;,h1);
-                params.put(&quot;HEADER_TWO&quot;,h2);
-                
-                Task task = new Task() {
-                    JasperPrint jasperPrint;
-                    public Object task() throws JRException {
-                        jasperPrint = JasperFillManager.fillReport(
-                              schedaReport, params, new JasperDataSource(
-                                                    model.getDatabase(), model.getTableModel().getSelection() )
-                                                    );
-                        fireStopped(jasperPrint);
-                        return jasperPrint;
-                    }
-                };
-                
-                ProgressBar pb = new ProgressBar(task, view, true) {
-                    public void exceptionHandler(final Exception ex) {
-                        logger.error(&quot;Error while filling jasper report in SchedaAction: &quot;+ex);
-                        ex.printStackTrace();
-                        SwingUtilities.invokeLater(new Runnable() {
-                            public void run() {
-                                JOptionPane.showMessageDialog(view.getParent(), L10n.getString(&quot;Print.Message.BrokenReport&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Print.Message.BrokenReport&quot;),JOptionPane.WARNING_MESSAGE);            
-                            }
-                        });
-                        getTask().stop();
-                    }                    
-                    public void afterStopped(final Object value) {
-                        SwingUtilities.invokeLater(new Runnable() {
-                            public void run() {
-                                new SchedaView(view, true, (JasperPrint)value).setVisible(true);  
-                            }                            
-                        });
-                    }
-                };
-                pb.setTitle(L10n.getString(&quot;Scheda.ProgressTitle&quot;));
-                
-                task.start();
-            } catch(Exception ex) { // Unreachable CATCH block
-                logger.error(&quot;Broken report: &quot;+ex);
-                JOptionPane.showMessageDialog(view,L10n.getString(&quot;Print.Message.BrokenReport&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Print.Message.BrokenReport&quot;),JOptionPane.WARNING_MESSAGE);
-                ex.printStackTrace();
-            }
-        }
-    }
-    
-    class PreviousPageAction extends AbstractAction {
-        public PreviousPageAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.PrevPage&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.PrevPageTT&quot;));
-//            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.PrevPage&quot;));            
-        } 
+	// MetadataManager
+	MetadataManager metadataManagerModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            try {
-                model.prevPage();
-            } catch (RemoteException ex) {
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;RemoteException: &quot;+ex);
-            } catch (DBLayerException ex) {
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;DBLayerException: &quot;+ex);
-            }
-        }
-    }
-    
-    class NextPageAction extends AbstractAction {
-        public NextPageAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.NextPage&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.NextPageTT&quot;));
-//            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.NextPage&quot;));            
-        } 
+	MetadataManagerView metadataManagerView;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            try {
-                model.nextPage();
-            } catch (RemoteException ex) {
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;RemoteException: &quot;+ex);
-            } catch (DBLayerException ex) {
-                ex.printStackTrace();
-                JOptionPane.showMessageDialog(view,&quot;DBLayerException: &quot;+ex);
-            }
-        }
-    }
+	MetadataManagerCtrl metadataManagerCtrl;
 
-    class AppWindowListener extends WindowAdapter {
-        public void windowClosing(WindowEvent e)
-        {
-            try {
-                model.savePreferences();
-            } catch (IOException ex) {
-                JOptionPane.showMessageDialog(view, &quot;Problem while saving configuration: &quot;+ex.getMessage());
-            }
-        }
-    }
+	// PublicationManager
+	PublicationManager publicationManagerModel;
 
-    class DataAuthorsAction extends AbstractAction {
-        public DataAuthorsAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.MenuDataAuthors&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.MenuDataAuthorsTT&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.MenuDataAuthors&quot;));                        
-        }
-        public void actionPerformed(ActionEvent e) {
-            AuthorManager authModel = new AuthorManager(model.getDatabase());
-            AuthorManagerView authView = new AuthorManagerView(authModel, view, true);
-            AuthorManagerCtrl authCtrl = new AuthorManagerCtrl(authModel, authView);
-            authView.setVisible(true);                
-        }
-        
-    }
-    
-    
-    class DataPublicationsAction extends AbstractAction {
-        public DataPublicationsAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.MenuDataPublications&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.MenuDataPublicationsTT&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.MenuDataPublications&quot;));
-        }
+	PublicationManagerView publicationManagerView;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            publicationManagerModel = new PublicationManager(model.getDatabase());
-            publicationManagerView = new PublicationManagerView(publicationManagerModel, view, true);
-            publicationManagerCtrl = new PublicationManagerCtrl(publicationManagerModel, publicationManagerView);
-            publicationManagerView.setVisible(true); 
-        }
-    }   
-    
-        class DataUserAction extends AbstractAction {
-        public DataUserAction() {
-             putValue(NAME, L10n.getString(&quot;userManager&quot;));
-        }
+	PublicationManagerCtrl publicationManagerCtrl;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            System.out.println(&quot;UserManager&quot;);
+	// UserManager
+	UserManager userManagerModel;
 
-            userManagerModel = new UserManager(model.getDatabase());
-            userManagerView = new UserManagerView(userManagerModel, view, true);
-            userManagerCtrl = new UserManagerCtrl(userManagerModel, userManagerView);
-            userManagerView.setVisible(true); 
-        }
-    }    
-    
-    class DataHistoryAction extends AbstractAction {
-        public DataHistoryAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.History&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/History24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.HistoryTT&quot;));
-//            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_S, ActionEvent.CTRL_MASK));
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.History&quot;));                        
-        }
-        
-        public void actionPerformed(ActionEvent e) {
-            System.out.println(&quot;Undo selected&quot;);
-            //toto volani historie nebude v menu, ale jako tlacitko pro vybrany zaznam        
-            //o vybranem zaznamu predame informace, ktere chceme o nem v historii zobrazit
-            //jmeno rosliny, jmeno autora a lokaci a idOccurrences
-                                   
-            historyModel = new History(model.getDatabase(), model.getSelectedOccurrence());
-            historyView = new HistoryView(historyModel, view, true);
-            historyCtrl = new HistoryCtrl(historyModel, historyView);
-            historyModel.addObserver(managerBridge);
-            historyView.setVisible(true);                         
-        }
-        
-    }
-        
-    class DataWholeHistoryAction extends AbstractAction {
-        public DataWholeHistoryAction() {
-             putValue(NAME, L10n.getString(&quot;wholeHistory&quot;));
-        }
+	UserManagerView userManagerView;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            System.out.println(&quot;Whole history - Undo selected&quot;);
+	UserManagerCtrl userManagerCtrl;
 
-            wholeHistoryModel = new History(model.getDatabase());
-            wholeHistoryView = new WholeHistoryView(wholeHistoryModel, view, true);
-            wholeHistoryCtrl = new WholeHistoryCtrl(wholeHistoryModel, wholeHistoryView);
-            wholeHistoryModel.addObserver(managerBridge);
-            wholeHistoryView.setVisible(true); 
-        }
-    }    
-    
-   /* 
-    *
-    */
-    class DataMetadataAction extends AbstractAction {
-        public DataMetadataAction() {
-             putValue(NAME, L10n.getString(&quot;metadataManager&quot;));
-             putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_M, ActionEvent.CTRL_MASK));
-        }
+	// Login
+	Login loginModel;
 
-        public void actionPerformed(ActionEvent actionEvent) {
-            System.out.println(&quot;Metadata Manager&quot;);
+	LoginView loginView;
 
-            metadataManagerModel = new MetadataManager(model.getDatabase());
-            metadataManagerView = new MetadataManagerView(metadataManagerModel, view, true);
-            metadataManagerCtrl = new MetadataManagerCtrl(metadataManagerModel, metadataManagerView);
-            metadataManagerModel.addObserver(managerBridge);
-            metadataManagerView.setVisible(true);
-        }
-    }              
-    
-    class RecordsPerPagePropertyChangeListener implements PropertyChangeListener {
-        public void propertyChange(PropertyChangeEvent e) {
-            JFormattedTextField tf = (JFormattedTextField)e.getSource();
-            if (e != null &amp;&amp; e.getPropertyName().equals(&quot;value&quot;)) 
-            {
-                int i = ((Number)tf.getValue()).intValue(); 
-                if (i &gt; MAX_RECORDS_PER_PAGE) {
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Overview.Warning.MaxRecordsPerPage&quot;)+&quot; &quot;+MAX_RECORDS_PER_PAGE);
-                    Object obj = e.getOldValue();
-                    if (obj != null)
-                        tf.setValue(obj);
-                    else // either multiple properties changed or there was no previous value - the value should better be at least 1 anyway...
-                        tf.setValue(prefs.getInt(&quot;recordsPerPage&quot;, 30));
-                    return;
-                }
-                
-                if (i &lt; 1)
-                {
-                    Object obj = e.getOldValue();
-                    if (obj != null)
-                        tf.setValue(obj);
-                    else // either multiple properties changed or there was no previous value - the value should better be at least 1 anyway...
-                        tf.setValue(1);
-                } else {
-                    model.setRecordsPerPage(i);                    
-                }
-            }
-        }  
-    }
-    
-    class OverviewSelectionListener implements ListSelectionListener {
-        public void valueChanged(ListSelectionEvent e) {
-            //Ignore extra messages.
-            if (e.getValueIsAdjusting()) return;
-            
-            ListSelectionModel lsm =
-                    (ListSelectionModel)e.getSource();
-            if (lsm.isSelectionEmpty()) {
-                //no rows are selected
-            } else {
-                int selectedRow = lsm.getMinSelectionIndex();
-                model.setSelectedRow(selectedRow);
-                //selectedRow is selected
-            }
-        }
-    }
-    
-    class OverviewMouseListener implements MouseListener {
-        public void mouseClicked(MouseEvent e) {
-            if (e.getClickCount() == 2) {
-                JOptionPane.showMessageDialog(view,&quot;Double click! On row #&quot;+model.getSelectedRowNumber());
-            }
-            System.out.println(&quot;Click count = &quot;+e.getClickCount());
-        }
+	LoginCtrl loginCtrl;
 
-        public void mousePressed(MouseEvent e) {
-        }
+	// Export
+	ExportMng exportModel;
 
-        public void mouseReleased(MouseEvent e) {
-        }
+	ExportMngCtrlA exportCtrl;
 
-        public void mouseEntered(MouseEvent e) {
-        }
+	ExportProgressView exportProgressView;
 
-        public void mouseExited(MouseEvent e) {
-        }
-        
-    }
-    
-    class OverviewKeyListener implements KeyListener {
-        public void keyTyped(KeyEvent e) {
-            System.out.println(&quot;Typed key: char=&quot;+e.getKeyChar()+&quot; code=&quot;+e.getKeyCode()+&quot; text=&quot;+e.getKeyText(e.getKeyChar())+&quot; modif=&quot;+e.getKeyModifiersText(e.getModifiers()));
-            if (e.getKeyText(e.getKeyChar()).equals(&quot;Space&quot;))
-                model.invertSelectedOnCurrentRow();
-            if (e.getKeyText(e.getKeyChar()).equals(&quot;Enter&quot;)) {
-                try {
-                    int resultNumber = model.getSelectedResultNumber();
-                    if (resultNumber != model.getResultsCount())
-                        model.selectAndShow(resultNumber - 1);//After Enter the hyperactive JTable moves selection to next row, so we need to correct that
-                    detailModel.load(model.getSelectedResultNumber());
-                    detailView.setVisible(true);
-                } catch (RemoteException ex) {  
-                    JOptionPane.showMessageDialog(view,&quot;RemoteException: &quot;+ex);
-                    ex.printStackTrace();
-                } catch (DBLayerException ex) {
-                    JOptionPane.showMessageDialog(view,&quot;DBLayerException: &quot;+ex);
-                    ex.printStackTrace();
-                }
-            }
-        }
+	ExportProgressCtrl exportProgressCtrl;
 
-        public void keyPressed(KeyEvent e) {
-            
-        }
+	// Import
+	ImportMng importModel;
 
-        public void keyReleased(KeyEvent e) {
-        }
-        
-    }
-    
-    class LoginAction extends AbstractAction {
-        public LoginAction() {
-            putValue(NAME, L10n.getString(&quot;Overview.MenuFileLogin&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.MenuFileLoginTT&quot;));
-            putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.MenuFileLogin&quot;));                        
-        }
-        public void actionPerformed(ActionEvent arg0) {
-                // Reuse the existing dialogs, hide'em when they're no longer needed.
-                if(loginModel == null) {
-                	loginModel = new Login(new RMIDBLayerFactory(), model.getMainConfig());
-                	loginModel.addObserver(new DatabaseChange());
-                	loginView = new LoginView(view, loginModel);
-                	loginCtrl = new LoginCtrl(loginModel, loginView);
-                }
-                loginCtrl.setVisible(true);
-        }
-    }
-    
-    // Update all information about the database layer and inform everyone who has to be informed 
-    class DatabaseChange implements Observer {
-        /** Fetches combobox items from AppCore and stores them to dialog models.
-         *
-         */
-        private void fillDialogModels() {
-            logger.debug(&quot;Filling Add model.&quot;);
-                addModel.setAuthors(model.getAuthors());
-                addModel.setAuthorRoles(model.getAuthorRoles());
-                addModel.setPlants(model.getPlants());
-                addModel.setVillages(model.getVillages());
-                addModel.setPhytNames(model.getPhytNames());
-                addModel.setPhytCodes(model.getPhytCodes());
-                addModel.setCountries(model.getCountries());
-                addModel.setSources(model.getSources());
-                addModel.setPublications(model.getPublications());
-                addModel.setProjects(model.getProjects());
-                addModel.setTerritories(model.getTerritories());            
+	ImportMngCtrl importCtrl;
 
-            logger.debug(&quot;Filling Edit model.&quot;);
-                editModel.setAuthors(model.getAuthors());
-                editModel.setAuthorRoles(model.getAuthorRoles());
-                editModel.setPlants(model.getPlants());
-                editModel.setVillages(model.getVillages());
-                editModel.setPhytNames(model.getPhytNames());
-                editModel.setPhytCodes(model.getPhytCodes());
-                editModel.setCountries(model.getCountries());
-                editModel.setSources(model.getSources());
-                editModel.setPublications(model.getPublications());
-                editModel.setProjects(model.getProjects());
-                editModel.setTerritories(model.getTerritories());
+	ImportProgressView importProgressView;
 
-            logger.debug(&quot;Filling Search model.&quot;);
-                searchModel.setAuthors(model.getAuthors());
-                searchModel.setAuthorRoles(model.getAuthorRoles());
-                searchModel.setPlants(model.getPlants());
-                searchModel.setVillages(model.getVillages());
-                searchModel.setPhytNames(model.getPhytNames());
-                searchModel.setPhytCodes(model.getPhytCodes());
-                searchModel.setCountries(model.getCountries());
-                searchModel.setSources(model.getSources());
-                searchModel.setPublications(model.getPublications());
-                searchModel.setProjects(model.getProjects());
-                searchModel.setTerritories(model.getTerritories());
-        }
+	ImportProgressCtrl importProgressCtrl;
 
-    	public void update(Observable targer, Object parameter) {
-    		if(parameter != null &amp;&amp; parameter instanceof DBLayer) {
-                        loginAction.setEnabled(false);
-                        view.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
+	DecisionView importDecisionView;
 
-                        System.out.println(&quot;[!] DBLayer retrieval.&quot;);
-    			DBLayer dblayer = loginModel.getDBLayer();
+	DecisionCtrl importDecisionCtrl;
 
+	// Immutable Table Import
+	TableImportMng tableImportModel;
 
-                        //FIXME: neni potreba zresetovat stav treba loginModelu, pokdu neco takhle selze? pripadne stav jinyho objektu?
-                        try {
-                            model.setDatabase(dblayer);
-                        } catch (RemoteException ex) {
-                            JOptionPane.showMessageDialog(view,&quot;Remote problem&quot;,&quot;Some remote problem occurred:\n&quot;+ex,JOptionPane.WARNING_MESSAGE);
-                            return;
-                        } catch (DBLayerException ex) {
-                            JOptionPane.showMessageDialog(view,&quot;Database problem&quot;,&quot;Some database problem occurred:\n&quot;+ex,JOptionPane.WARNING_MESSAGE);
-                            return;
-                        }
-                        //distribute database to dialogs
-                        addModel.setDatabase(dblayer);
-                        editModel.setDatabase(dblayer);
-                        searchModel.setDatabase(dblayer);
-                        detailModel.setDatabase(dblayer);
-    			
-                        model.setAccessRights( loginModel.getAccessRights() );
-                        model.login();
-                        
-                        view.getSBM().display(L10n.getString(&quot;Message.FillingDialogs&quot;));
-                        fillDialogModels();
-                        
-                        view.getSBM().display(L10n.getString(&quot;Message.LoadingOverviewData&quot;));
-                        searchModel.clear();
-                        searchModel.constructQuery();
-                        view.getSBM().displayDefaultText();
-                        
-    			view.initOverview();
-                        view.setCursor(Cursor.getDefaultCursor());
-                        setDatabaseDependentCommandsEnabled(true);
-    		}
-    	}
-    }
-    
-    private Task refreshOverview(boolean createTask) {
-        if (createTask) {
-            Task task = new Task() {
-                public Object task() {
-                    searchModel.clear();
-                    searchModel.constructQuery();
-                    fireStopped(null);
-                    return null;
-                }
-            };
+	TableImportMngCtrl tableImportCtrl;
 
-            return task;
-        } else {
-            searchModel.clear();
-            searchModel.constructQuery();
-            return null;
-        }
-    }
-    
-    class RefreshAction extends AbstractAction {
-        public RefreshAction() {
-            if (showButtonText)
-                putValue(NAME, L10n.getString(&quot;Overview.Refresh&quot;));
-            putValue(SMALL_ICON,Resource.createIcon(&quot;/toolbarButtonGraphics/general/Refresh24.gif&quot;));
-            putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.RefreshTT&quot;));
-            putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_R, ActionEvent.CTRL_MASK));
-            //putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Refresh&quot;));                        
-        }
+	// Detail
+	Detail detailModel;
 
-        public void actionPerformed(ActionEvent e) {
-            // e can be null !!! - we call actionPerformed(null) in DeleteAction
-            Task task = refreshOverview(true);
-            ProgressBar progressBar = new ProgressBar(task, view, true) {
-                public void exceptionHandler(Exception ex) {   
-                    //FIXME
-                    ex.printStackTrace();
-                    getTask().stop();
-                }                    
-            };
-            progressBar.setTitle(L10n.getString(&quot;Overview.Refresh.ProgressTitle&quot;));
+	DetailView detailView;
 
-            task.start(); 
-        }
-        
-    }
-    
-    /** Propagates changes made in managers to the rest of the application.
-     *
-     */
-    class ManagerBridge implements Observer {
-        public void update(Observable o, Object arg) {
-            if (arg instanceof PlantloreConstants.Table[]) {
-                PlantloreConstants.Table[] tables = (PlantloreConstants.Table[])arg;   
-                try {
-                for (PlantloreConstants.Table table : tables) {
-                    logger.debug(&quot;ManagerBridge received message that &quot;+table+&quot; has been updated.&quot;);
-                    switch (table) {
-                        case AUTHOR:
-                            model.loadAuthors();
-                            addModel.setAuthors(model.getAuthors());
-                            editModel.setAuthors(model.getAuthors());
-                            searchModel.setAuthors(model.getAuthors());
-                            break;
-                        case AUTHOROCCURRENCE:
-                            model.loadAuthorRoles();
-                            addModel.setAuthorRoles(model.getAuthorRoles());
-                            editModel.setAuthorRoles(model.getAuthorRoles());
-                            searchModel.setAuthorRoles(model.getAuthorRoles());                            
-                            break;
-                        case METADATA:
-                            model.loadProjects();
-                            addModel.setProjects(model.getProjects());
-                            editModel.setProjects(model.getProjects());
-                            searchModel.setProjects(model.getProjects());
-                            break;
-                        case OCCURRENCE:
-                            refreshAction.actionPerformed(null);
-                            break;
-                        case PHYTOCHORION:
-                            model.loadPhytCodes();
-                            model.loadPhytNames();
-                            addModel.setPhytCodes(model.getPhytCodes());
-                            addModel.setPhytNames(model.getPhytNames());
-                            editModel.setPhytCodes(model.getPhytCodes());
-                            editModel.setPhytNames(model.getPhytNames());
-                            searchModel.setPhytCodes(model.getPhytCodes());
-                            searchModel.setPhytNames(model.getPhytNames());
-                            break;
-                        case PLANT:
-                            model.loadPlants();
-                            addModel.setPlants(model.getPlants());
-                            editModel.setPlants(model.getPlants());
-                            searchModel.setPlants(model.getPlants());
-                            break;
-                        case PUBLICATION:
-                            model.loadPublications();
-                            addModel.setPublications(model.getPublications());
-                            editModel.setPublications(model.getPublications());
-                            searchModel.setPublications(model.getPublications());
-                            break;
-                        case RIGHT: //???
-                            logger.warn(&quot;Reaction to changes in RIGHTS table is NOT IMPLEMENTED.&quot;);
-                            break;
-                        case TERRITORY:
-                            model.loadTerritories();
-                            addModel.setTerritories(model.getTerritories());
-                            editModel.setTerritories(model.getTerritories());
-                            searchModel.setTerritories(model.getTerritories());
-                            break;
-                        case USER: //???
-                            logger.warn(&quot;Reaction to changes in USERS table is NOT IMPLEMENTED.&quot;);
-                            break;
-                        case VILLAGE:
-                            model.loadVillages();
-                            addModel.setVillages(model.getVillages());
-                            editModel.setVillages(model.getVillages());
-                            searchModel.setVillages(model.getVillages());
-                            break;
-                    }//switch table
-                }//for
-                } catch (DBLayerException ex) {
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.DBLayerException&quot;)+&quot;\n&quot;+ex.getErrorInfo(),L10n.getString(&quot;Error.DBLayerExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                    logger.error(ex+&quot;: &quot;+ex.getErrorInfo());
-                } catch (RemoteException ex) {
-                    JOptionPane.showMessageDialog(view,L10n.getString(&quot;Error.RemoteException&quot;)+&quot;\n&quot;+ex.getMessage(),L10n.getString(&quot;Error.RemoteExceptionTitle&quot;),JOptionPane.WARNING_MESSAGE);
-                    logger.error(ex);
-                }
-            }//if arg instanceof Table[]
-        }//update()        
-    }//class ManagerBridge
-    
-}
+	DetailCtrl detailCtrl;
 
+	// Bridges
+	ManagerBridge managerBridge = new ManagerBridge();
 
+	// Actions
+	AbstractAction settingsAction = new SettingsAction();
+
+	AbstractAction printAction = new PrintAction();
+
+	AbstractAction helpContentsAction = new HelpContentsAction();
+
+	AbstractAction helpAboutAction = new HelpAboutAction();
+
+	AbstractAction exportAction = new ExportAction();
+
+	AbstractAction importAction = new ImportAction();
+
+	AbstractAction tableImportAction = new TableImportAction();
+
+	AbstractAction dataAuthorsAction = new DataAuthorsAction();
+
+	AbstractAction dataPublicationsAction = new DataPublicationsAction();
+
+	AbstractAction dataMetadataAction = new DataMetadataAction();
+
+	AbstractAction dataHistoryAction = new DataHistoryAction();
+
+	AbstractAction dataWholeHistoryAction = new DataWholeHistoryAction();
+
+	AbstractAction dataUserAction = new DataUserAction();
+
+	AbstractAction historyAction = new DataHistoryAction();
+
+	AbstractAction schedaAction = new SchedaAction();
+
+	AbstractAction searchAction = new SearchAction();
+
+	AbstractAction addAction = new AddAction();
+
+	AbstractAction editAction = new EditAction();
+
+	AbstractAction deleteAction = new DeleteAction();
+
+	AbstractAction selectAllAction = new SelectAllAction();
+
+	AbstractAction selectNoneAction = new SelectNoneAction();
+
+	AbstractAction invertSelectedAction = new InvertSelectedAction();
+
+	AbstractAction nextPageAction = new NextPageAction();
+
+	AbstractAction prevPageAction = new PreviousPageAction();
+
+	AbstractAction refreshAction = new RefreshAction();
+
+	AbstractAction loginAction = new LoginAction();
+
+	/** Creates a new instance of AppCoreCtrl */
+	public AppCoreCtrl(AppCore model, AppCoreView view) {
+		logger = Logger.getLogger(this.getClass().getPackage().getName());
+		prefs = Preferences.userNodeForPackage(this.getClass());
+
+		this.model = model;
+		this.view = view;
+		view.setSettingsAction(settingsAction);
+		view.setPrintAction(printAction);
+		view.addExitListener(new ExitListener());
+		view.setHelpContentsAction(helpContentsAction);
+		view.setHelpAboutAction(helpAboutAction);
+		view.setExportAction(exportAction);
+		view.setImportAction(importAction);
+		view.setTableImportAction(tableImportAction);
+
+		view.addDataAuthorsAction(dataAuthorsAction);
+		view.addDataPublicationsAction(dataPublicationsAction);
+		view.addDataMetadataAction(dataMetadataAction);
+		view.addDataHistoryAction(dataHistoryAction);
+		view.addDataWholeHistoryAction(dataWholeHistoryAction);
+		view.addDataUserAction(dataUserAction);
+
+		view.setSearchAction(searchAction);
+		view.setAddAction(addAction);
+		view.setEditAction(editAction);
+		view.setDeleteAction(deleteAction);
+		view.setSchedaAction(schedaAction);
+		view.setHistoryRecordAction(historyAction);
+
+		view.setSelectAllAction(selectAllAction);
+		view.setSelectNoneAction(selectNoneAction);
+		view.setInvertSelectedAction(invertSelectedAction);
+		view.setNextPageAction(nextPageAction);
+		view.setPrevPageAction(prevPageAction);
+		view.setSelectedRowListener(new OverviewSelectionListener());
+		view.overview.addMouseListener(new OverviewMouseListener());
+		view.refreshButton.setAction(refreshAction);
+		view.occurrencesRefresh.setAction(refreshAction);
+
+		view.overview.addKeyListener(new OverviewKeyListener());
+
+		view.addWindowListener(new AppWindowListener());
+		view
+				.setRecordsPerPageListener(new RecordsPerPagePropertyChangeListener());
+
+		view.setLoginAction(loginAction);
+
+		constructDialogs();
+
+		// This is here in order to skip login procedure and connect to the
+		// database automatically
+		// For developement purposes only - so that we don't have to go through
+		// login each time we run Plantlore
+		// view.initOverview();
+
+		setDatabaseDependentCommandsEnabled(false);
+	}
+
+	private void constructDialogs() {
+		// --- Add ---
+		addModel = new AddEdit(model.getDatabase(), false);
+		addView = new AddEditView(view, true, addModel, false);
+		addView.setTitle(L10n.getString(&quot;AddEdit.AddDialogTitle&quot;));
+		addCtrl = new AddEditCtrl(addModel, addView, false);
+
+		// --- Edit ---
+		editModel = new AddEdit(model.getDatabase(), true);
+		editView = new AddEditView(view, true, editModel, true);
+		editView.setTitle(L10n.getString(&quot;AddEdit.EditDialogTitle&quot;));
+		editCtrl = new AddEditCtrl(editModel, editView, true);
+
+		// --- Search ---
+		searchModel = new Search(model.getDatabase());
+		StatusBarManager sbm = view.getSBM();
+		searchModel.setColumns(model.getTableModel().getColumns());
+		searchView = new SearchView(view, true, searchModel);
+		searchView.setTitle(L10n.getString(&quot;Search.DialogTitle&quot;));
+		searchCtrl = new SearchCtrl(searchModel, searchView);
+		searchModel.addObserver(new SearchBridge());
+
+		// --- Detail ---
+		detailModel = new Detail(model);
+		detailView = new DetailView(detailModel, view, true);
+		detailCtrl = new DetailCtrl(detailModel, detailView);
+	}
+
+	private void setDatabaseDependentCommandsEnabled(boolean enabled) {
+		settingsAction.setEnabled(enabled);
+		printAction.setEnabled(enabled);
+		exportAction.setEnabled(enabled);
+		importAction.setEnabled(enabled);
+		tableImportAction.setEnabled(enabled);
+
+		dataAuthorsAction.setEnabled(enabled);
+		dataPublicationsAction.setEnabled(enabled);
+		dataMetadataAction.setEnabled(enabled);
+		dataHistoryAction.setEnabled(enabled);
+		dataWholeHistoryAction.setEnabled(enabled);
+		dataUserAction.setEnabled(enabled);
+
+		historyAction.setEnabled(enabled);
+		schedaAction.setEnabled(enabled);
+		searchAction.setEnabled(enabled);
+		addAction.setEnabled(enabled);
+		editAction.setEnabled(enabled);
+		deleteAction.setEnabled(enabled);
+
+		selectAllAction.setEnabled(enabled);
+		selectNoneAction.setEnabled(enabled);
+		invertSelectedAction.setEnabled(enabled);
+		nextPageAction.setEnabled(enabled);
+		prevPageAction.setEnabled(enabled);
+		view.recordsPerPage.setEnabled(enabled);
+		refreshAction.setEnabled(enabled);
+	}
+
+	/**
+	 * Handles click to menu item Settings.
+	 * 
+	 */
+	class SettingsAction extends AbstractAction {
+		public SettingsAction() {
+			putValue(NAME, L10n.getString(&quot;Settings&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;SettingsTooltip&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Settings&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			logger.info(&quot;Settings selected&quot;);
+			// If the dialog is already constructed then use it. Otherwise
+			// construct it first.
+			if (settingsModel == null) {
+				settingsModel = new Settings();
+				settingsModel.setSelectedColumns(model.getTableModel()
+						.getColumns());
+				settingsModel.addObserver(new SettingsBridge());
+				settingsView = new SettingsView(view, true, settingsModel);
+				settingsCtrl = new SettingsCtrl(settingsModel, settingsView);
+			}
+			// settingsView.loadValues();
+			settingsView.setVisible(true);
+		}
+	}
+
+	/**
+	 * Assumes that user doesn't work with the Search dialog at time of the
+	 * update.
+	 * 
+	 */
+	class SettingsBridge implements Observer {
+		public void update(Observable o, Object arg) {
+			if (arg instanceof String) {
+				String s = (String) arg;
+				if (s.equals(&quot;COLUMNS&quot;)) {
+					logger
+							.debug(&quot;User changed columns in settings. Propagating the change to overview and config.&quot;);
+					ArrayList&lt;Column&gt; columns = settingsModel
+							.getSelectedColumns();
+					model.getTableSorter().setColumns(columns);
+					model.getMainConfig().setColumns(columns);
+
+					searchModel.setColumns(columns);
+					searchModel.clear();
+					searchModel.constructQuery();
+				}
+			}
+		}
+	}
+
+	class PrintAction extends AbstractAction {
+		public PrintAction() {
+			putValue(NAME, L10n.getString(&quot;Print&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;PrintTooltip&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Print&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (printModel == null) {
+				printModel = new Print();
+				printView = new PrintView(view, true, printModel);
+				printCtrl = new PrintCtrl(printModel, printView);
+			}
+			Selection sel = model.getTableModel().getSelection();
+			if (sel.values().size() &lt; 1) {
+				JOptionPane.showMessageDialog(view,
+						&quot;Please check at least one record.&quot;);
+				return;
+			}
+			printModel.setSource(model.getDatabase(), sel);
+			printView.setVisible(true);
+		}
+	}
+
+	/**
+	 * Handles the exit command.
+	 * 
+	 * Maybe settings should be stored first?
+	 */
+	class ExitListener implements ActionListener {
+		public void actionPerformed(ActionEvent actionEvent) {
+			try {
+				model.savePreferences();
+			} catch (IOException ex) {
+				JOptionPane.showMessageDialog(view,
+						&quot;Problem while saving configuration: &quot;
+								+ ex.getMessage());
+			}
+			// Destroy the DBLayer
+			// model.getDatabase().destroy(); --- takhle se to nesmi delat, musi
+			// ji znicit factory, ktera ji vyrobila
+			System.exit(0);
+		}
+	}
+
+	class HelpContentsAction extends AbstractAction {
+		public HelpContentsAction() {
+			putValue(NAME, L10n.getString(&quot;helpContents&quot;));
+			putValue(SHORT_DESCRIPTION, &quot;Help contents&quot;);
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;helpContents&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			System.out.println(&quot;Help contents selected&quot;);
+		}
+	}
+
+	class HelpAboutAction extends AbstractAction {
+		public HelpAboutAction() {
+			putValue(NAME, L10n.getString(&quot;helpAbout&quot;));
+			putValue(SHORT_DESCRIPTION, &quot;Help about tooltip&quot;);
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;helpAbout&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			System.out.println(&quot;Help about selected&quot;);
+		}
+	}
+
+	class ImportAction extends AbstractAction {
+		public ImportAction() {
+			putValue(NAME, L10n.getString(&quot;dataImport&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;dataImportTooltip&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;dataImport&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (importModel == null) {
+				try {
+					importModel = new ImportMng(model.getDatabase());
+					importProgressView = new ImportProgressView(importModel);
+					importProgressCtrl = new ImportProgressCtrl(importModel,
+							importProgressView);
+
+					importCtrl = new ImportMngCtrl(importModel, view,
+							importProgressView);
+
+					importDecisionView = new DecisionView(importModel);
+					importDecisionCtrl = new DecisionCtrl(importModel,
+							importDecisionView);
+				} catch (ImportException e) {
+					logger.error(&quot;Import MVC cannot be created. &quot;
+							+ e.getMessage());
+					return;
+				}
+			}
+
+			if (importModel.isImportInProgress())
+				importProgressView.setVisible(true);
+			else
+				importCtrl.setVisible(true);
+
+		}
+	}
+
+	class TableImportAction extends AbstractAction {
+		public TableImportAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.TableImport&quot;));
+			putValue(SHORT_DESCRIPTION, L10n
+					.getString(&quot;Overview.TableImportTT&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.TableImport&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (tableImportModel == null) {
+				try {
+					tableImportModel = new TableImportMng(model.getDatabase());
+					tableImportCtrl = new TableImportMngCtrl(tableImportModel,
+							view);
+				} catch (ImportException e) {
+					logger.error(&quot;Import MVC cannot be created. &quot;
+							+ e.getMessage());
+					return;
+				}
+			}
+
+			tableImportCtrl.setVisible(true);
+		}
+	}
+
+	class ExportAction extends AbstractAction {
+		public ExportAction() {
+			putValue(NAME, L10n.getString(&quot;dataExport&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;dataExportTooltip&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;dataExport&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			// Create a new dialog if it already doesn't exist.
+			if (exportModel == null) {
+				try {
+					exportModel = new ExportMng(model.getDatabase());
+					exportProgressView = new ExportProgressView(null);
+					exportProgressCtrl = new ExportProgressCtrl(null,
+							exportProgressView);
+					exportCtrl = new ExportMngCtrlA(exportModel, view,
+							exportProgressView, exportProgressCtrl);
+				} catch (ExportException e) {
+					logger.error(&quot;Export MVC cannot be created. &quot;
+							+ e.getMessage());
+					return;
+				}
+			}
+			// Display the progress view if an export is already running.
+			if (exportModel.isAnExportInProgress())
+				exportProgressView.setVisible(true);
+			// Display the Export dialog.
+			else {
+				try {
+					/*
+					 * ==============================================================
+					 * Right after the startup the searchModel may not be
+					 * initialized! (if Export is called prior to Search...)
+					 * 
+					 * FIXME: Solve this with Jakub.
+					 * ==============================================================
+					 */
+					SelectQuery query;
+					if (searchModel == null) {
+						System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; CREATING A FAKE QUERY&quot;);
+						query = model.getDatabase().createQuery(
+								Occurrence.class); // fake the query
+					} else {
+						Object[] queryParam = searchModel
+								.constructExportQuery();
+						query = (SelectQuery) queryParam[0];
+						if ((Boolean) queryParam[1]) { // use projections
+							exportModel.useProjections(true);
+							exportModel.setRootTable((Class) queryParam[2]);
+						}
+					}
+					exportModel.setSelectQuery(query);
+					exportModel.setSelection(model.getTableModel()
+							.getSelection());
+				} catch (DBLayerException e) {
+					JOptionPane.showMessageDialog(view, &quot;DBLayer Exception: &quot;
+							+ e);
+					return;
+				} catch (RemoteException e) {
+					JOptionPane.showMessageDialog(view, &quot;Remote Exception: &quot;
+							+ e);
+					return;
+				}
+				exportCtrl.setVisible(true);
+			}
+		}
+	}
+
+	class AddAction extends AbstractAction {
+		public AddAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.Add&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/Add24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.AddTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_A,
+					ActionEvent.CTRL_MASK));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Add&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			try {
+				if (model.getDatabase().getUserRights().getAdd() != 1) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;AddEdit.InsufficientAddRights&quot;), L10n
+							.getString(&quot;AddEdit.InsufficientRightsTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				}
+			} catch (RemoteException ex) {
+				JOptionPane.showMessageDialog(view, L10n
+						.getString(&quot;Error.RemoteException&quot;)
+						+ &quot;\n&quot; + ex.getMessage(), L10n
+						.getString(&quot;Error.RemoteExceptionTitle&quot;),
+						JOptionPane.WARNING_MESSAGE);
+				logger.error(ex);
+			}
+			addModel.clear();
+			addView.setVisible(true);
+		}
+	}
+
+	class EditAction extends AbstractAction {
+		public EditAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.Edit&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/Edit24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.EditTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_E,
+					ActionEvent.CTRL_MASK));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Edit&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			Object[] row = model.getSelectedRow();
+
+			try {
+				if (!model.isEditAllowed(model.getSelectedOccurrence())) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;AddEdit.InsufficientEditRights&quot;), L10n
+							.getString(&quot;AddEdit.InsufficientRightsTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				}
+				editModel.setRecord((Integer) row[row.length - 1]);
+			} catch (DBLayerException ex) {
+				JOptionPane.showMessageDialog(view, L10n
+						.getString(&quot;Error.DBLayerException&quot;)
+						+ &quot;\n&quot; + ex.getErrorInfo(), L10n
+						.getString(&quot;Error.DBLayerExceptionTitle&quot;),
+						JOptionPane.WARNING_MESSAGE);
+				logger.error(ex + &quot;: &quot; + ex.getErrorInfo());
+			} catch (RemoteException ex) {
+				JOptionPane.showMessageDialog(view, L10n
+						.getString(&quot;Error.RemoteException&quot;)
+						+ &quot;\n&quot; + ex.getMessage(), L10n
+						.getString(&quot;Error.RemoteExceptionTitle&quot;),
+						JOptionPane.WARNING_MESSAGE);
+				logger.error(ex);
+			}
+			editView.loadComponentData();
+			editView.setVisible(true);
+		}
+	}
+
+	class DeleteAction extends AbstractAction {
+		public DeleteAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.Delete&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/Delete24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.DeleteTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(
+					KeyEvent.VK_DELETE, 0));
+
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Delete&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			Selection selection = model.getTableModel().getSelection();
+			Object[] arg = { selection.values().size() };
+
+			if (arg[0].equals(0)) {
+				JOptionPane.showMessageDialog(view, L10n
+						.getString(&quot;Message.CheckAnOccurrence&quot;), L10n
+						.getString(&quot;Message.CheckAnOccurrenceTitle&quot;),
+						JOptionPane.INFORMATION_MESSAGE);
+				return;
+			}
+
+			try {
+				for (Integer occId : selection.values())
+					if (!model.isEditAllowed(occId)) {
+						JOptionPane.showMessageDialog(view, L10n
+								.getString(&quot;Delete.InsufficientRights&quot;), L10n
+								.getString(&quot;Delete.InsufficientRightsTitle&quot;),
+								JOptionPane.INFORMATION_MESSAGE);
+						return;
+					}
+			} catch (RemoteException ex) {
+				logger.error(&quot;Remote problem: &quot; + ex);
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;RemoteException: &quot; + ex);
+			} catch (DBLayerException ex) {
+				logger.error(&quot;Database problem: &quot; + ex);
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;DBLayerException: &quot; + ex);
+			}
+
+			int choice = JOptionPane.showConfirmDialog(view, L10n
+					.getFormattedString(&quot;Message.DeleteRecords&quot;, arg), L10n
+					.getString(&quot;Message.DeleteRecordsTitle&quot;),
+					JOptionPane.OK_CANCEL_OPTION, JOptionPane.WARNING_MESSAGE);
+
+			switch (choice) {
+			case JOptionPane.CANCEL_OPTION:
+				return;
+			case JOptionPane.OK_OPTION:
+				logger.info(&quot;Deleting &quot; + arg[0] + &quot; records.&quot;);
+
+				Task task = model.deleteSelected();
+
+				ProgressBar progressBar = new ProgressBar(task, view, true) {
+					public void exceptionHandler(Exception ex) {
+						if (ex instanceof DBLayerException) {
+							DBLayerException e = (DBLayerException) ex;
+							JOptionPane.showMessageDialog(view, L10n
+									.getString(&quot;Error.DBLayerException&quot;)
+									+ &quot;\n&quot; + e.getErrorInfo(), L10n
+									.getString(&quot;Error.DBLayerExceptionTitle&quot;),
+									JOptionPane.WARNING_MESSAGE);
+							logger.error(e + &quot;: &quot; + e.getErrorInfo());
+							getTask().stop();
+							return;
+						}
+						if (ex instanceof RemoteException) {
+							RemoteException e = (RemoteException) ex;
+							JOptionPane.showMessageDialog(view, L10n
+									.getString(&quot;Error.RemoteException&quot;)
+									+ &quot;\n&quot; + e.getMessage(), L10n
+									.getString(&quot;Error.RemoteExceptionTitle&quot;),
+									JOptionPane.WARNING_MESSAGE);
+							logger.error(e);
+							getTask().stop();
+							return;
+						}
+						JOptionPane
+								.showMessageDialog(
+										view,
+										L10n
+												.getString(&quot;Delete.Message.UnknownException&quot;)
+												+ &quot;\n&quot; + ex.getMessage(),
+										L10n
+												.getString(&quot;Delete.Message.UnkownExceptionTitle&quot;),
+										JOptionPane.WARNING_MESSAGE);
+						logger.error(ex);
+					}
+
+					public void afterStopped(Object value) {
+						refreshOverview(false); // false -&gt; do not create task,
+												// refresh the overview directly
+												// in this thread
+					}
+				};
+				progressBar.setTitle(L10n.getString(&quot;Delete.ProgressTitle&quot;));
+
+				task.start();
+				break;
+			}// switch
+		}
+	}
+
+	class SelectAllAction extends AbstractAction {
+		public SelectAllAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.SelectAll&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SelectAllTT&quot;));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.SelectAll&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (model.getResultsCount() &gt; 0)
+				model.selectAll();
+		}
+	}
+
+	class SelectNoneAction extends AbstractAction {
+		public SelectNoneAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.SelectNone&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SelectNoneTT&quot;));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.SelectNone&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (model.getResultsCount() &gt; 0)
+				model.selectNone();
+		}
+	}
+
+	class InvertSelectedAction extends AbstractAction {
+		public InvertSelectedAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.InvertSelected&quot;));
+			putValue(SHORT_DESCRIPTION, L10n
+					.getString(&quot;Overview.InvertSelectedTT&quot;));
+			// putValue(MNEMONIC_KEY,
+			// L10n.getMnemonic(&quot;Overview.InvertSelected&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			if (model.getResultsCount() &gt; 0)
+				model.invertSelected();
+		}
+	}
+
+	class SearchAction extends AbstractAction {
+		public SearchAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.Search&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/Search24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SearchTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_S,
+					ActionEvent.CTRL_MASK));
+
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Search&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			searchModel.clear();
+			searchView.setVisible(true);
+		}
+	}
+
+	class SearchBridge implements Observer {
+		public void update(Observable o, Object arg) {
+			if (arg != null &amp;&amp; arg instanceof Integer) {
+				logger
+						.debug(&quot;Fetching new result id from Search model. Storing it to AppCore model.&quot;);
+				try {
+					model.setResultId(searchModel.getNewResultId(), searchModel
+							.getNewSelectQuery());
+				} catch (RemoteException ex) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.RemoteException&quot;)
+							+ &quot;\n&quot; + ex.getMessage(), L10n
+							.getString(&quot;Error.RemoteExceptionTitle&quot;),
+							JOptionPane.WARNING_MESSAGE);
+					logger.error(ex);
+				} catch (DBLayerException ex) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.DBLayerException&quot;)
+							+ &quot;\n&quot; + ex.getErrorInfo(), L10n
+							.getString(&quot;Error.DBLayerExceptionTitle&quot;),
+							JOptionPane.WARNING_MESSAGE);
+					logger.error(ex + &quot;: &quot; + ex.getErrorInfo());
+				}
+				// model.setExportQuery(searchModel.getExportQuery(), false,
+				// Occurrence.class);
+			}
+		}
+
+	}
+
+	class SchedaAction extends AbstractAction {
+		public SchedaAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.Scheda&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.SchedaTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_X,
+					ActionEvent.CTRL_MASK));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Scheda&quot;));
+			putValue(
+					SMALL_ICON,
+					Resource
+							.createIcon(&quot;/toolbarButtonGraphics/general/ComposeMail24.gif&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			try {
+				if (model.getTableModel().getSelection().values().size() &lt; 1) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Message.CheckAnOccurrence&quot;), L10n
+							.getString(&quot;Message.CheckAnOccurrenceTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				}
+
+				final JasperReport schedaReport;
+				InputStream schedaIs = this
+						.getClass()
+						.getClassLoader()
+						.getResourceAsStream(
+								&quot;net/sf/plantlore/client/resources/SchedaA6.jasper&quot;);
+
+				try {
+					ObjectInputStream schedaOis = new ObjectInputStream(
+							schedaIs);
+					schedaReport = (JasperReport) schedaOis.readObject();
+				} catch (FileNotFoundException ex) {
+					logger.error(&quot;Problem loading jasper report resource: &quot;
+							+ ex);
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.InternalProblem&quot;)
+							+ &quot;\n&quot; + ex.getMessage(), L10n
+							.getString(&quot;Error.InternalProblemTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				} catch (IOException ex) {
+					logger.error(&quot;Problem loading jasper report resource: &quot;
+							+ ex);
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.InternalProblem&quot;)
+							+ ex.getMessage(), L10n
+							.getString(&quot;Error.InternalProblemTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				} catch (ClassNotFoundException ex) {
+					logger.error(&quot;Problem loading jasper report resource: &quot;
+							+ ex);
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.InternalProblem&quot;)
+							+ ex.getMessage(), L10n
+							.getString(&quot;Error.InternalProblemTitle&quot;),
+							JOptionPane.INFORMATION_MESSAGE);
+					return;
+				}
+
+				prefs = Preferences.userNodeForPackage(AppCoreCtrl.class);
+				String h1 = prefs.get(&quot;HEADER_ONE&quot;,
+						&quot;Set the first header in settings, please.&quot;);
+				String h2 = prefs.get(&quot;HEADER_TWO&quot;,
+						&quot;Set the second header in settings, please.&quot;);
+				final HashMap params = new HashMap();
+				params.put(&quot;HEADER_ONE&quot;, h1);
+				params.put(&quot;HEADER_TWO&quot;, h2);
+
+				Task task = new Task() {
+					JasperPrint jasperPrint;
+
+					public Object task() throws JRException {
+						jasperPrint = JasperFillManager.fillReport(
+								schedaReport, params,
+								new JasperDataSource(model.getDatabase(), model
+										.getTableModel().getSelection()));
+						fireStopped(jasperPrint);
+						return jasperPrint;
+					}
+				};
+
+				ProgressBar pb = new ProgressBar(task, view, true) {
+					public void exceptionHandler(final Exception ex) {
+						logger
+								.error(&quot;Error while filling jasper report in SchedaAction: &quot;
+										+ ex);
+						ex.printStackTrace();
+						SwingUtilities.invokeLater(new Runnable() {
+							public void run() {
+								JOptionPane
+										.showMessageDialog(
+												view.getParent(),
+												L10n
+														.getString(&quot;Print.Message.BrokenReport&quot;)
+														+ &quot;\n&quot;
+														+ ex.getMessage(),
+												L10n
+														.getString(&quot;Print.Message.BrokenReport&quot;),
+												JOptionPane.WARNING_MESSAGE);
+							}
+						});
+						getTask().stop();
+					}
+
+					public void afterStopped(final Object value) {
+						SwingUtilities.invokeLater(new Runnable() {
+							public void run() {
+								new SchedaView(view, true, (JasperPrint) value)
+										.setVisible(true);
+							}
+						});
+					}
+				};
+				pb.setTitle(L10n.getString(&quot;Scheda.ProgressTitle&quot;));
+
+				task.start();
+			} catch (Exception ex) { // Unreachable CATCH block
+				logger.error(&quot;Broken report: &quot; + ex);
+				JOptionPane.showMessageDialog(view, L10n
+						.getString(&quot;Print.Message.BrokenReport&quot;)
+						+ &quot;\n&quot; + ex.getMessage(), L10n
+						.getString(&quot;Print.Message.BrokenReport&quot;),
+						JOptionPane.WARNING_MESSAGE);
+				ex.printStackTrace();
+			}
+		}
+	}
+
+	class PreviousPageAction extends AbstractAction {
+		public PreviousPageAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.PrevPage&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.PrevPageTT&quot;));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.PrevPage&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			try {
+				model.prevPage();
+			} catch (RemoteException ex) {
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;RemoteException: &quot; + ex);
+			} catch (DBLayerException ex) {
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;DBLayerException: &quot; + ex);
+			}
+		}
+	}
+
+	class NextPageAction extends AbstractAction {
+		public NextPageAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.NextPage&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.NextPageTT&quot;));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.NextPage&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			try {
+				model.nextPage();
+			} catch (RemoteException ex) {
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;RemoteException: &quot; + ex);
+			} catch (DBLayerException ex) {
+				ex.printStackTrace();
+				JOptionPane.showMessageDialog(view, &quot;DBLayerException: &quot; + ex);
+			}
+		}
+	}
+
+	class AppWindowListener extends WindowAdapter {
+		public void windowClosing(WindowEvent e) {
+			try {
+				model.savePreferences();
+			} catch (IOException ex) {
+				JOptionPane.showMessageDialog(view,
+						&quot;Problem while saving configuration: &quot;
+								+ ex.getMessage());
+			}
+		}
+	}
+
+	class DataAuthorsAction extends AbstractAction {
+		public DataAuthorsAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.MenuDataAuthors&quot;));
+			putValue(SHORT_DESCRIPTION, L10n
+					.getString(&quot;Overview.MenuDataAuthorsTT&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.MenuDataAuthors&quot;));
+		}
+
+		public void actionPerformed(ActionEvent e) {
+			AuthorManager authModel = new AuthorManager(model.getDatabase());
+			AuthorManagerView authView = new AuthorManagerView(authModel, view,
+					true);
+			AuthorManagerCtrl authCtrl = new AuthorManagerCtrl(authModel,
+					authView);
+			authView.setVisible(true);
+		}
+
+	}
+
+	class DataPublicationsAction extends AbstractAction {
+		public DataPublicationsAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.MenuDataPublications&quot;));
+			putValue(SHORT_DESCRIPTION, L10n
+					.getString(&quot;Overview.MenuDataPublicationsTT&quot;));
+			putValue(MNEMONIC_KEY, L10n
+					.getMnemonic(&quot;Overview.MenuDataPublications&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			publicationManagerModel = new PublicationManager(model
+					.getDatabase());
+			publicationManagerView = new PublicationManagerView(
+					publicationManagerModel, view, true);
+			publicationManagerCtrl = new PublicationManagerCtrl(
+					publicationManagerModel, publicationManagerView);
+			publicationManagerView.setVisible(true);
+		}
+	}
+
+	class DataUserAction extends AbstractAction {
+		public DataUserAction() {
+			putValue(NAME, L10n.getString(&quot;userManager&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			System.out.println(&quot;UserManager&quot;);
+
+			userManagerModel = new UserManager(model.getDatabase());
+			userManagerView = new UserManagerView(userManagerModel, view, true);
+			userManagerCtrl = new UserManagerCtrl(userManagerModel,
+					userManagerView);
+			userManagerView.setVisible(true);
+		}
+	}
+
+	class DataHistoryAction extends AbstractAction {
+		public DataHistoryAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.History&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/History24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.HistoryTT&quot;));
+			// putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_S,
+			// ActionEvent.CTRL_MASK));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.History&quot;));
+		}
+
+		public void actionPerformed(ActionEvent e) {
+			System.out.println(&quot;Undo selected&quot;);
+			// toto volani historie nebude v menu, ale jako tlacitko pro vybrany
+			// zaznam
+			// o vybranem zaznamu predame informace, ktere chceme o nem v
+			// historii zobrazit
+			// jmeno rosliny, jmeno autora a lokaci a idOccurrences
+
+			historyModel = new History(model.getDatabase(), model
+					.getSelectedOccurrence());
+			historyView = new HistoryView(historyModel, view, true);
+			historyCtrl = new HistoryCtrl(historyModel, historyView);
+			historyModel.addObserver(managerBridge);
+			historyView.setVisible(true);
+		}
+
+	}
+
+	class DataWholeHistoryAction extends AbstractAction {
+		public DataWholeHistoryAction() {
+			putValue(NAME, L10n.getString(&quot;wholeHistory&quot;));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			System.out.println(&quot;Whole history - Undo selected&quot;);
+
+			wholeHistoryModel = new History(model.getDatabase());
+			wholeHistoryView = new WholeHistoryView(wholeHistoryModel, view,
+					true);
+			wholeHistoryCtrl = new WholeHistoryCtrl(wholeHistoryModel,
+					wholeHistoryView);
+			wholeHistoryModel.addObserver(managerBridge);
+			wholeHistoryView.setVisible(true);
+		}
+	}
+
+	/*
+	 * 
+	 */
+	class DataMetadataAction extends AbstractAction {
+		public DataMetadataAction() {
+			putValue(NAME, L10n.getString(&quot;metadataManager&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_M,
+					ActionEvent.CTRL_MASK));
+		}
+
+		public void actionPerformed(ActionEvent actionEvent) {
+			System.out.println(&quot;Metadata Manager&quot;);
+
+			metadataManagerModel = new MetadataManager(model.getDatabase());
+			metadataManagerView = new MetadataManagerView(metadataManagerModel,
+					view, true);
+			metadataManagerCtrl = new MetadataManagerCtrl(metadataManagerModel,
+					metadataManagerView);
+			metadataManagerModel.addObserver(managerBridge);
+			metadataManagerView.setVisible(true);
+		}
+	}
+
+	class RecordsPerPagePropertyChangeListener implements
+			PropertyChangeListener {
+		public void propertyChange(PropertyChangeEvent e) {
+			JFormattedTextField tf = (JFormattedTextField) e.getSource();
+			if (e != null &amp;&amp; e.getPropertyName().equals(&quot;value&quot;)) {
+				int i = ((Number) tf.getValue()).intValue();
+				if (i &gt; MAX_RECORDS_PER_PAGE) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Overview.Warning.MaxRecordsPerPage&quot;)
+							+ &quot; &quot; + MAX_RECORDS_PER_PAGE);
+					Object obj = e.getOldValue();
+					if (obj != null)
+						tf.setValue(obj);
+					else
+						// either multiple properties changed or there was no
+						// previous value - the value should better be at least
+						// 1 anyway...
+						tf.setValue(prefs.getInt(&quot;recordsPerPage&quot;, 30));
+					return;
+				}
+
+				if (i &lt; 1) {
+					Object obj = e.getOldValue();
+					if (obj != null)
+						tf.setValue(obj);
+					else
+						// either multiple properties changed or there was no
+						// previous value - the value should better be at least
+						// 1 anyway...
+						tf.setValue(1);
+				} else {
+					model.setRecordsPerPage(i);
+				}
+			}
+		}
+	}
+
+	class OverviewSelectionListener implements ListSelectionListener {
+		public void valueChanged(ListSelectionEvent e) {
+			// Ignore extra messages.
+			if (e.getValueIsAdjusting())
+				return;
+
+			ListSelectionModel lsm = (ListSelectionModel) e.getSource();
+			if (lsm.isSelectionEmpty()) {
+				// no rows are selected
+			} else {
+				int selectedRow = lsm.getMinSelectionIndex();
+				model.setSelectedRow(selectedRow);
+				// selectedRow is selected
+			}
+		}
+	}
+
+	class OverviewMouseListener implements MouseListener {
+		public void mouseClicked(MouseEvent e) {
+			if (e.getClickCount() == 2) {
+				JOptionPane.showMessageDialog(view, &quot;Double click! On row #&quot;
+						+ model.getSelectedRowNumber());
+			}
+			System.out.println(&quot;Click count = &quot; + e.getClickCount());
+		}
+
+		public void mousePressed(MouseEvent e) {
+		}
+
+		public void mouseReleased(MouseEvent e) {
+		}
+
+		public void mouseEntered(MouseEvent e) {
+		}
+
+		public void mouseExited(MouseEvent e) {
+		}
+
+	}
+
+	class OverviewKeyListener implements KeyListener {
+		public void keyTyped(KeyEvent e) {
+			System.out.println(&quot;Typed key: char=&quot; + e.getKeyChar() + &quot; code=&quot;
+					+ e.getKeyCode() + &quot; text=&quot; + e.getKeyText(e.getKeyChar())
+					+ &quot; modif=&quot; + e.getKeyModifiersText(e.getModifiers()));
+			if (e.getKeyText(e.getKeyChar()).equals(&quot;Space&quot;))
+				model.invertSelectedOnCurrentRow();
+			if (e.getKeyText(e.getKeyChar()).equals(&quot;Enter&quot;)) {
+				try {
+					int resultNumber = model.getSelectedResultNumber();
+					if (resultNumber != model.getResultsCount())
+						model.selectAndShow(resultNumber - 1);// After Enter
+																// the
+																// hyperactive
+																// JTable moves
+																// selection to
+																// next row, so
+																// we need to
+																// correct that
+					detailModel.load(model.getSelectedResultNumber());
+					detailView.setVisible(true);
+				} catch (RemoteException ex) {
+					JOptionPane.showMessageDialog(view, &quot;RemoteException: &quot;
+							+ ex);
+					ex.printStackTrace();
+				} catch (DBLayerException ex) {
+					JOptionPane.showMessageDialog(view, &quot;DBLayerException: &quot;
+							+ ex);
+					ex.printStackTrace();
+				}
+			}
+		}
+
+		public void keyPressed(KeyEvent e) {
+
+		}
+
+		public void keyReleased(KeyEvent e) {
+		}
+
+	}
+
+	class LoginAction extends AbstractAction {
+		public LoginAction() {
+			putValue(NAME, L10n.getString(&quot;Overview.MenuFileLogin&quot;));
+			putValue(SHORT_DESCRIPTION, L10n
+					.getString(&quot;Overview.MenuFileLoginTT&quot;));
+			putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.MenuFileLogin&quot;));
+		}
+
+		public void actionPerformed(ActionEvent arg0) {
+			// Reuse the existing dialogs, hide'em when they're no longer
+			// needed.
+			if (loginModel == null) {
+				loginModel = new Login(new RMIDBLayerFactory(), model
+						.getMainConfig());
+				loginModel.addObserver(new DatabaseChange());
+				loginView = new LoginView(view, loginModel);
+				loginCtrl = new LoginCtrl(loginModel, loginView);
+			}
+			loginCtrl.setVisible(true);
+		}
+	}
+
+	// Update all information about the database layer and inform everyone who
+	// has to be informed
+	class DatabaseChange implements Observer {
+		/**
+		 * Fetches combobox items from AppCore and stores them to dialog models.
+		 * 
+		 */
+		private void fillDialogModels() {
+			logger.debug(&quot;Filling Add model.&quot;);
+			addModel.setAuthors(model.getAuthors());
+			addModel.setAuthorRoles(model.getAuthorRoles());
+			addModel.setPlants(model.getPlants());
+			addModel.setVillages(model.getVillages());
+			addModel.setPhytNames(model.getPhytNames());
+			addModel.setPhytCodes(model.getPhytCodes());
+			addModel.setCountries(model.getCountries());
+			addModel.setSources(model.getSources());
+			addModel.setPublications(model.getPublications());
+			addModel.setProjects(model.getProjects());
+			addModel.setTerritories(model.getTerritories());
+
+			logger.debug(&quot;Filling Edit model.&quot;);
+			editModel.setAuthors(model.getAuthors());
+			editModel.setAuthorRoles(model.getAuthorRoles());
+			editModel.setPlants(model.getPlants());
+			editModel.setVillages(model.getVillages());
+			editModel.setPhytNames(model.getPhytNames());
+			editModel.setPhytCodes(model.getPhytCodes());
+			editModel.setCountries(model.getCountries());
+			editModel.setSources(model.getSources());
+			editModel.setPublications(model.getPublications());
+			editModel.setProjects(model.getProjects());
+			editModel.setTerritories(model.getTerritories());
+
+			logger.debug(&quot;Filling Search model.&quot;);
+			searchModel.setAuthors(model.getAuthors());
+			searchModel.setAuthorRoles(model.getAuthorRoles());
+			searchModel.setPlants(model.getPlants());
+			searchModel.setVillages(model.getVillages());
+			searchModel.setPhytNames(model.getPhytNames());
+			searchModel.setPhytCodes(model.getPhytCodes());
+			searchModel.setCountries(model.getCountries());
+			searchModel.setSources(model.getSources());
+			searchModel.setPublications(model.getPublications());
+			searchModel.setProjects(model.getProjects());
+			searchModel.setTerritories(model.getTerritories());
+		}
+
+		public void update(Observable targer, Object parameter) {
+			if (parameter != null &amp;&amp; parameter instanceof DBLayer) {
+				loginAction.setEnabled(false);
+				view.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
+
+				System.out.println(&quot;[!] DBLayer retrieval.&quot;);
+				DBLayer dblayer = loginModel.getDBLayer();
+
+				// FIXME: neni potreba zresetovat stav treba loginModelu, pokdu
+				// neco takhle selze? pripadne stav jinyho objektu?
+				try {
+					model.setDatabase(dblayer);
+				} catch (RemoteException ex) {
+					JOptionPane.showMessageDialog(view, &quot;Remote problem&quot;,
+							&quot;Some remote problem occurred:\n&quot; + ex,
+							JOptionPane.WARNING_MESSAGE);
+					return;
+				} catch (DBLayerException ex) {
+					JOptionPane.showMessageDialog(view, &quot;Database problem&quot;,
+							&quot;Some database problem occurred:\n&quot; + ex,
+							JOptionPane.WARNING_MESSAGE);
+					return;
+				}
+				// distribute database to dialogs
+				addModel.setDatabase(dblayer);
+				editModel.setDatabase(dblayer);
+				searchModel.setDatabase(dblayer);
+				detailModel.setDatabase(dblayer);
+
+				model.setAccessRights(loginModel.getAccessRights());
+				model.login();
+
+				view.getSBM().display(L10n.getString(&quot;Message.FillingDialogs&quot;));
+				fillDialogModels();
+
+				view.getSBM().display(
+						L10n.getString(&quot;Message.LoadingOverviewData&quot;));
+				searchModel.clear();
+				searchModel.constructQuery();
+				view.getSBM().displayDefaultText();
+
+				view.initOverview();
+				view.setCursor(Cursor.getDefaultCursor());
+				setDatabaseDependentCommandsEnabled(true);
+			}
+		}
+	}
+
+	private Task refreshOverview(boolean createTask) {
+		if (createTask) {
+			Task task = new Task() {
+				public Object task() {
+					searchModel.clear();
+					searchModel.constructQuery();
+					fireStopped(null);
+					return null;
+				}
+			};
+
+			return task;
+		} else {
+			searchModel.clear();
+			searchModel.constructQuery();
+			return null;
+		}
+	}
+
+	class RefreshAction extends AbstractAction {
+		public RefreshAction() {
+			if (showButtonText)
+				putValue(NAME, L10n.getString(&quot;Overview.Refresh&quot;));
+			putValue(SMALL_ICON, Resource
+					.createIcon(&quot;/toolbarButtonGraphics/general/Refresh24.gif&quot;));
+			putValue(SHORT_DESCRIPTION, L10n.getString(&quot;Overview.RefreshTT&quot;));
+			putValue(ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_R,
+					ActionEvent.CTRL_MASK));
+			// putValue(MNEMONIC_KEY, L10n.getMnemonic(&quot;Overview.Refresh&quot;));
+		}
+
+		public void actionPerformed(ActionEvent e) {
+			// e can be null !!! - we call actionPerformed(null) in DeleteAction
+			Task task = refreshOverview(true);
+			ProgressBar progressBar = new ProgressBar(task, view, true) {
+				public void exceptionHandler(Exception ex) {
+					// FIXME
+					ex.printStackTrace();
+					getTask().stop();
+				}
+			};
+			progressBar.setTitle(L10n
+					.getString(&quot;Overview.Refresh.ProgressTitle&quot;));
+
+			task.start();
+		}
+
+	}
+
+	/**
+	 * Propagates changes made in managers to the rest of the application.
+	 * 
+	 */
+	class ManagerBridge implements Observer {
+		public void update(Observable o, Object arg) {
+			if (arg instanceof PlantloreConstants.Table[]) {
+				PlantloreConstants.Table[] tables = (PlantloreConstants.Table[]) arg;
+				try {
+					for (PlantloreConstants.Table table : tables) {
+						logger.debug(&quot;ManagerBridge received message that &quot;
+								+ table + &quot; has been updated.&quot;);
+						switch (table) {
+						case AUTHOR:
+							model.loadAuthors();
+							addModel.setAuthors(model.getAuthors());
+							editModel.setAuthors(model.getAuthors());
+							searchModel.setAuthors(model.getAuthors());
+							break;
+						case AUTHOROCCURRENCE:
+							model.loadAuthorRoles();
+							addModel.setAuthorRoles(model.getAuthorRoles());
+							editModel.setAuthorRoles(model.getAuthorRoles());
+							searchModel.setAuthorRoles(model.getAuthorRoles());
+							break;
+						case METADATA:
+							model.loadProjects();
+							addModel.setProjects(model.getProjects());
+							editModel.setProjects(model.getProjects());
+							searchModel.setProjects(model.getProjects());
+							break;
+						case OCCURRENCE:
+							refreshAction.actionPerformed(null);
+							break;
+						case PHYTOCHORION:
+							model.loadPhytCodes();
+							model.loadPhytNames();
+							addModel.setPhytCodes(model.getPhytCodes());
+							addModel.setPhytNames(model.getPhytNames());
+							editModel.setPhytCodes(model.getPhytCodes());
+							editModel.setPhytNames(model.getPhytNames());
+							searchModel.setPhytCodes(model.getPhytCodes());
+							searchModel.setPhytNames(model.getPhytNames());
+							break;
+						case PLANT:
+							model.loadPlants();
+							addModel.setPlants(model.getPlants());
+							editModel.setPlants(model.getPlants());
+							searchModel.setPlants(model.getPlants());
+							break;
+						case PUBLICATION:
+							model.loadPublications();
+							addModel.setPublications(model.getPublications());
+							editModel.setPublications(model.getPublications());
+							searchModel
+									.setPublications(model.getPublications());
+							break;
+						case RIGHT: // ???
+							logger
+									.warn(&quot;Reaction to changes in RIGHTS table is NOT IMPLEMENTED.&quot;);
+							break;
+						case TERRITORY:
+							model.loadTerritories();
+							addModel.setTerritories(model.getTerritories());
+							editModel.setTerritories(model.getTerritories());
+							searchModel.setTerritories(model.getTerritories());
+							break;
+						case USER: // ???
+							logger
+									.warn(&quot;Reaction to changes in USERS table is NOT IMPLEMENTED.&quot;);
+							break;
+						case VILLAGE:
+							model.loadVillages();
+							addModel.setVillages(model.getVillages());
+							editModel.setVillages(model.getVillages());
+							searchModel.setVillages(model.getVillages());
+							break;
+						}// switch table
+					}// for
+				} catch (DBLayerException ex) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.DBLayerException&quot;)
+							+ &quot;\n&quot; + ex.getErrorInfo(), L10n
+							.getString(&quot;Error.DBLayerExceptionTitle&quot;),
+							JOptionPane.WARNING_MESSAGE);
+					logger.error(ex + &quot;: &quot; + ex.getErrorInfo());
+				} catch (RemoteException ex) {
+					JOptionPane.showMessageDialog(view, L10n
+							.getString(&quot;Error.RemoteException&quot;)
+							+ &quot;\n&quot; + ex.getMessage(), L10n
+							.getString(&quot;Error.RemoteExceptionTitle&quot;),
+							JOptionPane.WARNING_MESSAGE);
+					logger.error(ex);
+				}
+			}// if arg instanceof Table[]
+		}// update()
+	}// class ManagerBridge
+
+}

Modified: trunk/src/net/sf/plantlore/client/AppCoreView.java
===================================================================
--- trunk/src/net/sf/plantlore/client/AppCoreView.java	2006-06-05 19:46:25 UTC (rev 452)
+++ trunk/src/net/sf/plantlore/client/AppCoreView.java	2006-06-05 19:57:02 UTC (rev 453)
@@ -595,6 +595,13 @@
     public void setImportAction(AbstractAction a) {
         dataImport.setAction(a);
     }
+    
+    /** Sets an action to the Data-&gt;TableImport menu item and to the Import toolbar button.
+    *
+    */
+   public void setTableImportAction(AbstractAction a) {
+       dataImportTable.setAction(a);
+   }
 
     /** Sets an action to the Data-&gt;export menu item and to the Export toolbar button.
      *


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000582.html">[Plantlore-dev] r452 - trunk/src/net/sf/plantlore/client
</A></li>
	<LI>Next message: <A HREF="000584.html">[Plantlore-dev] r454 - in trunk/src/net/sf/plantlore: middleware server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#583">[ date ]</a>
              <a href="thread.html#583">[ thread ]</a>
              <a href="subject.html#583">[ subject ]</a>
              <a href="author.html#583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plantlore-dev">More information about the Plantlore-dev
mailing list</a><br>
</body></html>
