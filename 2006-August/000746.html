<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plantlore-dev] r544 - in trunk/src/net/sf/plantlore:	common/exception server
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plantlore-dev/2006-August/index.html" >
   <LINK REL="made" HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r544%20-%20in%20trunk/src/net/sf/plantlore%3A%0A%09common/exception%20server&In-Reply-To=%3C200608220933.k7M9X21A028537%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000745.html">
   <LINK REL="Next"  HREF="000747.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plantlore-dev] r544 - in trunk/src/net/sf/plantlore:	common/exception server</H1>
    <B>krater at mail.berlios.de</B> 
    <A HREF="mailto:plantlore-dev%40lists.berlios.de?Subject=Re%3A%20%5BPlantlore-dev%5D%20r544%20-%20in%20trunk/src/net/sf/plantlore%3A%0A%09common/exception%20server&In-Reply-To=%3C200608220933.k7M9X21A028537%40sheep.berlios.de%3E"
       TITLE="[Plantlore-dev] r544 - in trunk/src/net/sf/plantlore:	common/exception server">krater at mail.berlios.de
       </A><BR>
    <I>Tue Aug 22 11:33:02 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000745.html">[Plantlore-dev] r543 - trunk/src/net/sf/plantlore/server
</A></li>
        <LI>Next message: <A HREF="000747.html">[Plantlore-dev] r545 - in trunk/src/net/sf/plantlore/common: .	exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#746">[ date ]</a>
              <a href="thread.html#746">[ thread ]</a>
              <a href="subject.html#746">[ subject ]</a>
              <a href="author.html#746">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: krater
Date: 2006-08-22 11:33:00 +0200 (Tue, 22 Aug 2006)
New Revision: 544

Modified:
   trunk/src/net/sf/plantlore/common/exception/DBLayerException.java
   trunk/src/net/sf/plantlore/common/exception/PlantloreException.java
   trunk/src/net/sf/plantlore/server/HibernateDBLayer.java
Log:
PlantloreException and DBLayerException allow proper exception wrapping. You should use the new constructors instead of calling DBLayerException.setError() and DBLayerException.translateSQLState(). The constructor is designed to perform such operations automatically where possible and ensures a unified output! In fact, both setError() and translateSQLState() should be private!!

HibernateDBLayer is a beautiful example of sloppy programming. It is a miracle that it actually works! I made some refinements to the following methods:
* executeInsertXXX()
* executeUpdateXXX()
* executeDeleteXXX()
where XXX means every existing version (History, InTransaction, InTransactionHistory, ..).  
Judging by the state of those SIMPLE methods I am afraid even to think about the quality of the rest of someone's code! Sorry Kovo, reading this is the price you have to pay for my rewriting those methods!

Modified: trunk/src/net/sf/plantlore/common/exception/DBLayerException.java
===================================================================
--- trunk/src/net/sf/plantlore/common/exception/DBLayerException.java	2006-08-21 19:04:07 UTC (rev 543)
+++ trunk/src/net/sf/plantlore/common/exception/DBLayerException.java	2006-08-22 09:33:00 UTC (rev 544)
@@ -1,6 +1,8 @@
 package net.sf.plantlore.common.exception;
 
+import org.hibernate.JDBCException;
 
+
 /**
  * An exception thrown every time something in the database layer
  * (DBLayer) went wrong.
@@ -20,6 +22,8 @@
         private String errorInfo;
     
         // ================= ERROR CODES ===============
+        /** It was not possible to detect the reason why the operation failed. */
+        public static final int ERROR_UNKNOWN = -1;
         /** Database configuration cannot be loaded properly */
         public static final int ERROR_LOAD_CONFIG = 1;
         /** Connection to the database failed or no connection available */
@@ -64,7 +68,20 @@
         /** Create new DBLayerException with an error message */
         public DBLayerException(String message) { super(message); }
         
+        // Better constructor to allow proper exception wrapping.
+        public DBLayerException(String message, Throwable originalException) {
+        	super(message, originalException);
+        	if(originalException instanceof JDBCException)        	
+        		setError( translateSQLState( ((JDBCException)originalException).getSQLState()), originalException.getMessage() );
+        }
         
+        // Better constructor to allow proper exception wrapping.
+        public DBLayerException(String message, int error, Throwable originalException) {
+        	super(message, originalException);
+        	setError( error, originalException.getMessage() );
+        }
+        
+        
         public boolean isReconnectNecessary() {
         	return errorCode == ERROR_CONNECT;
         }

Modified: trunk/src/net/sf/plantlore/common/exception/PlantloreException.java
===================================================================
--- trunk/src/net/sf/plantlore/common/exception/PlantloreException.java	2006-08-21 19:04:07 UTC (rev 543)
+++ trunk/src/net/sf/plantlore/common/exception/PlantloreException.java	2006-08-22 09:33:00 UTC (rev 544)
@@ -18,4 +18,8 @@
 	public PlantloreException() { super(); }
 
 	public PlantloreException(String message) { super(message); }
+	
+	public PlantloreException(Throwable exception) { super(exception); }
+	
+	public PlantloreException(String message, Throwable exception) { super(message, exception); }
 }

Modified: trunk/src/net/sf/plantlore/server/HibernateDBLayer.java
===================================================================
--- trunk/src/net/sf/plantlore/server/HibernateDBLayer.java	2006-08-21 19:04:07 UTC (rev 543)
+++ trunk/src/net/sf/plantlore/server/HibernateDBLayer.java	2006-08-22 09:33:00 UTC (rev 544)
@@ -8,7 +8,6 @@
 package net.sf.plantlore.server;
 
 import java.io.File;
-import java.net.ConnectException;
 import java.rmi.NoSuchObjectException;
 import java.rmi.RemoteException;
 import java.rmi.server.UnicastRemoteObject;
@@ -16,6 +15,7 @@
 import java.sql.Connection;
 import java.sql.PreparedStatement;
 import java.sql.SQLException;
+import java.util.Date;
 import java.util.Hashtable;
 import java.util.List;
 
@@ -59,7 +59,8 @@
  *  
  *  TODO: Nezapominat generovat stub! (rmic net.sf.plantlore.server.HibernateDBLayer)
  *
- *  @author Tomas Kovarik (database parts), Erik Kratochvil (rmi parts)
+ *  @author Tomas Kovarik (database parts), 
+ *  @author Erik Kratochv&#237;l (RMI parts, some code purification)
  *  @version far from ready!
  */
 public class HibernateDBLayer implements DBLayer, Unreferenced {
@@ -114,7 +115,7 @@
      */
     public HibernateDBLayer(Undertaker undertaker, DatabaseSettings settings) {
         logger = Logger.getLogger(this.getClass().getPackage().getName());
-        logger.debug(&quot;      Constructing a new HibernateDBLayer ...&quot;);
+        logger.debug(&quot;Constructing a new HibernateDBLayer.&quot;);
         
         this.settings = settings;
         
@@ -128,8 +129,6 @@
         sessions = new Hashtable&lt;SelectQuery, Session&gt;(INITIAL_POOL_SIZE);
         
         this.undertaker = undertaker;
-       
-        logger.debug(&quot;      completed.&quot;);
     }
     
     /**
@@ -225,85 +224,132 @@
         retValue[0] = this.plantloreUser;
         retValue[1] = this.rights;
         return retValue;
-    }    
+    }
     
-    /**
-     *  Insert data into the database.
-     *
-     *  @param data data to insert (one of the data holder objects)
-     *  @return identifier (primary key) of the inserted row
-     *  @throws DBLayerException when saving data into the database fails
-     */
-    public int executeInsert(Object data) throws DBLayerException, RemoteException {
-        int recordId, id, result = 0;
-        String table;
-        HistoryColumn column;
-        
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setCreatedWhen(new java.util.Date());
-            occ.setUpdatedWhen(new java.util.Date());
+    
+    protected void completeRecord(Object record) {
+    	java.util.Date now = new Date();
+        if(record instanceof Occurrence) {
+            Occurrence occ = (Occurrence)record;
+            occ.setCreatedWhen(now);
+            occ.setUpdatedWhen(now);
             occ.setCreatedWho(this.plantloreUser);
             occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }
-        if (data instanceof Habitat) {
-            Habitat hab = (Habitat)data;
+            record = occ;
+        } else if(record instanceof Habitat) {
+            Habitat hab = (Habitat)record;
             hab.setCreatedWho(this.plantloreUser);
-            data = hab;
-        }
-        if (data instanceof Publication) {
-            Publication pub = (Publication)data;
+            record = hab;
+        } else if(record instanceof Publication) {
+            Publication pub = (Publication)record;
             pub.setCreatedWho(this.plantloreUser);
-            data = pub;
-        }
-        if (data instanceof Author) {
-            Author aut = (Author)data;
+            record = pub;
+        } else if(record instanceof Author) {
+            Author aut = (Author)record;
             aut.setCreatedWho(this.plantloreUser);
-            data = aut;
+            record = aut;
+        } else if(record instanceof Metadata) {
+        	Metadata met = (Metadata)record;
+        	met.setDateCreate(now);
+        	met.setDateModified(now);
+        	record = met;
         }
-        // Check whether we have sufficient rights
-        checkRights(data, INSERT);
+    }
+    
+    protected void checkConnection()
+    throws DBLayerException {
+    	if (sessionFactory == null) {
+            logger.warn(&quot;SessionFactory not available. Not connected to the database. Must call initialize() prior to any other method!&quot;);
+            throw new DBLayerException(&quot;Exception.NotConnected&quot;, DBLayerException.ERROR_CONNECT, null);
+        }
+    }
+    
+    
+    
+    protected int lowLevelOperation(int operation, Object data, boolean saveHistory, boolean useOwnTransaction) 
+    throws DBLayerException, RemoteException {
+    	 // Check whether the connection to the databse has been established/
+        checkConnection();
+        
+        // Fill in missing parts that DBLayer must complete.
+        completeRecord(data);
+        
+        // Check whether we have sufficient rights.
+        checkRights(data, operation);
+
+        // Perform the Operation.
+        Transaction tx = null;
         Session session = sessionFactory.openSession();
-        Transaction tx = null; 
-        recordId = 0;
+        int recordId = -1;
         try {
-            // Begin transaction
-            tx = session.beginTransaction();            
-            // Save item into the database
-            recordId = (Integer)session.save(data);            
-            // Save data to history tables - only for selected tables
-            saveHistory(session, data, INSERT, recordId);
-            // Commit transaction
-            tx.commit();  
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
+        	
+            // Begin transaction.
+        	if(useOwnTransaction) tx = session.beginTransaction();
+        	
+            // Make changes in the database.
+        	switch(operation) {
+        	case INSERT:
+                recordId = (Integer)session.save(data);            
+                if(saveHistory) saveHistory(session, data, INSERT, recordId);
+                break;
+        	case UPDATE:
+        	case DELETE:
+                 session.update(data);
+                 if(saveHistory) saveHistory(session, data, operation, null);
+        		break;
+        	default:
+        		throw new IllegalArgumentException(L10n.getString(&quot;Error.ImproperUse&quot;));
+        	}
+
+            // Commit transaction.
+            if(useOwnTransaction) tx.commit();
+            
+        } 
+        catch (StaleObjectStateException e) {
+            if (tx != null) tx.rollback();
+            logger.warn(&quot;StaleObjectStateException caught (Concurrent transactions running and trying to commit). Details: &quot;+e.getMessage());
+            throw new DBLayerException(&quot;Error.ConcurrentUpdate&quot;, DBLayerException.ERROR_TRANSACTION, e);
+        } 
+        catch (JDBCException e) {
+            if (tx != null) tx.rollback();
             logger.fatal(&quot;JDBC Exception caught while saving the record into the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.SaveRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
+            throw new DBLayerException(L10n.getString(&quot;Error.DatabaseOperationFailed&quot;), e);
+        } 
+        catch (HibernateException e) {
+            if (tx != null) tx.rollback();
             logger.fatal(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.SaveRecord&quot;);
-            ex.setError(ex.ERROR_SAVE, e.getMessage());
-            throw ex;  
+            int exceptionType = -1;
+            switch(operation) {
+            case INSERT:
+            	exceptionType = DBLayerException.ERROR_SAVE;
+            	break;
+            case UPDATE:
+            	exceptionType = DBLayerException.ERROR_UPDATE;
+            	break;
+            case DELETE:
+            	exceptionType = DBLayerException.ERROR_DELETE;
+            	break;
+            }
+            throw new DBLayerException(L10n.getString(&quot;Error.DatabaseOperationFailed&quot;), exceptionType, e);
         } finally {
             session.close();
         }
+        
         return recordId;
     }
+    
+    
+    /**
+     *  Insert data into the database.
+     *
+     *  @param data data to insert (one of the data holder objects)
+     *  @return identifier (primary key) of the inserted row
+     *  @throws DBLayerException when saving data into the database fails
+     */
+    public int executeInsert(Object data) 
+    throws DBLayerException, RemoteException {
+       return lowLevelOperation(INSERT, data, true, true);
+    }
 
     /**
      *  Insert data into the database without modifying history tables
@@ -312,70 +358,9 @@
      *  @return identifier (primary key) of the inserted row
      *  @throws DBLayerException when saving data into the database fails
      */
-    public int executeInsertHistory(Object data) throws DBLayerException, RemoteException {
-        int recordId;        
-
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setCreatedWhen(new java.util.Date());
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setCreatedWho(this.plantloreUser);
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }
-        if (data instanceof Habitat) {
-            Habitat hab = (Habitat)data;
-            hab.setCreatedWho(this.plantloreUser);
-            data = hab;
-        }
-        if (data instanceof Publication) {
-            Publication pub = (Publication)data;
-            pub.setCreatedWho(this.plantloreUser);
-            data = pub;
-        }
-        if (data instanceof Author) {
-            Author aut = (Author)data;
-            aut.setCreatedWho(this.plantloreUser);
-            data = aut;
-        }
-        // Check whether we have sufficient rights
-        checkRights(data, INSERT);        
-        Session session = sessionFactory.openSession();
-        Transaction tx = null;        
-        try {
-            // Begin transaction
-            tx = session.beginTransaction();            
-            // Save item into the database
-            recordId = (Integer)session.save(data);
-            // Commit transaction
-            tx.commit();  
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;JDBC Exception caught while saving the record into the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.SaveRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;            
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;Saving record into the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.SaveRecord&quot;);
-            ex.setError(ex.ERROR_SAVE, e.getMessage());
-            throw ex;            
-        } finally {
-            session.close();
-        }
-        return recordId;
+    public int executeInsertHistory(Object data) 
+    throws DBLayerException, RemoteException {
+      return lowLevelOperation(INSERT, data, false, true);  
     }
     
     /**
@@ -384,45 +369,9 @@
      *  @param data data we want to delete (must be one of the holder objects)
      *  @throws DBLayerException when deleting data fails
      */
-    public void executeDelete(Object data) throws DBLayerException, RemoteException {
-        String table;
-        int id, result = 0;
-        HistoryColumn column;        
-
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        Session session = sessionFactory.openSession();        
-        Transaction tx = null;
-        try {
-            tx = session.beginTransaction();
-            // Update the item in the database
-            session.update(data);
-            // Commit transaction
-            tx.commit();    
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;JDBC Exception caught while deleting the record from the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.DeleteRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;            
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.DeleteRecord&quot;);
-            ex.setError(ex.ERROR_DELETE, e.getMessage());
-            throw ex;            
-        } finally {
-            session.close();
-        }
+    public void executeDelete(Object data) 
+    throws DBLayerException, RemoteException {
+        lowLevelOperation(DELETE, data, true, true);
     }
 
     /**
@@ -431,41 +380,9 @@
      *  @param data data we want to delete (must be one of the holder objects)
      *  @throws DBLayerException when deleting data fails
      */
-    public void executeDeleteHistory(Object data) throws DBLayerException, RemoteException {
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        Session session = sessionFactory.openSession();        
-        Transaction tx = null;
-        try {
-            tx = session.beginTransaction();
-            // Save item into the database
-            session.delete(data);
-            // Commit transaction
-            tx.commit();                
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;JDBC Exception caught while deleting the record from the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.DeleteRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;                        
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;Deleting record from the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.DeleteRecord&quot;);
-            ex.setError(ex.ERROR_DELETE, e.getMessage());
-            throw ex;
-        } finally {
-            session.close();
-        }
+    public void executeDeleteHistory(Object data) 
+    throws DBLayerException, RemoteException {
+    	lowLevelOperation(DELETE, data, false, true);
     }
     
     /**
@@ -474,62 +391,9 @@
      *  @param data to update (must be one of the holder objects)
      *  @throws DBLayerException when updating data fails
      */
-    public void executeUpdate(Object data) throws DBLayerException, RemoteException {
-        int id;
-        
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }
-        // Check whether we have sufficient rights
-        checkRights(data, UPDATE);        
-        Session session = sessionFactory.openSession();
-        Transaction tx = null;        
-        try {
-            tx = session.beginTransaction();            
-            // Save records into the history
-            saveHistory(session, data, UPDATE, null);            
-            // Save item into the database
-            session.update(data);
-            // Commit transaction
-            tx.commit();  
-        } catch (StaleObjectStateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.warn(&quot;StaleObjectStateException caught (Concurrent transactions running and trying to commit). Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.ConcurrentUpdate&quot;);
-            ex.setError(ex.ERROR_TRANSACTION, e.getMessage());
-            throw ex;                        
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;JDBC Exception caught while updating the record in the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;                                    
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);
-            ex.setError(ex.ERROR_UPDATE, e.getMessage());
-            throw ex;            
-        } finally {
-            session.close();
-        }
+    public void executeUpdate(Object data) 
+    throws DBLayerException, RemoteException {
+    	lowLevelOperation(UPDATE, data, true, true);
     }
 
     /**
@@ -538,58 +402,9 @@
      *  @param data to update (must be one of the holder objects)
      *  @throws DBLayerException when updating data fails
      */
-    public void executeUpdateHistory(Object data) throws DBLayerException, RemoteException {
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }        
-        // Check whether we have sufficient rights
-        checkRights(data, UPDATE);                
-        Session session = sessionFactory.openSession();
-        Transaction tx = null;
-        try {
-            tx = session.beginTransaction();
-            // Save item into the database
-            session.update(data);
-            // Commit transaction
-            tx.commit();  
-        } catch (StaleObjectStateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.warn(&quot;StaleObjectStateException caught (Concurrent transactions running and trying to commit). Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.ConcurrentUpdate&quot;);
-            ex.setError(ex.ERROR_TRANSACTION, e.getMessage());
-            throw ex;                        
-        } catch (JDBCException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;JDBC Exception caught while updating the record in the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;                        
-        } catch (HibernateException e) {
-            if (tx != null) {
-                tx.rollback();
-            }
-            logger.fatal(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);            
-            ex.setError(ex.ERROR_UPDATE, e.getMessage());
-            throw ex;
-        } finally {
-            session.close();
-        }
+    public void executeUpdateHistory(Object data) 
+    throws DBLayerException, RemoteException {
+    	lowLevelOperation(UPDATE, data, false, true);
     }
     
     /**
@@ -603,49 +418,9 @@
      *                           while executing the update
      *  @throws RemoteException in case network connection failed
      */
-    public void executeUpdateInTransactionHistory(Object data) throws DBLayerException, RemoteException {
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }        
-        // Check whether we have rights for this operation
-        checkRights(data, UPDATE);        
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }        
-        try {
-            // Save item into the database
-            txSession.update(data);        
-        } catch (StaleObjectStateException e) {
-            logger.warn(&quot;StaleObjectStateException caught (Concurrent transactions running and trying to commit). Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.ConcurrentUpdate&quot;);
-            ex.setError(ex.ERROR_TRANSACTION, e.getMessage());
-            throw ex;                        
-        } catch (JDBCException e) {
-            logger.fatal(&quot;JDBC Exception caught while updating the record in the database. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());
-            throw ex;                        
-        } catch (HibernateException e) {
-            logger.fatal(&quot;Updating record in the database failed. Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.UpdateRecord&quot;);
-            ex.setError(ex.ERROR_UPDATE, e.getMessage());
-            throw ex;
-        }
+    public void executeUpdateInTransactionHistory(Object data) 
+    throws DBLayerException, RemoteException {
+       lowLevelOperation(UPDATE, data, false, false);
     }
     
     /**
@@ -1146,73 +921,9 @@
      *                           while executing the insert
      *  @throws RemoteException in case server connection failed
      */    
-    public int executeInsertInTransaction(Object data) throws DBLayerException, RemoteException {
-        int recordId = 0;
-        
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;Exception.NotConnected&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setCreatedWhen(new java.util.Date());
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setCreatedWho(this.plantloreUser);
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }
-        if (data instanceof Habitat) {
-            Habitat hab = (Habitat)data;
-            hab.setCreatedWho(this.plantloreUser);
-            data = hab;
-        }
-        if (data instanceof Publication) {
-            Publication pub = (Publication)data;
-            pub.setCreatedWho(this.plantloreUser);
-            data = pub;
-        }
-        if (data instanceof Author) {
-            Author aut = (Author)data;
-            aut.setCreatedWho(this.plantloreUser);
-            data = aut;
-        }
-        if( data instanceof Metadata) {
-        	Metadata met = (Metadata)data;
-        	met.setDateCreate(new java.util.Date());
-        	met.setDateModified(new java.util.Date());
-        	data = met;
-        }
-        // Check whether we have rights for this operation
-        checkRights(data, INSERT);
-        
-        try {
-            // Save item into the database
-            recordId = (Integer)this.txSession.save(data);            
-       } catch (JDBCException e) {
-            logger.fatal(&quot;JDBC Exception caught while rollbacking database transaction. SQL State: &quot;+e.getSQLState()+&quot;; Details: &quot;+e.getMessage());
-            DBLayerException ex = new DBLayerException(&quot;Exception.RollbackTransaction&quot;);
-            ex.setError(ex.translateSQLState(e.getSQLState()), e.getMessage());                        
-        } catch (HibernateException e) {
-        	e.printStackTrace();
-        	/*-------------------------------------------------------------------------------------
-        	 * FIXME:
-        	 * 
-        	 * THIS NEEDS A SERIOUS UPDATE! 
-        	 * If txSession.save() fails, it certainly does not mean there are problems with rollback!
-        	 * Or does it?!
-        	 *-------------------------------------------------------------------------------------*/
-            logger.fatal(&quot;Cannot rollback database transaction&quot;); 
-            DBLayerException ex = new DBLayerException(&quot;Exception.RollbackTransaction&quot;);
-            ex.setError(ex.ERROR_TRANSACTION, e.getMessage());
-            throw ex;            
-        }            
-        // Save data to history tables - only for selected tables
-        saveHistory(txSession, data, INSERT, recordId);
-        // Return new record identifier
-        return recordId;        
+    public int executeInsertInTransaction(Object data) 
+    throws DBLayerException, RemoteException {
+    	return lowLevelOperation(INSERT, data, true, false);
     }
 
     /**
@@ -1227,52 +938,9 @@
      *                           while executing the insert
      *  @throws RemoteException in case server connection failed
      */    
-    public int executeInsertInTransactionHistory(Object data) throws DBLayerException, RemoteException {
-        int recordId;
-        
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setCreatedWhen(new java.util.Date());
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setCreatedWho(this.plantloreUser);
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }
-        if (data instanceof Habitat) {
-            Habitat hab = (Habitat)data;
-            hab.setCreatedWho(this.plantloreUser);
-            data = hab;
-        }
-        if (data instanceof Publication) {
-            Publication pub = (Publication)data;
-            pub.setCreatedWho(this.plantloreUser);
-            data = pub;
-        }
-        if (data instanceof Author) {
-            Author aut = (Author)data;
-            aut.setCreatedWho(this.plantloreUser);
-            data = aut;
-        }        
-        if( data instanceof Metadata) {
-        	Metadata met = (Metadata)data;
-        	met.setDateCreate(new java.util.Date());
-        	met.setDateModified(new java.util.Date());
-        	data = met;
-        }
-        // Check whether we have rights for this operation
-        checkRights(data, INSERT);
-
-        // Save item into the database
-        recordId = (Integer)this.txSession.save(data);            
-        // Return new record identifier
-        return recordId;        
+    public int executeInsertInTransactionHistory(Object data) 
+    throws DBLayerException, RemoteException {
+    	return lowLevelOperation(INSERT, data, false, false);
     }    
     
     /**
@@ -1287,33 +955,7 @@
      *  @throws RemoteException in case network connection failed
      */
     public void executeUpdateInTransaction(Object data) throws DBLayerException, RemoteException {
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }        
-        // Check whether we have rights for this operation
-        checkRights(data, UPDATE);        
-        // Modify the input data - UPDATEWHEN and UPDATEWHO where applicable
-        if (data instanceof Occurrence) {
-            Occurrence occ = (Occurrence)data;
-            occ.setUpdatedWhen(new java.util.Date());
-            occ.setUpdatedWho(this.plantloreUser);
-            data = occ;
-        }        
-        // Save history record for this change
-        saveHistory(txSession, data, UPDATE, null);
-        // Save item into the database
-        txSession.update(data);
+    	lowLevelOperation(UPDATE, data, true, false);
     }
     
     /**
@@ -1328,19 +970,7 @@
      *  @throws RemoteException in case network connection failed
      */
     public void executeDeleteInTransaction(Object data) throws DBLayerException, RemoteException {
-        // Check whether we are connected to the database
-        if (sessionFactory == null) {
-            logger.warn(&quot;SessionFactory not avilable. Not connected to the database.&quot;);
-            DBLayerException ex = new DBLayerException(&quot;SessionFactory not available. Not connected to the database.&quot;);
-            ex.setError(ex.ERROR_CONNECT, null);
-            throw ex;
-        }
-        // Check whether we have rights for this operation
-        checkRights(data, DELETE);
-        // Save history record for this change
-        saveHistory(txSession, data, DELETE, null);
-        // Save item into the database
-        txSession.delete(data);
+    	lowLevelOperation(DELETE, data, true, false);
     }    
     
     private void checkRights(Object data, int type) throws DBLayerException {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000745.html">[Plantlore-dev] r543 - trunk/src/net/sf/plantlore/server
</A></li>
	<LI>Next message: <A HREF="000747.html">[Plantlore-dev] r545 - in trunk/src/net/sf/plantlore/common: .	exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#746">[ date ]</a>
              <a href="thread.html#746">[ thread ]</a>
              <a href="subject.html#746">[ subject ]</a>
              <a href="author.html#746">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plantlore-dev">More information about the Plantlore-dev
mailing list</a><br>
</body></html>
